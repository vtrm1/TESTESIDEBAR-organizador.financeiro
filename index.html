<!DOCTYPE html>
<html lang="pt-BR" class="light"> <!-- Classe inicial 'light' - JS alterna para 'dark' -->
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Organizador Financeiro ‚Äî Completo</title>

<!-- Tailwind + icons -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Config Tailwind para Dark Mode -->
<script>
  tailwind.config = {
    darkMode: 'class', // Usa classe 'dark' no <html> para alternar
  }
</script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

<!-- Manifest PWA -->
<link rel="manifest" href="manifest.json" />
<!-- Theme-color para Light e Dark Mode -->
<meta name="theme-color" content="#4ade80" media="(prefers-color-scheme: light)" />
<meta name="theme-color" content="#1f2937" media="(prefers-color-scheme: dark)" />

<!-- Adicione no <head> para incluir Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- NOVO: Modal de Gr√°ficos Interativos com filtros -->
<div id="modal-graficos" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-11/12 max-w-3xl mx-auto relative shadow-lg modal-content max-h-[90vh] overflow-y-auto">
    <button id="modal-graficos-close" class="absolute top-3 right-3 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-2xl font-bold" aria-label="Fechar modal">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Gr√°ficos Interativos</h2>

    <!-- NOVO: Resumo de Totais no Modal -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-4 bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
      <div>
        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-1">Total de Gastos Filtrados</h4>
        <div class="text-xl font-bold text-blue-600 dark:text-blue-400" id="graficos-total-filtrado">R$ 0,00</div>
      </div>
      <div>
        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-1">M√©dia Mensal (Per√≠odo)</h4>
        <div class="text-xl font-bold text-blue-600 dark:text-blue-400" id="graficos-media-mensal">R$ 0,00</div>
      </div>
      <div>
        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-1">Transa√ß√µes analisadas</h4>
        <div class="text-xl font-bold text-blue-600 dark:text-blue-400" id="graficos-total-transacoes">0</div>
      </div>
      <div>
        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-1">Ticket m√©dio</h4>
        <div class="text-xl font-bold text-blue-600 dark:text-blue-400" id="graficos-ticket-medio">R$ 0,00</div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-sm">
      <div class="p-3 rounded-lg bg-white dark:bg-gray-700/60 border border-blue-100 dark:border-blue-900/40">
        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-1">Categoria que mais pesa</h4>
        <p class="text-gray-600 dark:text-gray-300" id="graficos-top-categoria">Nenhuma categoria filtrada.</p>
      </div>
      <div class="p-3 rounded-lg bg-white dark:bg-gray-700/60 border border-blue-100 dark:border-blue-900/40">
        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-1">Cart√£o/PIX com maior gasto</h4>
        <p class="text-gray-600 dark:text-gray-300" id="graficos-top-cartao">Nenhum cart√£o filtrado.</p>
      </div>
    </div>

    <div class="mb-6">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold text-gray-800 dark:text-gray-100">Resumo mensal do hist√≥rico</h3>
        <span class="text-xs text-gray-500 dark:text-gray-400">√öltimos meses considerados pelo filtro</span>
      </div>
      <div class="relative h-56">
        <canvas id="grafico-historico-mensal" class="w-full h-full"></canvas>
        <div id="historico-mensal-empty" class="absolute inset-0 flex items-center justify-center text-xs text-gray-500 dark:text-gray-400">Selecione um per√≠odo com gastos para visualizar o resumo.</div>
      </div>
    </div>

    <div class="mb-4">
      <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Filtrar por Cart√µes</h3>
      <div id="filtro-cartoes-container" class="flex flex-wrap gap-3">
        <!-- Checkboxes ser√£o inseridos via JS -->
      </div>
    </div>

    <div class="mb-4">
      <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Filtrar por Categorias</h3>
      <div id="filtro-categorias-container" class="flex flex-wrap gap-3">
        <!-- Checkboxes ser√£o inseridos via JS -->
      </div>
    </div>

    <!-- NOVO: Filtro por Per√≠odo -->
    <div class="mb-4">
      <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Filtrar por Per√≠odo</h3>
      <div class="flex flex-wrap gap-3 items-center">
        <select id="filtro-periodo-graficos" class="px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
          <option value="current_month">M√™s Atual</option>
          <option value="last_3_months">√öltimos 3 Meses</option>
          <option value="last_6_months">√öltimos 6 Meses</option>
          <option value="current_year">Ano Atual</option>
          <option value="custom">Personalizado</option>
        </select>
        <input type="month" id="filtro-periodo-start" class="px-3 py-2 border rounded-lg hidden bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
        <input type="month" id="filtro-periodo-end" class="px-3 py-2 border rounded-lg hidden bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
      </div>
    </div>

    <div class="flex gap-4 mb-4">
      <button id="btn-aplicar-filtros" class="bg-blue-600 dark:bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-700 dark:hover:bg-blue-800 transition">Aplicar Filtros</button>
      <button id="btn-limpar-filtros" class="bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-100 px-4 py-2 rounded hover:bg-gray-400 dark:hover:bg-gray-700 transition">Limpar Filtros</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Gastos por Categoria</h3>
        <canvas id="grafico-categorias" width="400" height="300"></canvas>
      </div>
      <div>
        <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Gastos por Cart√£o</h3>
        <canvas id="grafico-cartoes" width="400" height="300"></canvas>
      </div>
      <!-- MELHORADO: Canvas para gr√°fico de tend√™ncia com controles -->
      <div class="md:col-span-2">
        <div class="flex justify-between items-center mb-3">
          <h3 class="font-semibold text-gray-800 dark:text-gray-100">üìà Tend√™ncia de Gastos por Categoria</h3>
          <div class="flex gap-2">
            <select id="tendencia-tipo-grafico" class="px-2 py-1 border rounded text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
              <option value="line">Linha</option>
              <option value="bar">Barras</option>
              <option value="area">√Årea</option>
            </select>
            <button id="btn-toggle-todas-categorias" class="px-2 py-1 bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-200 rounded text-sm hover:bg-blue-200 dark:hover:bg-blue-900/40">
              Mostrar Todas
            </button>
          </div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg mb-3">
          <div class="text-xs text-gray-600 dark:text-gray-400 mb-2">üí° Dica: Clique nas categorias da legenda para mostrar/ocultar</div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-gray-800 dark:text-gray-100">
            <div>üìä <strong>Total per√≠odo:</strong> <span id="tendencia-total">R$ 0,00</span></div>
            <div>üìà <strong>Maior m√™s:</strong> <span id="tendencia-maior-mes">-</span></div>
            <div>üìâ <strong>Menor m√™s:</strong> <span id="tendencia-menor-mes">-</span></div>
            <div>üéØ <strong>M√©dia:</strong> <span id="tendencia-media">R$ 0,00</span></div>
          </div>
        </div>
        <div class="relative">
          <canvas id="grafico-tendencia-categorias" width="800" height="400"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NOVO: Modal de Gr√°ficos dos Fixos -->
<div id="modal-graficos-fixos" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-11/12 max-w-2xl mx-auto relative shadow-lg modal-content max-h-[90vh] overflow-y-auto">
    <button id="modal-graficos-fixos-close" class="absolute top-3 right-3 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-2xl font-bold" aria-label="Fechar modal">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">An√°lise dos Gastos Fixos</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Total Fixos Ativos</h4>
        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="total-fixos-ativos">R$ 0,00</div>
      </div>
      <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
        <h4 class="font-semibold text-gray-800 dark:text-gray-100 mb-2">Total Fixos Inativos</h4>
        <div class="text-2xl font-bold text-gray-600 dark:text-gray-400" id="total-fixos-inativos">R$ 0,00</div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Distribui√ß√£o por Categoria</h3>
        <canvas id="grafico-fixos-categoria" width="400" height="300"></canvas>
      </div>
      <div>
        <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Impacto no Or√ßamento</h3>
        <canvas id="grafico-fixos-impacto" width="400" height="300"></canvas>
      </div>
    </div>

    <div class="mt-6">
      <h3 class="font-semibold mb-3 text-gray-800 dark:text-gray-100">Detalhamento por Item</h3>
      <div id="detalhes-fixos" class="space-y-2">
        <!-- Detalhes ser√£o inseridos via JS -->
      </div>
    </div>
  </div>
</div>

<!-- NOVO: Modal de planejamento das metas dos envelopes -->
<div id="modal-planejamento-envelopes" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-11/12 max-w-xl mx-auto relative shadow-2xl modal-content space-y-5">
    <button id="modal-planejamento-envelopes-close" class="absolute top-3 right-3 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-2xl font-bold" aria-label="Fechar modal">&times;</button>
    <div>
      <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 flex items-center gap-2">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-emerald-100 text-emerald-600 dark:bg-emerald-900/50 dark:text-emerald-300">
          <i class="fa fa-bullseye"></i>
        </span>
        Planejar margem do m√™s
      </h2>
      <p class="text-sm text-slate-600 dark:text-slate-300 mt-1">Visualize suas metas, quanto j√° foi reservado e direcione a folga restante para onde fizer mais sentido.</p>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
      <div class="rounded-xl border border-emerald-100 dark:border-emerald-800/50 bg-emerald-50/60 dark:bg-emerald-900/20 p-3">
        <span class="text-[0.65rem] uppercase tracking-wide text-emerald-600 dark:text-emerald-300">Meta total</span>
        <div class="text-lg font-semibold text-emerald-800 dark:text-emerald-100">R$ <span id="overview-modal-meta">0,00</span></div>
      </div>
      <div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-800/40 p-3">
        <span class="text-[0.65rem] uppercase tracking-wide text-slate-500 dark:text-slate-300">Gasto no m√™s</span>
        <div class="text-lg font-semibold text-slate-800 dark:text-slate-100">R$ <span id="overview-modal-gasto">0,00</span></div>
      </div>
      <div class="rounded-xl border border-sky-200 dark:border-sky-800/50 bg-sky-50/70 dark:bg-sky-900/20 p-3">
        <span class="text-[0.65rem] uppercase tracking-wide text-sky-600 dark:text-sky-300">Reservado para metas</span>
        <div class="text-lg font-semibold text-sky-700 dark:text-sky-200">R$ <span id="overview-modal-reservado">0,00</span></div>
      </div>
      <div class="rounded-xl border border-amber-200 dark:border-amber-800/60 bg-amber-50/70 dark:bg-amber-900/20 p-3">
        <span class="text-[0.65rem] uppercase tracking-wide text-amber-600 dark:text-amber-300">Folga direcion√°vel</span>
        <div class="text-lg font-semibold text-amber-700 dark:text-amber-200">R$ <span id="overview-modal-margem">0,00</span></div>
      </div>
    </div>
    <div class="space-y-3 text-sm">
      <div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/40 p-3">
        <p class="text-slate-600 dark:text-slate-300">A folga representa o que sobrou ap√≥s gastos e reservas planejadas. Escolha uma a√ß√£o r√°pida para n√£o deixar esse valor parado.</p>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
        <button id="btn-planejamento-reservar" type="button" class="flex flex-col gap-1 rounded-xl border border-emerald-200 dark:border-emerald-800/60 bg-emerald-600 text-white px-3 py-3 text-left shadow hover:bg-emerald-700 dark:hover:bg-emerald-700 transition">
          <span class="text-xs uppercase tracking-wide">Ajustar metas</span>
          <span class="text-sm font-semibold">Reservar nos envelopes</span>
          <span class="text-[0.7rem] opacity-80">Distribui automaticamente a folga</span>
        </button>
        <button id="btn-planejamento-investir" type="button" class="flex flex-col gap-1 rounded-xl border border-sky-200 dark:border-sky-800/60 bg-sky-600 text-white px-3 py-3 text-left shadow hover:bg-sky-700 dark:hover:bg-sky-700 transition">
          <span class="text-xs uppercase tracking-wide">Fazer render</span>
          <span class="text-sm font-semibold">Enviar para investimentos</span>
          <span class="text-[0.7rem] opacity-80">Leva voc√™ ao painel de investimentos</span>
        </button>
        <button id="btn-planejamento-entrada" type="button" class="flex flex-col gap-1 rounded-xl border border-amber-200 dark:border-amber-700/60 bg-amber-500 text-white px-3 py-3 text-left shadow hover:bg-amber-600 dark:hover:bg-amber-600 transition">
          <span class="text-xs uppercase tracking-wide">Guardar</span>
          <span class="text-sm font-semibold">Adicionar como entrada extra</span>
          <span class="text-[0.7rem] opacity-80">Registra como aporte ou reserva</span>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .progress-bar{transition:width .4s ease}
  .badge-alert{color:#b91c1c;font-weight:700;margin-left:.4rem}
  .section-card{background:white;border-radius:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.06);padding:1rem}
  .resumo-slider{position:relative;overflow:hidden;touch-action:pan-y}
  .resumo-slider-track{display:flex;gap:0;transition:transform .4s ease}
  .resumo-slide{flex:0 0 100%;min-width:100%}
  .resumo-slider-nav{display:flex;align-items:center;gap:.5rem;margin-bottom:1rem}
  .resumo-slider-dot{padding:.4rem .9rem;border-radius:9999px;background:#f3f4f6;color:#4b5563;font-weight:600;font-size:.85rem;transition:all .25s ease}
  .resumo-slider-dot.is-active{background:#2563eb;color:white;box-shadow:0 8px 16px rgba(37,99,235,.25)}
  .dark .resumo-slider-dot{background:rgba(148,163,184,0.18);color:#e2e8f0;border:1px solid rgba(148,163,184,0.2)}
  .dark .resumo-slider-dot.is-active{background:linear-gradient(135deg,#2563eb,#7c3aed);color:#ffffff;box-shadow:0 12px 32px rgba(124,58,237,0.35);border-color:transparent}
  .resumo-slide-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:1rem}
  .resumo-slide-grid .resumo-item{padding:.75rem;border-radius:.75rem;background:#f9fafb;display:flex;flex-direction:column;gap:.35rem}
  .resumo-item .label{font-size:.8rem;color:#6b7280;text-transform:uppercase;letter-spacing:.05em}
  .resumo-item .value{font-size:1.5rem;font-weight:700;color:#111827}
  .resumo-item .hint{font-size:.75rem;color:#9ca3af}
  .resumo-item.positivo{background:rgba(16,185,129,.1);color:#047857}
  .resumo-item.positivo .value{color:#047857}
  .resumo-item.alerta{background:rgba(248,113,113,.12);color:#b91c1c}
  .resumo-item.alerta .value{color:#b91c1c}
  .resumo-item.neutro{background:rgba(59,130,246,.08);color:#1d4ed8}
  .resumo-item.neutro .value{color:#1d4ed8}
  .dark .resumo-slide-grid .resumo-item {
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.88));
    border: 1px solid rgba(148, 163, 184, 0.2);
    color: #e2e8f0;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.55);
  }
  .dark .resumo-item .value {
    color: #f8fafc;
  }
  .dark .resumo-item .label {
    color: #cbd5f5;
  }
  .dark .resumo-item .hint {
    color: #94a3b8;
  }
  .dark .resumo-item.positivo {
    background: linear-gradient(150deg, rgba(16, 185, 129, 0.35), rgba(5, 150, 105, 0.4));
    border-color: rgba(45, 212, 191, 0.4);
    color: #d1fae5;
  }
  .dark .resumo-item.positivo .value {
    color: #6ee7b7;
  }
  .dark .resumo-item.alerta {
    background: linear-gradient(150deg, rgba(248, 113, 113, 0.35), rgba(185, 28, 28, 0.45));
    border-color: rgba(248, 150, 150, 0.4);
    color: #fee2e2;
  }
  .dark .resumo-item.alerta .value {
    color: #fca5a5;
  }
  .dark .resumo-item.neutro {
    background: linear-gradient(150deg, rgba(59, 130, 246, 0.35), rgba(49, 46, 129, 0.5));
    border-color: rgba(147, 197, 253, 0.35);
    color: #dbeafe;
  }
  .dark .resumo-item.neutro .value {
    color: #bfdbfe;
  }
  .resumo-slider-dots{display:flex;gap:.4rem}
  .resumo-slider-dots button{width:.5rem;height:.5rem;border-radius:9999px;background:#e5e7eb;border:none;padding:0;transition:transform .25s ease,background .25s ease}
  .resumo-slider-dots button.is-active{background:#2563eb;transform:scale(1.1)}
  .gradient-shadow{position:relative}
  .gradient-shadow::after{content:"";position:absolute;inset:0;border-radius:.75rem;pointer-events:none;box-shadow:0 10px 35px rgba(15,23,42,.1)}
  .dark .gradient-shadow{background:linear-gradient(160deg,rgba(30,41,59,0.95),rgba(17,24,39,0.92));border:1px solid rgba(148,163,184,0.2);box-shadow:0 20px 45px rgba(15,23,42,0.6)}
  .compact-resumo{padding:1rem 1.2rem 1.25rem}
  .compact-resumo .resumo-slider-nav{margin-bottom:.75rem}
  .compact-resumo .resumo-slide-grid{gap:.75rem}
  .compact-resumo .resumo-slide-grid .resumo-item{padding:.6rem}
  .compact-resumo .resumo-item .label{font-size:.72rem}
  .compact-resumo .resumo-item .value{font-size:1.25rem}
  .compact-resumo .resumo-item .hint{font-size:.68rem}
  @media (max-width:767px){
    .resumo-slide-grid{grid-template-columns:repeat(1,minmax(0,1fr))}
  }
  @media (min-width:1024px){
    .resumo-slide-grid{grid-template-columns:repeat(4,minmax(0,1fr))}
  }
  .th{font-weight:600;color:#374151;font-size:.85rem;text-align:left;padding:.5rem .75rem;border-bottom:1px solid #e5e7eb}
  .td{padding:.45rem .75rem;border-bottom:1px solid #f3f4f6;font-size:.95rem;vertical-align:middle}
  .pill{font-size:.75rem;border-radius:9999px;padding:.15rem .5rem;background:#f3f4f6}
   .danger-banner{background:#fee2e2;border:1px solid #fca5a5;color:#991b1b;padding:1rem;border-radius:.5rem;margin-bottom:1rem;border-left:4px solid #dc2626}
  
  /* Transi√ß√µes suaves para o bot√£o flutuante */
  body {
    padding-bottom: 4.5rem;
  }
  @media (min-width: 768px) {
    body {
      padding-bottom: 5.25rem;
    }
  }

  .floating-btn-transition {
    transition: transform 0.3s ease, opacity 0.3s ease, bottom 0.3s ease; /* Adicionado bottom */
  }

  #floating-menu {
    transition: transform 0.3s ease, opacity 0.3s ease;
  }

  #floating-menu nav {
    pointer-events: auto;
  }
  
  /* Melhorias visuais para o modal */
  .modal-content {
    animation: modalFadeIn 0.3s ease-out;
  }
  
  @keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* NOVO: Estilo para o hist√≥rico de vari√°veis com scroll */
  #historico-variavel-scroll-container {
    max-height: 400px; /* Ajuste a altura m√°xima conforme sua prefer√™ncia */
    overflow-y: auto;
    border: 1px solid #e5e7eb; /* Borda sutil */
    border-radius: .5rem;
    margin-top: 1rem;
  }
  /* Ajuste para a tabela dentro do container de scroll */
  #historico-variavel-scroll-container table {
    width: 100%; /* Garante que a tabela ocupe a largura total do container */
    border-collapse: collapse; /* Remove espa√ßamento entre as bordas das c√©lulas */
  }
  #historico-variavel-scroll-container .th,
  #historico-variavel-scroll-container .td {
    white-space: nowrap; /* Evita que o texto quebre em v√°rias linhas */
  }
  /* Estilo para o spinner de carregamento */
  .loading-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280; /* gray-500 */
    font-size: 0.9rem;
    padding: 1rem;
  }
  .loading-spinner i {
    margin-right: 0.5rem;
  }
  /* Classe espec√≠fica para ocultar spinners, para evitar conflito com o 'hidden' do Tailwind */
  .spinner-hidden {
    display: none !important;
  }

  /* NOVO: Estilo para o Toast de feedback */
  #toast-message {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    z-index: 1000;
    font-size: 0.9rem;
  
  }
  #toast-message.show {
    opacity: 1;
  }

  /* NOVO: Estilos para cards de fixos melhorados */
  .fixo-card {
    border-left: 4px solid;
    transition: all 0.3s ease;
  }
  .fixo-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .fixo-card.ativo {
    border-left-color: #10b981; /* green-500 */
  }
  .fixo-card.inativo {
    border-left-color: #6b7280; /* gray-500 */
    opacity: 0.7;
  }

  /* NOVO: Melhorias visuais para parcelados */
  .parcelado-status {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .parcelado-ativo {
    background-color: #dbeafe; /* blue-100 */
    color: #1e40af; /* blue-800 */
  }
  .parcelado-finalizado {
    background-color: #d1fae5; /* green-100 */
    color: #065f46; /* green-800 */
  }
  .parcelado-futuro {
    background-color: #f3f4f6; /* gray-100 */
    color: #374151; /* gray-700 */
  }

  /* Melhoria na barra de progresso dos parcelados */
  .progress-parcelado {
    height: 6px;
    background-color: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 4px;
  }
  .progress-parcelado-fill {
    height: 100%;
    transition: width 0.4s ease;
    border-radius: 3px;
  }
  .progress-ativo {
    background-color: #3b82f6; /* blue-500 */
  }
  .progress-finalizado {
    background-color: #10b981; /* green-500 */
  }

  #parcelados-table-wrapper {
    max-height: none;
    overflow-y: visible;
    transition: box-shadow 0.25s ease, border-color 0.25s ease, background 0.25s ease;
  }

  #parcelados-table-wrapper.parcelados-scroll {
    max-height: 32rem;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 0.75rem 0.5rem;
    background-color: #ffffff;
    box-shadow: inset 0 -10px 16px -14px rgba(15, 23, 42, 0.22);
  }

  #parcelados-table-wrapper.parcelados-scroll table {
    min-width: 44rem;
    width: 100%;
  }

  #parcelados-table-wrapper.parcelados-scroll::-webkit-scrollbar {
    width: 10px;
  }

  #parcelados-table-wrapper.parcelados-scroll::-webkit-scrollbar-track {
    background: transparent;
  }

  #parcelados-table-wrapper.parcelados-scroll::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.35);
    border-radius: 9999px;
  }

  #parcelados-table-wrapper.parcelados-scroll::-webkit-scrollbar-thumb:hover {
    background: rgba(100, 116, 139, 0.5);
  }

  /* NOVO: Estilos para sistema de tags */
.tag-pill {
  display: inline-block;
  background-color: #3b82f6;
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  margin: 0.125rem;
  cursor: pointer;
  transition: all 0.2s ease;
}
.tag-pill:hover {
  background-color: #2563eb;
  transform: scale(1.05);
}
.tag-pill.removable {
  padding-right: 1.5rem;
  position: relative;
}
.tag-pill .remove-tag {
  position: absolute;
  right: 0.25rem;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  font-weight: bold;
}
.tag-suggestion {
  padding: 0.5rem;
  cursor: pointer;
  border-bottom: 1px solid #e5e7eb;
  transition: background-color 0.2s ease;
}
.tag-suggestion:hover {
  background-color: #f3f4f6;
}
.tag-suggestion:last-child {
  border-bottom: none;
}
/* Dark mode para tag suggestions */
html.dark .tag-suggestion {
  border-bottom-color: #374151; /* dark:border-b-gray-600 */
}
html.dark .tag-suggestion:hover {
  background-color: #374151; /* dark:bg-gray-600 */
}

.mobile-tab-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.55rem 1rem;
  border-radius: 9999px;
  font-weight: 600;
  font-size: 0.85rem;
  border: 1px solid rgba(148, 163, 184, 0.45);
  color: #1f2937;
  background: rgba(255, 255, 255, 0.78);
  transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, color 0.2s ease;
  white-space: nowrap;
}

html.dark .mobile-tab-button {
  border-color: rgba(148, 163, 184, 0.35);
  background: rgba(15, 23, 42, 0.82);
  color: #e2e8f0;
}

.mobile-tab-button.active {
  background: linear-gradient(135deg, #2563eb, #4f46e5);
  color: #ffffff;
  border-color: transparent;
  box-shadow: 0 12px 22px rgba(37, 99, 235, 0.35);
  transform: translateY(-1px);
}

.mobile-tab-button:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35);
}

.no-scrollbar::-webkit-scrollbar {
  display: none;
}

.no-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

/* NOVO: Estilos para filtro de busca no hist√≥rico */
.search-highlight {
  background-color: #fef3c7;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
  }

  /* NOVO: Estilos para modo escuro (mantendo padr√£o original) */
  .dark {
    background-color: #1f2937;
    color: #f9fafb;
  }
  .dark .section-card {
    background-color: #374151;
    color: #f9fafb;
  }
  .dark .section-card.gradient-shadow {
    background-color: #374151;
    border: none;
    box-shadow: 0 1px 2px rgba(15, 23, 42, 0.45);
  }
  .dark .bg-white {
    background-color: #374151 !important;
  }
  .dark .text-gray-800 {
    color: #f9fafb !important;
  }
  .dark .text-gray-600 {
    color: #d1d5db !important;
  }
  .dark .text-gray-500 {
    color: #9ca3af !important;
  }
  .dark .border-gray-300 {
    border-color: #4b5563 !important;
  }
  .dark .bg-gray-50 {
    background-color: #1f2937 !important;
  }
  .dark .bg-gray-100 {
    background-color: #374151 !important;
  }

  /* Dark mode para elementos espec√≠ficos (mantendo padr√£o original) */
  html.dark .th {
    color: #d1d5db; /* dark:text-gray-300 */
    border-bottom-color: #374151; /* dark:border-b-gray-700 */
  }
  html.dark .td {
    border-bottom-color: #374151; /* dark:border-b-gray-700 */
  }
  html.dark .danger-banner {
    background-color: #1f2937; /* dark:bg-red-900/20 (aprox) */
    border-color: #7f1d1d; /* dark:border-red-700 */
    color: #f3e8e8; /* dark:text-red-300 */
    border-left-color: #b91c1c; /* dark:border-left-red-600 */
  }
  html.dark .loading-spinner {
    color: #9ca3af; /* dark:gray-400 */
  }
  html.dark #toast-message {
    background-color: #f3f4f6; /* dark:bg-gray-200 */
    color: #111827; /* dark:text-gray-900 */
  }
  html.dark .pill {
    background-color: #374151; /* dark:bg-gray-700 */
  }
  html.dark .search-highlight {
    background-color: #92400e; /* dark:bg-yellow-700 (aprox) para legibilidade */
  }
  html.dark .tag-suggestion {
    border-bottom-color: #374151; /* dark:border-b-gray-600 */
  }
  html.dark .tag-suggestion:hover {
    background-color: #374151; /* dark:bg-gray-600 */
  }
  html.dark #historico-variavel-scroll-container {
    border-color: #374151; /* dark:border-gray-700 */
  }
  html.dark .progress-parcelado {
    background-color: #374151; /* dark:gray-700 */
  }
  html.dark .parcelado-ativo {
    background-color: #1e3a8a; /* dark:bg-blue-900/20 (aprox) */
    color: #bfdbfe; /* dark:text-blue-200 */
  }
  html.dark .parcelado-finalizado {
    background-color: #064e3b; /* dark:bg-green-900/20 (aprox) */
    color: #86efac; /* dark:text-green-200 */
  }
  html.dark .parcelado-futuro {
    background-color: #374151; /* dark:bg-gray-700 */
    color: #d1d5db; /* dark:text-gray-300 */
  }

  html.dark #parcelados-table-wrapper.parcelados-scroll {
    border-color: #475569;
    background-color: #374151;
    box-shadow: inset 0 -10px 18px -16px rgba(15, 23, 42, 0.5);
  }

  html.dark #parcelados-table-wrapper.parcelados-scroll::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.45);
  }

  html.dark #parcelados-table-wrapper.parcelados-scroll::-webkit-scrollbar-thumb:hover {
    background: rgba(148, 163, 184, 0.65);
  }

/* NOVO: Estilo para o bot√£o flutuante quando invis√≠vel */
#floating-menu.invisible {
  pointer-events: none;
  display: none; /* Adicionado para garantir que n√£o ocupe espa√ßo nem receba cliques */
}

</style>


</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-900 dark:to-gray-800 min-h-screen text-gray-800 dark:text-gray-100 transition-colors duration-300">

<!-- AUTH OVERLAY -->
<div id="auth-overlay" class="hidden fixed inset-0 z-[10000] bg-slate-900/90 backdrop-blur flex items-center justify-center px-4 py-8">
  <div class="w-full max-w-sm bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-emerald-200/60 dark:border-emerald-900/40 p-6 space-y-6">
    <div class="text-center space-y-2">
      <h2 id="auth-title" class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">Acessar sua conta</h2>
      <p id="auth-description" class="text-sm text-gray-500 dark:text-gray-400">Fa√ßa login para carregar seus dados financeiros salvos.</p>
    </div>
    <form id="auth-form" class="space-y-4">
      <div class="space-y-1">
        <label for="auth-email" class="text-sm font-medium text-gray-700 dark:text-gray-300">E-mail</label>
        <input id="auth-email" type="email" autocomplete="email" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-emerald-500" />
      </div>
      <div class="space-y-1">
        <label for="auth-password" class="text-sm font-medium text-gray-700 dark:text-gray-300">Senha</label>
        <input id="auth-password" type="password" autocomplete="current-password" required minlength="6" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-emerald-500" />
      </div>
      <div class="space-y-2">
        <button type="submit" id="auth-submit" class="w-full py-2.5 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-semibold transition-colors">Entrar</button>
        <button type="button" id="auth-toggle-mode" class="w-full py-2.5 rounded-lg border border-emerald-200 dark:border-emerald-800 text-emerald-700 dark:text-emerald-300 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 transition-colors">Criar uma nova conta</button>
      </div>
      <p id="auth-error" class="text-sm text-red-500 hidden"></p>
    </form>
    <div class="space-y-3">
      <div class="flex items-center gap-3 text-xs uppercase tracking-[0.3em] text-gray-400 dark:text-gray-500">
        <span class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></span>
        <span>ou</span>
        <span class="flex-1 h-px bg-gray-200 dark:bg-gray-700"></span>
      </div>
      <button type="button" id="auth-google" class="w-full flex items-center justify-center gap-3 py-2.5 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/80 transition-colors">
        <i class="fab fa-google text-lg"></i>
        <span data-label>Entrar com Google</span>
      </button>
      <p id="auth-google-helper" class="hidden text-xs leading-relaxed text-amber-600 dark:text-amber-400 bg-amber-50/80 dark:bg-amber-400/10 border border-amber-200/80 dark:border-amber-500/40 rounded-lg px-3 py-2">
        Para usar o Google em desenvolvimento, abra o app por <strong>http://localhost</strong> ou adicione <strong data-google-host></strong> √† lista de dom√≠nios autorizados no Console do Firebase (Authentication ‚Üí Settings ‚Üí Authorized domains).
      </p>
    </div>
  </div>
</div>

<!-- HEADER: filtro m√™s (geral) + bot√£o adicionar gasto (desktop) + Dark Mode Toggle -->
<header class="bg-white dark:bg-gray-900 shadow sticky top-0 z-40 flex items-center justify-between px-4 py-4 md:py-3 relative">
  <div class="flex items-center gap-4">
    <!-- Ajuste para mobile: text-xl no mobile, text-2xl no desktop -->
    <div class="text-xl md:text-2xl font-bold text-blue-600 dark:text-blue-400">Org. Financeiro</div>
    <!-- Esconde o subt√≠tulo no mobile -->
    <div class="text-sm text-gray-500 dark:text-gray-400 hidden md:block">Controle familiar</div>
  </div>
  <div class="flex items-center gap-3 flex-wrap justify-end">
    <!-- Filtro de m√™s GERAL (para hist√≥rico e resumo) -->
    <select id="filtro-mes" class="px-3 py-1 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-sm">
      <option value="all">Todos</option>
    </select>

    <!-- Bot√£o vis√≠vel s√≥ no desktop -->
    <button id="btn-open-add-gasto"
      class="hidden md:flex bg-blue-600 dark:bg-blue-700 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 dark:hover:bg-blue-800 flex items-center gap-2 transition-colors"
      aria-label="Adicionar gasto">
      <i class="fa fa-plus"></i> <span class="hidden md:inline">Adicionar gasto</span>
    </button>
    <!-- NOVO: Bot√£o Toggle Dark Mode -->
    <button id="toggleDark" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
      <span class="dark:hidden">üåô</span>
      <span class="hidden dark:inline">‚òÄÔ∏è</span>
    </button>
    <div id="user-session" class="hidden items-center gap-2 rounded-full bg-gray-100 dark:bg-gray-800/80 px-3 py-1.5">
      <span id="user-email-badge" class="text-sm font-medium text-gray-600 dark:text-gray-200 truncate max-w-[150px]"></span>
      <button id="btn-signout" type="button" class="text-xs font-semibold text-red-500 hover:text-red-600 dark:text-red-300 dark:hover:text-red-200 transition-colors">Sair</button>
    </div>
  </div>
</header>

<!-- MOBILE QUICK SUMMARY + NAV -->
<section id="mobile-quickbar" class="lg:hidden sticky top-16 z-30 px-4 py-3 space-y-2 bg-white/90 dark:bg-gray-900/90 backdrop-blur border-b border-gray-200/70 dark:border-gray-700/60 shadow-sm">
  <div class="flex items-center justify-between text-[0.7rem] uppercase tracking-[0.18em] text-gray-500 dark:text-gray-400">
    <span>Vis√£o geral</span>
    <span class="font-semibold text-blue-600 dark:text-blue-300">Mobile</span>
  </div>
  <nav id="mobile-panels-nav" class="text-sm font-medium">
    <div class="flex gap-2 overflow-x-auto no-scrollbar">
      <button type="button" class="mobile-tab-button" data-panel-target="painel-gastos">Gastos</button>
      <button type="button" class="mobile-tab-button" data-panel-target="painel-saidas">Sa√≠das</button>
      <button type="button" class="mobile-tab-button" data-panel-target="painel-entradas">Entradas</button>
      <button type="button" class="mobile-tab-button" data-panel-target="painel-investimentos">Invest.</button>
      <button type="button" class="mobile-tab-button" data-panel-target="painel-saude-financeira">Sa√∫de</button>
      <button type="button" class="mobile-tab-button" data-panel-target="painel-fixos">Fixos</button>
      <button type="button" class="mobile-tab-button" data-panel-target="painel-cartoes">Cart√µes</button>
    </div>
  </nav>
</section>

<!-- LOADING SCREEN -->
<div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-900 dark:to-gray-800 z-[9999]">
  <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400 mb-8">Organizador Financeiro</h1>
  
  <!-- Anima√ß√£o de gr√°fico -->
  <div class="flex space-x-2 mb-6">
    <div class="w-3 h-8 bg-green-500 rounded animate-bounce" style="animation-delay: -0.3s"></div>
    <div class="w-3 h-12 bg-green-400 rounded animate-bounce" style="animation-delay: -0.15s"></div>
    <div class="w-3 h-6 bg-green-600 rounded animate-bounce"></div>
  </div>

  <p class="text-gray-600 dark:text-gray-300">Organizando suas finan√ßas‚Ä¶</p>
</div>


<!-- Modal para adicionar/editar parcelado -->
<div id="modal-parcelado" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-96 p-6 relative">
    <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100" id="modal-parcelado-title">Editar Parcelado</h2>
    <form id="form-parcelado" class="space-y-4">
      <div>
        <label for="parcelado-desc" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Descri√ß√£o</label>
        <input type="text" id="parcelado-desc" name="descricao" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600"/>
      </div>
      <div>
        <label for="parcelado-valor" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Valor da Parcela (R$)</label>
        <input type="number" id="parcelado-valor" name="valorParcela" min="0" step="0.01" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600"/>
      </div>
      <div>
        <label for="parcelado-num" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">N√∫mero de Parcelas</label>
        <input type="number" id="parcelado-num" name="numParcelas" min="1" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600"/>
      </div>
      <div>
        <label for="parcelado-cartao" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Cart√£o</label>
        <select id="parcelado-cartao" name="cartao" class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
          <option value="">Nenhum</option>
          <option value="nubank">Nubank</option>
          <option value="itau">Ita√∫</option>
          <option value="univ">Univ</option>
          <option value="amazon">Amazon</option>
          <option value="mercado">Mercado Pago</option>
          <option value="pix">PIX</option>
        </select>
      </div>
      <div>
        <label for="parcelado-inicio" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Data de In√≠cio</label>
        <input type="month" id="parcelado-inicio" name="dataInicio" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600"/>
      </div>
      <div class="flex justify-end space-x-2 mt-4">
        <button type="button" id="btn-cancelar-parcelado" class="px-4 py-2 rounded bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-100 hover:bg-gray-400 dark:hover:bg-gray-700">Cancelar</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 dark:bg-blue-700 text-white hover:bg-blue-700 dark:hover:bg-blue-800">Salvar</button>
      </div>
    </form>
  </div>
</div>

<!-- NOVO: Modal de Confirma√ß√£o Customizado -->
<div id="modal-confirmacao" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 w-11/12 max-w-sm mx-auto relative shadow-lg modal-content">
    <h2 class="text-xl font-bold mb-4 text-gray-800" id="modal-confirmacao-title">Confirmar A√ß√£o</h2>
    <p class="text-gray-700 mb-6" id="modal-confirmacao-message">Voc√™ tem certeza que deseja realizar esta a√ß√£o?</p>
    <div class="flex justify-end gap-3">
      <button type="button" id="btn-cancelar-confirmacao" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors">Cancelar</button>
      <button type="button" id="btn-confirmar-acao" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">Confirmar</button>
    </div>
  </div>
</div>


<!-- Modal para adicionar/editar gasto fixo -->
<div id="modal-fixo" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-96 p-6 relative">
    <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100" id="modal-fixo-title">Adicionar Gasto Fixo</h2>
    <form id="form-fixo" class="space-y-4">
      <div>
        <label for="fixo-nome" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Nome</label>
        <input type="text" id="fixo-nome" name="nome" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600"/>
      </div>
      <div>
        <label for="fixo-categoria" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Categoria</label>
        <select id="fixo-categoria" name="categoria" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
          <option value="">Selecione uma categoria</option>
          <option value="Assinaturas">Assinaturas</option>
          <option value="Contas">Contas</option>
          <option value="Seguros">Seguros</option>
          <option value="Outros">Outros</option>
        </select>
      </div>
      <div>
        <label for="fixo-subcategoria" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Subcategoria</label>
        <select id="fixo-subcategoria" name="subcategoria" class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" disabled>
          <option value="">Selecione uma categoria primeiro</option>
        </select>
      </div>
      <div>
        <label for="fixo-valor" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Valor (R$)</label>
        <input type="number" id="fixo-valor" name="valor" min="0" step="0.01" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600"/>
      </div>
      <div class="flex items-center space-x-2">
        <input type="checkbox" id="fixo-ativo" name="ativo" checked class="form-checkbox h-4 w-4 text-blue-600 dark:text-blue-400 border-gray-300 dark:border-gray-600 rounded"/>
        <label for="fixo-ativo" class="font-medium text-gray-800 dark:text-gray-100">Ativo</label>
      </div>
      <div class="flex justify-end space-x-2 mt-4">
        <button type="button" id="btn-cancelar-fixo" class="px-4 py-2 rounded bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-100 hover:bg-gray-400 dark:hover:bg-gray-700">Cancelar</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 dark:bg-blue-700 text-white hover:bg-blue-700 dark:hover:bg-blue-800">Salvar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para adicionar gasto -->
<div id="modal-add-gasto" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-11/12 max-w-md mx-auto relative shadow-lg modal-content">
    <button id="modal-close" class="absolute top-3 right-3 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-2xl font-bold" aria-label="Fechar modal">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Adicionar Gasto Vari√°vel</h2>
    <form id="form-add-gasto-modal" class="space-y-4">
      <select id="modal-cartao" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
        <option value="pix" selected>PIX</option>
        <option value="nubank">Nubank</option>
        <option value="itau">Ita√∫</option>
        <option value="univ">Univ</option>
        <option value="amazon">Amazon</option>
        <option value="mercado">Mercado Pago</option>
        <option value="">Nenhum</option>
      </select>
      <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="mes-fatura-estimado">M√™s de Pagamento Estimado: <span class="font-semibold">M√™s Atual</span></div>
      <select id="modal-categoria" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
        <option value="" disabled selected>Categoria (opcional)</option>
        <option value="alimentacao">Alimenta√ß√£o</option>
        <option value="transporte">Transporte</option>
        <option value="moradia">Moradia</option>
        <option value="lazer">Lazer</option>
        <option value="saude">Sa√∫de</option>
        <option value="educacao">Educa√ß√£o</option>
        <option value="contas">Contas</option>
        <option value="outros">Outros</option>
      </select>
      <input id="modal-valor" type="number" step="0.01" min="0.01" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Valor (R$)" required />
      <p id="error-modal-valor" class="text-red-500 dark:text-red-400 text-xs mt-1 hidden">Por favor, insira um valor v√°lido maior que zero.</p>
      <input id="modal-desc" type="text" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Descri√ß√£o (opcional)" />
      
      <!-- NOVO: Sistema de Tags Inteligente -->
      <div class="relative">
        <input id="modal-tags" type="text" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Tags (ex: padaria, supermercado)" />
        <div id="tags-suggestions" class="absolute z-10 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg mt-1 hidden max-h-32 overflow-y-auto"></div>
        <div id="selected-tags" class="flex flex-wrap gap-1 mt-2"></div>
      </div>
      <div class="flex justify-end gap-3">
        <button type="button" id="modal-cancel" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-700 dark:text-gray-100">Cancelar</button>
        <button type="submit" class="bg-blue-600 dark:bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-800 transition-colors">Adicionar</button>
      </div>
    </form>
  </div>
</div>

<main class="container mx-auto px-4 py-4 pb-24 md:pb-16 grid grid-cols-1 lg:grid-cols-4 gap-6">

  <!-- LEFT: main (resumo + hist√≥rico + parcelados) -->
  <section id="painel-gastos" class="mobile-panel hidden lg:block lg:col-span-3 space-y-6">

    <!-- danger banner (strong visual alert) -->
    <div id="danger-banner" class="hidden danger-banner">‚ö†Ô∏è Aten√ß√£o ‚Äî fixos + parcelas do m√™s ultrapassam o limite! Verifique.</div>

    <!-- RESUMO COM SLIDER -->
    <div class="section-card gradient-shadow compact-resumo">
      <div class="resumo-slider-nav">
        <button type="button" class="resumo-slider-dot is-active" data-slide="0">Gastos</button>
        <button type="button" class="resumo-slider-dot" data-slide="1">Fluxo</button>
        <div class="flex-1"></div>
        <div class="resumo-slider-dots md:hidden">
          <button type="button" class="is-active" data-slide="0" aria-label="Ver indicadores de gastos"></button>
          <button type="button" data-slide="1" aria-label="Ver indicadores de fluxo"></button>
        </div>
      </div>
      <div class="resumo-slider" id="resumo-slider">
        <div class="resumo-slider-track" id="resumo-slider-track">
          <section class="resumo-slide" data-key="gastos">
            <div class="resumo-slide-grid">
              <div class="resumo-item alerta">
                <span class="label">Total previsto (m√™s)</span>
                <span class="value">R$ <span id="resumo-total-mes">0,00</span></span>
                <span class="hint">Hist√≥rico + Parcelas + Fixos</span>
              </div>
              <div class="resumo-item neutro">
                <span class="label">Cart√µes</span>
                <span class="value">R$ <span id="resumo-cartoes">0,00</span></span>
                <span class="hint">Inclui parcelas do m√™s</span>
              </div>
              <div class="resumo-item">
                <span class="label">PIX</span>
                <span class="value">R$ <span id="resumo-pix">0,00</span></span>
                <span class="hint">Pagamentos instant√¢neos</span>
              </div>
              <div class="resumo-item">
                <span class="label">Parcelas (m√™s)</span>
                <span class="value">R$ <span id="resumo-parcelas-mes">0,00</span></span>
                <span class="hint">Compromissos do m√™s atual</span>
              </div>
            </div>
          </section>
          <section class="resumo-slide" data-key="fluxo">
            <div class="resumo-slide-grid">
              <div class="resumo-item positivo">
                <span class="label">Entradas do m√™s</span>
                <span class="value">R$ <span id="resumo-entradas-mes">0,00</span></span>
                <span class="hint">Sal√°rios, vendas e extras</span>
              </div>
              <div class="resumo-item alerta">
                <span class="label">Sa√≠das totais</span>
                <span class="value">R$ <span id="resumo-saidas-mes">0,00</span></span>
                <span class="hint">Todos os gastos do m√™s</span>
              </div>
              <div class="resumo-item neutro">
                <span class="label">Saldo projetado</span>
                <span class="value">R$ <span id="resumo-saldo-projetado">0,00</span></span>
                <span class="hint">Ap√≥s rendimento de 1% a.m.</span>
              </div>
              <div class="resumo-item">
                <span class="label">Ganho em investimentos</span>
                <span class="value">R$ <span id="resumo-ganho-invest">0,00</span></span>
                <span class="hint">Comparado ao aporte total</span>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- NOVO: Envelopes or√ßament√°rios -->
    <div class="section-card space-y-4" id="painel-envelopes">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h3 class="text-lg font-bold flex items-center gap-2">üéØ Envelopes do M√™s</h3>
          <p class="text-xs text-gray-500 dark:text-gray-400">Defina limites mensais de gastos, acompanhe a margem dispon√≠vel e direcione sobras para reservas futuras.</p>
        </div>
        <div class="flex flex-col gap-2 text-xs sm:flex-row sm:items-center sm:gap-3">
          <button id="btn-envelopes-overview" type="button" class="flex flex-col sm:flex-row sm:items-center sm:gap-3 rounded-full border border-emerald-200 dark:border-emerald-800/60 bg-white/70 dark:bg-emerald-900/30 px-3 py-2 text-left shadow-sm transition hover:border-emerald-400 dark:hover:border-emerald-600">
            <span class="text-[0.65rem] uppercase tracking-wide text-emerald-700 dark:text-emerald-300">Resumo das metas</span>
            <span class="text-sm font-semibold text-slate-900 dark:text-slate-100">Meta: R$ <span id="overview-meta-total">0,00</span></span>
            <span class="text-sm text-slate-700 dark:text-slate-200">Reservado: R$ <span id="overview-reservado-total">0,00</span></span>
            <span class="text-xs text-emerald-600 dark:text-emerald-300">Margem livre: R$ <span id="overview-margem-total">0,00</span></span>
          </button>
          <div class="flex items-center gap-2">
            <button id="btn-envelopes-reservar-todos" type="button" class="px-3 py-1 rounded bg-emerald-600 dark:bg-emerald-700 text-white hover:bg-emerald-700 dark:hover:bg-emerald-800 transition">Reservar nos envelopes</button>
            <button id="btn-envelopes-limpar-reservas" type="button" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition">Limpar reservas</button>
          </div>
        </div>
      </div>
      <div class="envelopes-carousel flex gap-4 overflow-x-auto snap-x snap-mandatory pb-2 -mx-4 px-4" id="envelopes-grid">
        <div class="envelope-card border-l-4 border-blue-500 bg-blue-50/70 dark:bg-slate-800/60 rounded-lg p-4 flex flex-col gap-3 shrink-0 basis-[85%] sm:basis-[70%] lg:basis-[45%] xl:basis-[32%] min-w-[18rem] snap-start" data-envelope-card="fixo">
          <div class="flex flex-col gap-3">
            <div class="flex items-start justify-between gap-3">
              <div class="space-y-1">
                <div class="font-semibold text-blue-700 dark:text-blue-200 flex items-center gap-2"><i class="fa fa-house"></i><span>Custo Fixo</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Limite mensal: R$ <span id="meta-fixo">0,00</span></div>
                <div class="text-lg font-bold text-slate-900 dark:text-slate-100">Gasto no m√™s: R$ <span id="gasto-fixo">0,00</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Margem dispon√≠vel: R$ <span id="limite-livre-fixo">0,00</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Reserva planejada: R$ <span id="reserva-fixo">0,00</span></div>
                <div class="text-xs text-red-600 dark:text-red-300 hidden" id="excedente-fixo-wrapper">Acima do limite: R$ <span id="excedente-fixo">0,00</span></div>
              </div>
              <div class="space-y-2 text-xs w-32">
                <label class="block font-semibold text-slate-600 dark:text-slate-300">Limite mensal
                  <input id="envelope-fixo-meta" type="number" min="0" step="0.01" class="mt-1 w-full border px-2 py-1 rounded text-right bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
                </label>
                <label class="block font-semibold text-slate-600 dark:text-slate-300">Reserva planejada
                  <input id="envelope-fixo-reserva" type="number" min="0" step="0.01" class="mt-1 w-full border px-2 py-1 rounded text-right bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
                </label>
              </div>
            </div>
            <div>
              <div class="w-full bg-white/60 dark:bg-gray-700 rounded-full h-2 shadow-inner">
                <div id="progress-fixo" class="progress-bar h-2 rounded-full bg-blue-500" style="width:0%"></div>
              </div>
              <div class="flex justify-between text-[0.7rem] text-slate-500 dark:text-slate-400 mt-1">
                <span>Comprometido: <strong id="percentual-fixo">0%</strong></span>
                <span>Margem dispon√≠vel: R$ <span id="disponivel-fixo">0,00</span></span>
              </div>
            </div>
            <div class="flex flex-wrap gap-2 text-xs">
              <button data-envelope-action="liberar" data-envelope="fixo" type="button" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition">Liberar reserva</button>
            </div>
          </div>
        </div>

        <div class="envelope-card border-l-4 border-green-500 bg-emerald-50/70 dark:bg-emerald-900/30 rounded-lg p-4 flex flex-col gap-3 shrink-0 basis-[85%] sm:basis-[70%] lg:basis-[45%] xl:basis-[32%] min-w-[18rem] snap-start" data-envelope-card="parcelado">
          <div class="flex flex-col gap-3">
            <div class="flex items-start justify-between gap-3">
              <div class="space-y-1">
                <div class="font-semibold text-emerald-700 dark:text-emerald-200 flex items-center gap-2"><i class="fa fa-receipt"></i><span>Parcelados do m√™s</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Limite mensal: R$ <span id="meta-parcelado">0,00</span></div>
                <div class="text-lg font-bold text-slate-900 dark:text-slate-100">Gasto no m√™s: R$ <span id="gasto-parcelado">0,00</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Margem dispon√≠vel: R$ <span id="limite-livre-parcelado">0,00</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Reserva planejada: R$ <span id="reserva-parcelado">0,00</span></div>
                <div class="text-xs text-red-600 dark:text-red-300 hidden" id="excedente-parcelado-wrapper">Acima do limite: R$ <span id="excedente-parcelado">0,00</span></div>
              </div>
              <div class="space-y-2 text-xs w-32">
                <label class="block font-semibold text-slate-600 dark:text-slate-300">Limite mensal
                  <input id="envelope-parcelado-meta" type="number" min="0" step="0.01" class="mt-1 w-full border px-2 py-1 rounded text-right bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
                </label>
                <label class="block font-semibold text-slate-600 dark:text-slate-300">Reserva planejada
                  <input id="envelope-parcelado-reserva" type="number" min="0" step="0.01" class="mt-1 w-full border px-2 py-1 rounded text-right bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
                </label>
              </div>
            </div>
            <div>
              <div class="w-full bg-white/60 dark:bg-gray-700 rounded-full h-2 shadow-inner">
                <div id="progress-parcelado" class="progress-bar h-2 rounded-full bg-green-500" style="width:0%"></div>
              </div>
              <div class="flex justify-between text-[0.7rem] text-slate-500 dark:text-slate-400 mt-1">
                <span>Comprometido: <strong id="percentual-parcelado">0%</strong></span>
                <span>Margem dispon√≠vel: R$ <span id="disponivel-parcelado">0,00</span></span>
              </div>
            </div>
            <div class="flex flex-wrap gap-2 text-xs">
              <button data-envelope-action="liberar" data-envelope="parcelado" type="button" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition">Liberar reserva</button>
            </div>
          </div>
        </div>

        <div class="envelope-card border-l-4 border-orange-500 bg-amber-50/80 dark:bg-amber-900/30 rounded-lg p-4 flex flex-col gap-3 shrink-0 basis-[85%] sm:basis-[70%] lg:basis-[45%] xl:basis-[32%] min-w-[18rem] snap-start" data-envelope-card="variavel">
          <div class="flex flex-col gap-3">
            <div class="flex items-start justify-between gap-3">
              <div class="space-y-1">
                <div class="font-semibold text-amber-700 dark:text-amber-200 flex items-center gap-2"><i class="fa fa-basket-shopping"></i><span>Vari√°veis</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Limite mensal: R$ <span id="meta-variavel">0,00</span></div>
                <div class="text-lg font-bold text-slate-900 dark:text-slate-100">Gasto no m√™s: R$ <span id="gasto-variavel">0,00</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Margem dispon√≠vel: R$ <span id="limite-livre-variavel">0,00</span></div>
                <div class="text-xs text-slate-500 dark:text-slate-400">Reserva planejada: R$ <span id="reserva-variavel">0,00</span></div>
                <div class="text-xs text-red-600 dark:text-red-300 hidden" id="excedente-variavel-wrapper">Acima do limite: R$ <span id="excedente-variavel">0,00</span></div>
              </div>
              <div class="space-y-2 text-xs w-32">
                <label class="block font-semibold text-slate-600 dark:text-slate-300">Limite mensal
                  <input id="envelope-variavel-meta" type="number" min="0" step="0.01" class="mt-1 w-full border px-2 py-1 rounded text-right bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
                </label>
                <label class="block font-semibold text-slate-600 dark:text-slate-300">Reserva planejada
                  <input id="envelope-variavel-reserva" type="number" min="0" step="0.01" class="mt-1 w-full border px-2 py-1 rounded text-right bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
                </label>
              </div>
            </div>
            <div>
              <div class="w-full bg-white/60 dark:bg-gray-700 rounded-full h-2 shadow-inner">
                <div id="progress-variavel" class="progress-bar h-2 rounded-full bg-orange-500" style="width:0%"></div>
              </div>
              <div class="flex justify-between text-[0.7rem] text-slate-500 dark:text-slate-400 mt-1">
                <span>Comprometido: <strong id="percentual-variavel">0%</strong></span>
                <span>Margem dispon√≠vel: R$ <span id="disponivel-variavel">0,00</span></span>
              </div>
            </div>
            <div class="flex flex-wrap gap-2 text-xs">
              <button data-envelope-action="liberar" data-envelope="variavel" type="button" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition">Liberar reserva</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- HIST√ìRICO (vari√°veis + fixos avulsos) -->
      <div class="section-card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Hist√≥rico (m√™s)</h3>
        <div class="flex items-center gap-2">
          <button id="btn-historico-graficos" class="bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-200 px-3 py-1 rounded text-sm hover:bg-blue-200 dark:hover:bg-blue-900/40 transition-colors">
            <i class="fa fa-chart-pie mr-1"></i>Gr√°ficos
          </button>
          <button id="exportar-csv" class="bg-green-600 dark:bg-green-700 text-white px-3 py-1 rounded hover:bg-green-700 dark:hover:bg-green-800 transition-colors">Exportar CSV (m√™s)</button>
        </div>
      </div>

      <!-- NOVO: Filtro de busca no hist√≥rico -->
      <div class="mb-3 flex flex-wrap gap-2 items-center">
        <input id="search-historico" type="text" placeholder="Buscar na descri√ß√£o ou tags..." class="flex-1 min-w-48 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
        <select id="group-by-historico" class="px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
          <option value="">Sem agrupamento</option>
          <option value="categoria">Agrupar por Categoria</option>
          <option value="cartao">Agrupar por Cart√£o</option>
          <option value="tag">Agrupar por Tag</option>
        </select>
        <button id="clear-search" class="px-3 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-100 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">
          <i class="fa fa-times"></i>
        </button>
      </div>

      <!-- NOVO: Container com scroll para o hist√≥rico de vari√°veis -->
      <div id="historico-variavel-scroll-container" class="overflow-x-auto">
        <div id="historico-loading-spinner" class="loading-spinner spinner-hidden">
          <i class="fa fa-spinner fa-spin"></i> Carregando hist√≥rico...
        </div>
        <table class="w-full">
          <thead>
            <tr>
              <th class="th">Cart√£o/PIX</th><th class="th">Descri√ß√£o</th><th class="th">Valor</th><th class="th">Data Transa√ß√£o</th><th class="th">M√™s Fatura</th><th class="th">Tipo</th><th class="th">Tags</th><th class="th">A√ß√µes</th>
            </tr>
          </thead>
            </tr>
          </thead>
          <tbody id="transactions-list">
            <tr><td class="td" colspan="8">Nenhum gasto registrado no m√™s</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- PARCELADOS (painel dedicado) - MELHORADO -->
    <div class="section-card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Parcelados (se√ß√£o dedicada)</h3>
      </div>

      <!-- add parcelado -->
      <form id="parcelado-form" class="grid grid-cols-1 md:grid-cols-6 gap-2 mb-3">
        <input id="p-desc" class="px-2 py-1 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Descri√ß√£o (ex: Guarda-roupa)" required/>
        <input id="p-valor" type="number" step="0.01" class="px-2 py-1 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Valor da parcela (R$)" required/>
        <input id="p-num" type="number" min="1" class="px-2 py-1 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="N¬∫ parcelas" required/>
        <select id="p-cartao" class="px-2 py-1 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
          <option value="">Nenhum</option>
          <option value="nubank">Nubank</option>
          <option value="itau">Ita√∫</option>
          <option value="univ">Univ</option>
          <option value="amazon">Amazon</option>
          <option value="mercado">Mercado Pago</option>
          <option value="pix">PIX</option>
        </select>
        <input id="p-inicio" type="month" class="px-2 py-1 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" required/>
        <button class="bg-purple-600 dark:bg-purple-700 text-white px-3 py-1 rounded hover:bg-purple-700 dark:hover:bg-purple-800 transition-colors">Adicionar Parcelado</button>
      </form>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
        <div class="section-card">
          <div class="text-sm text-gray-500 dark:text-gray-400">Parcelas no m√™s</div>
          <div class="text-2xl font-bold">R$ <span id="p-total-mes">0,00</span></div>
        </div>
        <div class="section-card">
          <div class="text-sm text-gray-500 dark:text-gray-400">Comprometido total</div>
          <div class="text-2xl font-bold">R$ <span id="p-total-restante">0,00</span></div>
        </div>
        <div class="section-card">
          <div class="text-sm text-gray-500 dark:text-gray-400">Parcelados ativos</div>
          <div class="text-2xl font-bold"><span id="p-ativos">0</span></div>
        </div>
      </div>

      <div class="mt-6">
        <button type="button" id="toggle-parcelados-projecao" class="w-full flex items-center justify-between text-sm font-semibold text-purple-700 dark:text-purple-200 bg-purple-50 dark:bg-purple-900/20 px-3 py-2 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/30 transition" aria-expanded="true" aria-controls="parcelados-projecao-container">
          <span class="flex items-center gap-2"><i class="fa fa-chart-column text-purple-500"></i><span>Proje√ß√£o de parcelas</span></span>
          <span class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
            <span id="parcelados-projecao-janela">Pr√≥ximos meses</span>
            <i id="parcelados-projecao-toggle-icon" class="fa fa-chevron-down transition-transform duration-200"></i>
          </span>
        </button>
        <div id="parcelados-projecao-container" class="mt-3 space-y-2" role="region" aria-live="polite" aria-hidden="false">
          <div class="relative h-48">
            <canvas id="grafico-parcelados-projecao" class="w-full h-full"></canvas>
            <div id="parcelados-projecao-empty" class="absolute inset-0 flex items-center justify-center text-xs text-gray-500 dark:text-gray-400">Cadastre parcelados ativos para visualizar a proje√ß√£o.</div>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <div id="parcelados-loading-spinner" class="loading-spinner spinner-hidden">
          <i class="fa fa-spinner fa-spin"></i> Carregando parcelados...
        </div>
        <div id="parcelados-table-wrapper">
          <table class="w-full">
            <thead>
              <tr><th class="th">Descri√ß√£o</th><th class="th">Parcela (R$)</th><th class="th">Progresso</th><th class="th">Status</th><th class="th">Cart√£o</th><th class="th">In√≠cio</th><th class="th">Fim</th><th class="th">A√ß√µes</th></tr>
            </thead>
            <tbody id="parcelados-list">
              <tr><td class="td" colspan="8">Nenhum parcelado para o m√™s selecionado</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- NOVA SE√á√ÉO: GASTOS POR CATEGORIA -->
    <div class="section-card">
      <h3 class="text-lg font-bold mb-3">Gastos por Categoria (m√™s)</h3>
      <div id="categorias-list" class="space-y-3">
        <!-- Categorias ser√£o renderizadas aqui pelo JS -->
        <div class="text-gray-500 dark:text-gray-400">Nenhum gasto categorizado no m√™s.</div>
      </div>
    </div>

    <!-- NOVO: Dashboard de Insights Inteligentes -->
    <div class="section-card">
      <h3 class="text-lg font-bold mb-3">üí° Insights Financeiros</h3>
      <div id="insights-container" class="space-y-3">
        <!-- Insights ser√£o gerados automaticamente aqui -->
        <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg text-green-800 dark:text-green-200">Carregando insights...</div>
      </div>
    </div>

  </section>

  <!-- RIGHT: sidebar (fixos list + cart√µes compact + a√ß√µes) - MELHORADO -->
  <aside class="space-y-6">

    <!-- NOVO: Entradas de dinheiro -->
    <div class="mobile-panel hidden lg:block section-card space-y-4" id="painel-entradas">
      <div>
        <h3 class="font-semibold text-lg flex items-center gap-2"><i class="fa fa-arrow-down text-green-500"></i>Entradas de Dinheiro</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400">Registre sal√°rios, vendas e rendas extras e acompanhe o fluxo mensal.</p>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
        <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
          <div class="text-xs text-green-700 dark:text-green-200 uppercase tracking-wide">M√™s selecionado</div>
          <div class="text-lg font-bold text-green-800 dark:text-green-300">R$ <span id="entradas-total-mes">0,00</span></div>
        </div>
        <div class="p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg">
          <div class="text-xs text-emerald-700 dark:text-emerald-200 uppercase tracking-wide">Saldo l√≠quido do m√™s</div>
          <div class="text-lg font-bold text-emerald-800 dark:text-emerald-300">R$ <span id="entradas-saldo-mes">0,00</span></div>
          <div id="entradas-saldo-hint" class="text-[11px] text-emerald-700/80 dark:text-emerald-200/80 mt-1">Entradas menos sa√≠das previstas do per√≠odo selecionado.</div>
        </div>
        <div class="p-3 bg-green-100 dark:bg-green-900/10 rounded-lg sm:col-span-2">
          <div class="text-xs text-green-700 dark:text-green-200 uppercase tracking-wide">Entradas registradas</div>
          <div class="text-lg font-bold text-green-900 dark:text-green-200">R$ <span id="entradas-total-geral">0,00</span></div>
          <div class="text-[11px] text-green-700/80 dark:text-green-200/80 mt-1">Total acumulado de receitas cadastradas no sistema.</div>
        </div>
      </div>
      <form id="form-entrada" class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
        <select id="entrada-tipo" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" required>
          <option value="salario">Sal√°rio</option>
          <option value="venda">Venda</option>
          <option value="renda_extra">Renda extra</option>
          <option value="outros">Outros</option>
        </select>
        <input id="entrada-valor" type="number" step="0.01" min="0.01" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Valor (R$)" required />
        <input id="entrada-data" type="date" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" required />
        <input id="entrada-desc" type="text" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Descri√ß√£o (opcional)" />
        <button type="submit" class="sm:col-span-2 bg-green-600 dark:bg-green-700 text-white px-3 py-2 rounded hover:bg-green-700 dark:hover:bg-green-800 transition">Adicionar entrada</button>
      </form>
      <div>
        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-200">Distribui√ß√£o por tipo</h4>
        <div id="entradas-tipos-resumo" class="grid grid-cols-2 gap-2 text-xs text-gray-500 dark:text-gray-400">
          <div class="col-span-2 text-gray-500 dark:text-gray-400">Cadastre entradas para ver a distribui√ß√£o.</div>
        </div>
      </div>
      <div>
        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-200">Entradas recentes</h4>
        <div id="entradas-lista" class="space-y-2 max-h-48 overflow-y-auto text-sm">
          <div class="text-gray-500 dark:text-gray-400">Nenhuma entrada registrada.</div>
        </div>
      </div>
    </div>

    <!-- NOVO: Resumo das sa√≠das -->
    <div class="mobile-panel hidden lg:block section-card space-y-3" id="painel-saidas">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-lg flex items-center gap-2"><i class="fa fa-arrow-up text-red-500"></i>Sa√≠das do M√™s</h3>
        <span class="text-sm font-semibold text-gray-700 dark:text-gray-200">R$ <span id="saidas-total-card">0,00</span></span>
      </div>
      <p class="text-xs text-gray-500 dark:text-gray-400">Acompanhe o total previsto para o m√™s selecionado considerando gastos fixos, vari√°veis e parcelas.</p>
      <div class="space-y-3 text-sm">
        <div>
          <div class="flex justify-between mb-1">
            <span>Gastos fixos</span>
            <span>R$ <span id="saidas-fixos">0,00</span></span>
          </div>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
            <div id="saidas-fixos-bar" class="h-2 rounded-full bg-blue-500" style="width:0%"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between mb-1">
            <span>Vari√°veis</span>
            <span>R$ <span id="saidas-variavel">0,00</span></span>
          </div>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
            <div id="saidas-variavel-bar" class="h-2 rounded-full bg-orange-500" style="width:0%"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between mb-1">
            <span>Parcelas</span>
            <span>R$ <span id="saidas-parcelado">0,00</span></span>
          </div>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
            <div id="saidas-parcelado-bar" class="h-2 rounded-full bg-green-500" style="width:0%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- NOVO: Investimentos -->
    <div class="mobile-panel hidden lg:block section-card space-y-4" id="painel-investimentos">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-lg flex items-center gap-2"><i class="fa fa-chart-line text-indigo-500"></i>Investimentos</h3>
        <span class="text-xs text-gray-500 dark:text-gray-400">Proje√ß√£o com 1% ao m√™s</span>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm">
        <div class="p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg">
          <div class="text-xs text-indigo-700 dark:text-indigo-200 uppercase tracking-wide">Investido no m√™s</div>
          <div class="text-lg font-bold text-indigo-800 dark:text-indigo-200">R$ <span id="investimento-total-mes">0,00</span></div>
        </div>
        <div class="p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg">
          <div class="text-xs text-indigo-700 dark:text-indigo-200 uppercase tracking-wide">Total investido</div>
          <div class="text-lg font-bold text-indigo-800 dark:text-indigo-200">R$ <span id="investimento-total-geral">0,00</span></div>
        </div>
        <div class="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
          <div class="text-xs text-purple-700 dark:text-purple-200 uppercase tracking-wide">Proje√ß√£o futura</div>
          <div class="text-lg font-bold text-purple-800 dark:text-purple-200">R$ <span id="investimento-projecao">0,00</span></div>
        </div>
      </div>
      <div class="pt-3 border-t border-indigo-100 dark:border-indigo-900/40">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-sm font-semibold text-indigo-800 dark:text-indigo-200 flex items-center gap-2"><i class="fa fa-chart-area"></i>Evolu√ß√£o dos aportes</h4>
          <span class="text-xs text-gray-500 dark:text-gray-400">√öltimos 12 meses</span>
        </div>
        <div class="relative h-48">
          <canvas id="grafico-investimentos" class="w-full h-full"></canvas>
          <div id="investimentos-grafico-empty" class="absolute inset-0 flex items-center justify-center text-xs text-gray-500 dark:text-gray-400">Cadastre investimentos para visualizar o gr√°fico.</div>
        </div>
      </div>
      <div id="simulador-juros-compostos" class="bg-white/70 dark:bg-gray-800/60 border border-indigo-100 dark:border-indigo-900 rounded-lg p-5 space-y-4 text-base md:text-sm">
        <button type="button" class="w-full flex items-center justify-between text-left font-semibold text-indigo-700 dark:text-indigo-200 px-3 py-3 md:py-2.5 rounded-md bg-indigo-50/80 dark:bg-indigo-900/30 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 transition text-base md:text-sm" data-simulador-toggle aria-expanded="false">
          <span class="flex items-center gap-2"><i class="fa fa-calculator"></i><span>Simulador de juros compostos</span></span>
          <i class="fa fa-chevron-down text-xs" data-simulador-icon></i>
        </button>
        <p class="text-sm md:text-xs text-gray-500 dark:text-gray-400 px-3">Atualizado automaticamente com o resumo r√°pido.</p>
        <div data-simulador-content class="space-y-5 hidden px-3 pb-1">
          <p class="text-sm md:text-xs text-gray-500 dark:text-gray-400">Reaproveite os totais atuais para projetar rendimentos e compare com um cen√°rio alternativo de aportes ou taxas diferentes.</p>
          <div class="flex flex-col gap-5">
            <div class="space-y-4 border-l-4 border-indigo-100 dark:border-indigo-900/40 pl-4">
              <h5 class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-200 uppercase tracking-wide">Cen√°rio atual</h5>
              <div class="grid grid-cols-1 gap-4">
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Valor inicial (R$)
                  <input id="simulador-valor-inicial" data-simulador="base" type="number" step="0.01" min="0" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Aporte mensal (R$)
                  <input id="simulador-aporte-mensal" data-simulador="base" type="number" step="0.01" min="0" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Taxa mensal (%)
                  <input id="simulador-taxa" data-simulador="base" type="number" step="0.01" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Per√≠odo (meses)
                  <input id="simulador-periodo" data-simulador="base" type="number" step="1" min="1" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
              </div>
            </div>
            <div class="space-y-4 border-l-4 border-indigo-100 dark:border-indigo-900/40 pl-4">
              <h5 class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-200 uppercase tracking-wide">Comparar cen√°rio</h5>
              <div class="grid grid-cols-1 gap-4">
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Aporte mensal alternativo (R$)
                  <input id="simulador-aporte-alternativo" data-simulador="alternativo" type="number" step="0.01" min="0" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Taxa mensal alternativa (%)
                  <input id="simulador-taxa-alternativa" data-simulador="alternativo" type="number" step="0.01" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Aporte √∫nico extra (R$)
                  <input id="simulador-aporte-extra" data-simulador="alternativo" type="number" step="0.01" min="0" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
                <label class="text-sm md:text-xs font-semibold text-gray-600 dark:text-gray-300 flex flex-col gap-1.5 h-full">Meses adicionais
                  <input id="simulador-periodo-alternativo" data-simulador="alternativo" type="number" step="1" min="0" class="px-3 py-2 md:py-1.5 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600 text-right" />
                </label>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-4 text-sm md:text-xs">
            <div class="rounded-lg bg-indigo-100/80 dark:bg-indigo-900/30 p-4 border-l-4 border-indigo-300 dark:border-indigo-700/60">
              <h6 class="font-semibold text-indigo-800 dark:text-indigo-200 mb-1 text-base md:text-sm">Resultado cen√°rio atual</h6>
              <p class="text-gray-600 dark:text-gray-300">Valor projetado: <strong id="simulador-base-total">R$ 0,00</strong></p>
              <p class="text-gray-600 dark:text-gray-300">Ganho sobre aportes: <strong id="simulador-base-ganho">R$ 0,00</strong></p>
            </div>
            <div class="rounded-lg bg-purple-100/80 dark:bg-purple-900/30 p-4 border-l-4 border-purple-300 dark:border-purple-700/60">
              <h6 class="font-semibold text-purple-800 dark:text-purple-200 mb-1 text-base md:text-sm">Resultado cen√°rio alternativo</h6>
              <p class="text-gray-600 dark:text-gray-300">Valor projetado: <strong id="simulador-alt-total">R$ 0,00</strong></p>
              <p class="text-gray-600 dark:text-gray-300">Ganho sobre aportes: <strong id="simulador-alt-ganho">R$ 0,00</strong></p>
            </div>
          </div>
          <div class="text-xs text-indigo-700 dark:text-indigo-300">
            Diferen√ßa entre cen√°rios: <strong id="simulador-diferenca-valor">R$ 0,00</strong> em valor acumulado e <strong id="simulador-diferenca-ganho">R$ 0,00</strong> em ganhos.
          </div>
        </div>
      </div>
      <form id="form-investimento" class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
        <select id="investimento-tipo" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" required>
          <option value="reserva">Reserva de emerg√™ncia</option>
          <option value="renda_fixa">Renda fixa</option>
          <option value="acoes">A√ß√µes/Fundos</option>
          <option value="cripto">Cripto</option>
          <option value="outros">Outros</option>
        </select>
        <input id="investimento-valor" type="number" step="0.01" min="0.01" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Valor aplicado (R$)" required />
        <input id="investimento-data" type="date" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" required />
        <input id="investimento-desc" type="text" class="px-3 py-2 border rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Observa√ß√£o (opcional)" />
        <button type="submit" class="sm:col-span-2 bg-indigo-600 dark:bg-indigo-700 text-white px-3 py-2 rounded hover:bg-indigo-700 dark:hover:bg-indigo-800 transition">Adicionar investimento</button>
      </form>
      <div>
        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Aplica√ß√µes recentes</h4>
        <div id="investimentos-lista" class="space-y-2 max-h-48 overflow-y-auto text-sm">
          <div class="text-gray-500 dark:text-gray-400">Nenhum investimento registrado.</div>
        </div>
      </div>
    </div>

    <!-- NOVO: Indicador de sa√∫de financeira -->
    <div class="mobile-panel hidden lg:block section-card space-y-4" id="painel-saude-financeira">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-lg flex items-center gap-2"><i class="fa fa-heartbeat text-rose-500"></i>Sa√∫de Financeira</h3>
        <span class="text-sm font-semibold text-rose-600 dark:text-rose-300" id="saude-score">--</span>
      </div>
      <div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
          <div id="saude-progress" class="h-3 rounded-full bg-rose-500 transition-all duration-300" style="width:0%"></div>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="saude-status">Cadastre entradas e gastos para calcular sua sa√∫de financeira.</p>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm">
        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded">
          <div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Saldo projetado</div>
          <div class="text-lg font-bold text-gray-800 dark:text-gray-100" id="saude-detalhes-saldo">R$ 0,00</div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded">
          <div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Entradas do m√™s</div>
          <div class="text-lg font-bold text-gray-800 dark:text-gray-100" id="saude-detalhes-renda">R$ 0,00</div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded">
          <div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Proje√ß√£o investimentos</div>
          <div class="text-lg font-bold text-gray-800 dark:text-gray-100" id="saude-investimento-extra">R$ 0,00</div>
        </div>
      </div>
    </div>

    <!-- FIXOS recorrentes LIST - MELHORADO -->
    <div class="mobile-panel hidden lg:block section-card" id="painel-fixos">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Fixos recorrentes</h3>
        <div class="flex gap-2">
          <button id="btn-graficos-fixos" class="text-sm bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-200 px-2 py-1 rounded hover:bg-blue-200 dark:hover:bg-blue-900/40 transition-colors">
            <i class="fa fa-chart-pie mr-1"></i>Gr√°ficos
          </button>
          <button id="add-fixo-open" class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 transition-colors">Novo fixo</button>
        </div>
      </div>

      <!-- Resumo visual dos fixos -->
      <div class="grid grid-cols-2 gap-2 mb-4">
        <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded">
          <div class="text-xs text-green-700 dark:text-green-200">Ativos</div>
          <div class="font-bold text-green-800 dark:text-green-400" id="resumo-fixos-ativos">R$ 0,00</div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded">
          <div class="text-xs text-gray-700 dark:text-gray-300">Inativos</div>
          <div class="font-bold text-gray-800 dark:text-gray-100" id="resumo-fixos-inativos">R$ 0,00</div>
        </div>
      </div>

      <div class="overflow-y-auto max-h-80">
        <div id="fixos-loading-spinner" class="loading-spinner spinner-hidden">
          <i class="fa fa-spinner fa-spin"></i> Carregando fixos...
        </div>
        <div id="fixos-cards-container" class="space-y-2">
          <!-- Cards de fixos ser√£o inseridos aqui -->
        </div>
      </div>
    </div>

    <!-- CART√ïES compact - MOVIDO PARA DEPOIS DOS FIXOS -->
    <div class="mobile-panel hidden lg:block section-card" id="painel-cartoes">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Cart√µes</h3>
        <button id="btn-gerenciar-cartoes" class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 transition-colors">Gerenciar Cart√µes</button>
      </div>
      <div id="cartoes-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div id="cartoes-loading-spinner" class="loading-spinner spinner-hidden col-span-full">
          <i class="fa fa-spinner fa-spin"></i> Carregando cart√µes...
        </div>
        <!-- Cards de cart√£o ser√£o inseridos aqui -->
      </div>
    </div>

    <!-- NOVO: Modal para Gerenciar Cart√µes -->
<div id="modal-gerenciar-cartoes" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-11/12 max-w-md mx-auto relative shadow-lg modal-content max-h-[90vh] overflow-y-auto">
    <button id="modal-gerenciar-cartoes-close" class="absolute top-3 right-3 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-2xl font-bold" aria-label="Fechar modal">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Gerenciar Cart√µes</h2>

    <!-- Formul√°rio para Adicionar Novo Cart√£o -->
    <div class="mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
      <h3 class="font-semibold mb-3 text-gray-800 dark:text-gray-100">Adicionar Novo Cart√£o</h3>
      <form id="form-add-cartao" class="space-y-3">
        <div>
          <label for="novo-cartao-label" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Nome de Exibi√ß√£o (ex: Nubank, Ita√∫)</label>
          <input type="text" id="novo-cartao-label" name="label" required class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Nome amig√°vel"/>
        </div>
        <div>
          <label for="novo-cartao-fechamento" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Dia de Fechamento (1-31, opcional)</label>
          <input type="number" id="novo-cartao-fechamento" name="fechamento" min="1" max="31" class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Ex: 15"/>
        </div>
        <button type="submit" class="w-full bg-blue-600 dark:bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-700 dark:hover:bg-blue-800 transition">Adicionar Cart√£o</button>
         <div>
    <label for="novo-cartao-offset" class="block font-medium mb-1 text-gray-800 dark:text-gray-100">Offset de Vencimento</label>
    <select id="novo-cartao-offset" name="offset" class="w-full border rounded px-3 py-2 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-600">
      <option value="0">Mesmo M√™s (ex: Ita√∫, Nubank)</option>
      <option value="1" selected>Pr√≥ximo M√™s (ex: Univ, Amazon)</option>
    </select>
    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">0: Vencimento no mesmo m√™s da fatura. 1: Vencimento no m√™s seguinte.</p>
  </div>
  
      </form>
    </div>

    <!-- Lista de Cart√µes Existentes -->
    <div class="mb-4">
      <h3 class="font-semibold mb-3 text-gray-800 dark:text-gray-100">Cart√µes Existentes</h3>
      <div id="lista-cartoes-existentes" class="space-y-2">
        <!-- Cart√µes ser√£o inseridos aqui via JS -->
        <div class="text-gray-500 dark:text-gray-400">Nenhum cart√£o adicionado ainda.</div>
      </div>
    </div>
  </div>
</div>


    <!-- a√ß√µes r√°pidas - MOVIDO PARA O FINAL DA ASIDE -->
    <div class="section-card text-sm">
      <div class="font-semibold mb-2">A√ß√µes r√°pidas</div>
      <button id="exportar-tudo" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 px-3 py-2 rounded mb-2 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">Exportar tudo (CSV)</button>
      <div class="text-xs text-gray-500 dark:text-gray-400">Notas: exportar m√™s filtra s√≥ o m√™s selecionado; exportar tudo pega tudo.</div>
    </div>

  </aside>
</main>

<!-- Barra de a√ß√µes inferior com atalhos diretos -->
<div id="floating-menu" class="fixed inset-x-0 bottom-0 z-50 flex justify-center">
  <div class="relative w-full max-w-md px-4 pb-4">
    <nav class="floating-btn-transition relative bg-white/95 dark:bg-gray-900/90 border border-gray-200 dark:border-gray-700 shadow-2xl rounded-full px-4 py-3 flex items-end justify-between gap-2 pointer-events-auto backdrop-blur">
      <div class="pointer-events-none absolute inset-x-12 top-2 mx-auto h-1 rounded-full bg-gradient-to-r from-blue-200 via-blue-400 to-blue-200 opacity-60 dark:from-blue-900 dark:via-blue-600 dark:to-blue-900"></div>
      <button id="btn-add-gasto-variavel"
        class="group flex-1 flex flex-col items-center gap-1 text-[0.7rem] font-semibold text-blue-700 dark:text-blue-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 dark:focus-visible:ring-blue-700"
        type="button" aria-label="Adicionar gasto vari√°vel">
        <span class="flex h-11 w-11 items-center justify-center rounded-full bg-blue-600 text-white shadow-lg transition-transform group-hover:-translate-y-0.5 dark:bg-blue-700">
          <i class="fa fa-shopping-cart text-lg"></i>
        </span>
        Vari√°vel
      </button>
      <button id="btn-add-gasto-fixo"
        class="group flex-1 flex flex-col items-center gap-1 text-[0.7rem] font-semibold text-purple-700 dark:text-purple-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-purple-400 dark:focus-visible:ring-purple-600"
        type="button" aria-label="Adicionar gasto fixo">
        <span class="flex h-11 w-11 items-center justify-center rounded-full bg-purple-600 text-white shadow-lg transition-transform group-hover:-translate-y-0.5 dark:bg-purple-700">
          <i class="fa fa-calendar text-lg"></i>
        </span>
        Fixo
      </button>
      <button id="btn-add-gasto-parcelado"
        class="group flex-1 flex flex-col items-center gap-1 text-[0.7rem] font-semibold text-indigo-700 dark:text-indigo-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 dark:focus-visible:ring-indigo-600"
        type="button" aria-label="Adicionar gasto parcelado">
        <span class="flex h-11 w-11 items-center justify-center rounded-full bg-indigo-600 text-white shadow-lg transition-transform group-hover:-translate-y-0.5 dark:bg-indigo-700">
          <i class="fa fa-file-invoice-dollar text-lg"></i>
        </span>
        Parcelado
      </button>
      <div class="relative flex-1 flex justify-center" data-quick-income-container>
        <button id="btn-quick-entradas" type="button"
          class="group flex flex-col items-center gap-1 text-[0.7rem] font-semibold text-emerald-700 dark:text-emerald-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400 dark:focus-visible:ring-emerald-700"
          aria-label="A√ß√µes de entrada e investimento" aria-haspopup="true" aria-expanded="false">
          <span class="flex h-10 w-10 items-center justify-center rounded-full bg-emerald-50 dark:bg-emerald-900/40 text-emerald-600 dark:text-emerald-300 shadow-sm transition-transform group-hover:-translate-y-0.5">
            <i class="fa fa-piggy-bank text-lg"></i>
          </span>
          Entr./Inv.
        </button>
        <div id="quick-income-menu" class="hidden absolute bottom-16 left-1/2 w-44 -translate-x-1/2 rounded-2xl border border-emerald-100 dark:border-emerald-900/40 bg-white/95 dark:bg-gray-900/95 shadow-2xl backdrop-blur p-2 text-[0.72rem] font-semibold text-emerald-700 dark:text-emerald-200 z-10">
          <span class="pointer-events-none absolute -bottom-2 left-1/2 block h-3 w-3 -translate-x-1/2 rotate-45 bg-white dark:bg-gray-900 border-r border-b border-emerald-100 dark:border-emerald-900/40"></span>
          <button type="button" data-income-action="entrada" class="flex w-full items-center gap-2 rounded-lg px-3 py-2 text-left transition hover:bg-emerald-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400 dark:hover:bg-emerald-900/30">
            <i class="fa fa-circle-plus text-sm"></i>
            Nova entrada
          </button>
          <button type="button" data-income-action="investimento" class="mt-1 flex w-full items-center gap-2 rounded-lg px-3 py-2 text-left transition hover:bg-emerald-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400 dark:hover:bg-emerald-900/30">
            <i class="fa fa-arrow-trend-up text-sm"></i>
            Novo investimento
          </button>
        </div>
      </div>
    </nav>
    <div class="mt-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 pointer-events-none select-none">
      Ferramentas r√°pidas
    </div>
  </div>
</div>

<script>
// Dark Mode Toggle (Detecta sistema + salva prefer√™ncia)
const html = document.documentElement;
const toggleBtn = document.getElementById('toggleDark');

function initDarkMode() {
  if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    html.classList.add('dark');
  } else {
    html.classList.remove('dark');
  }
  // Atualiza √≠cone do bot√£o
  if (toggleBtn) {
    toggleBtn.innerHTML = html.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
  }
}

if (toggleBtn) {
  toggleBtn.addEventListener('click', () => {
    html.classList.toggle('dark');
    localStorage.theme = html.classList.contains('dark') ? 'dark' : 'light';
    toggleBtn.innerHTML = html.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
  });
}

initDarkMode(); // Inicializa ao carregar

// Registro SW (limpo, como antes)
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js")
    .then((registration) => {
      console.log("‚úÖ Service Worker registrado com sucesso:", registration.scope);
    })
    .catch((err) => {
      console.error("‚ùå Erro ao registrar SW:", err);
    });
} else {
  console.log("‚ùå Service Workers n√£o suportados neste navegador.");
}
</script>

<!-- NOVO: Toast Message para feedback -->
<div id="toast-message" class="hidden"></div>

<footer class="text-center text-sm text-gray-500 dark:text-gray-400 py-6">¬© 2025 Organizador Financeiro <br> Vitor Barbosa</br></footer>

<!-- Firebase compat scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/* ===========================
   CONFIG FIREBASE (sua config)
   =========================== */
const firebaseConfig = {
  apiKey: "AIzaSyCpBfq801WlkxgHhWwORDvnKWpXGXz3k4c",
  authDomain: "organizacao-financeira1.firebaseapp.com",
  projectId: "organizacao-financeira1",
  storageBucket: "organizacao-financeira1.firebasestorage.app",
  messagingSenderId: "896359450111",
  appId: "1:896359450111:web:bd8d7c2f2e35d4f27a93ca",
  measurementId: "G-58ZVECNK3B"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const googleAuthProvider = new firebase.auth.GoogleAuthProvider();
googleAuthProvider.setCustomParameters({ prompt: 'select_account' });
const authEnvironment = {
  isFileProtocol: window.location.protocol === 'file:',
  host: window.location.host,
};
const messaging = firebase.messaging(); // Inicializa o Messaging

let currentUser = null;
let appBootstrapped = false;
let workspaceInitialized = false;

function requireAuthContext() {
  if (!currentUser) {
    throw new Error('A√ß√£o requer usu√°rio autenticado.');
  }
}

function userRootRef() {
  requireAuthContext();
  return db.collection('users').doc(currentUser.uid);
}

function userCollectionRef(name) {
  return userRootRef().collection(name);
}

function userDocRef(collectionName, docId) {
  return userCollectionRef(collectionName).doc(docId);
}

async function detectLegacyData() {
  const [gastosSnap, parceladosSnap, entradasSnap, investimentosSnap, fixosSnap, limitesSnap] = await Promise.all([
    db.collection('gastos').limit(1).get().catch(() => null),
    db.collection('parcelados').limit(1).get().catch(() => null),
    db.collection('entradas').limit(1).get().catch(() => null),
    db.collection('investimentos').limit(1).get().catch(() => null),
    db.collection('fixos').limit(1).get().catch(() => null),
    db.collection('limites').doc('conta_unica').get().catch(() => null),
  ]);

  return Boolean(
    (gastosSnap && !gastosSnap.empty) ||
    (parceladosSnap && !parceladosSnap.empty) ||
    (entradasSnap && !entradasSnap.empty) ||
    (investimentosSnap && !investimentosSnap.empty) ||
    (fixosSnap && !fixosSnap.empty) ||
    (limitesSnap && limitesSnap.exists)
  );
}

async function migrateLegacyData(user) {
  const collectionNames = ['gastos', 'parcelados', 'entradas', 'investimentos', 'fixos'];

  for (const name of collectionNames) {
    try {
      const snapshot = await db.collection(name).get();
      if (snapshot.empty) continue;
      const targetCollection = userCollectionRef(name);
      for (const doc of snapshot.docs) {
        const data = doc.data() || {};
        if (data.ownerUid && data.ownerUid !== user.uid) continue;
        await targetCollection.doc(doc.id).set({ ...data, ownerUid: user.uid }, { merge: true });
      }
    } catch (err) {
      console.error(`Erro ao migrar cole√ß√£o legacy ${name}:`, err);
    }
  }

  try {
    const limitesSnap = await db.collection('limites').doc('conta_unica').get();
    if (limitesSnap.exists) {
      await userDocRef('limites', 'conta_unica').set(limitesSnap.data(), { merge: true });
    }
  } catch (err) {
    console.error('Erro ao migrar limites legacy:', err);
  }

  try {
    const cartoesSnap = await db.collection('config').doc('cartoes').get();
    if (cartoesSnap.exists) {
      await userDocRef('config', 'cartoes').set(cartoesSnap.data(), { merge: true });
    }
  } catch (err) {
    console.error('Erro ao migrar configura√ß√£o de cart√µes legacy:', err);
  }
}

async function ensureUserWorkspace(user) {
  if (!user) return;

  try {
    const workspaceDocRef = userRootRef().collection('metadata').doc('workspace');
    const workspaceSnap = await workspaceDocRef.get();
    if (workspaceSnap.exists && workspaceSnap.data()?.initialized) {
      workspaceInitialized = true;
      return;
    }

    const legacyMarkerRef = db.collection('metadata').doc('legacy_migration');
    const markerSnap = await legacyMarkerRef.get().catch(() => null);
    let shouldMigrate = false;

    if (markerSnap && markerSnap.exists) {
      const markerData = markerSnap.data() || {};
      if (markerData.migratedBy === user.uid && !markerData.completed) {
        shouldMigrate = true;
      }
    } else {
      const hasLegacyData = await detectLegacyData();
      if (hasLegacyData) {
        shouldMigrate = window.confirm('Encontramos dados existentes antes da autentica√ß√£o. Deseja vincul√°-los √† sua conta?');
        if (shouldMigrate) {
          await legacyMarkerRef.set({
            migratedBy: user.uid,
            startedAt: firebase.firestore.Timestamp.now()
          }, { merge: true });
        }
      }
    }

    if (shouldMigrate) {
      await migrateLegacyData(user);
      await legacyMarkerRef.set({
        migratedBy: user.uid,
        migratedAt: firebase.firestore.Timestamp.now(),
        completed: true
      }, { merge: true });
    }

    await workspaceDocRef.set({
      initialized: true,
      updatedAt: firebase.firestore.Timestamp.now(),
      migrated: shouldMigrate
    }, { merge: true });

    workspaceInitialized = true;
  } catch (err) {
    console.error('Erro ao preparar workspace do usu√°rio:', err);
  }
}

const authOverlay = document.getElementById('auth-overlay');
const authForm = document.getElementById('auth-form');
const authToggleMode = document.getElementById('auth-toggle-mode');
const authError = document.getElementById('auth-error');
const authSubmit = document.getElementById('auth-submit');
const authTitle = document.getElementById('auth-title');
const authDescription = document.getElementById('auth-description');
const authEmailInput = document.getElementById('auth-email');
const authPasswordInput = document.getElementById('auth-password');
const authGoogleButton = document.getElementById('auth-google');
const authGoogleLabel = authGoogleButton?.querySelector('[data-label]') || null;
const authGoogleHelper = document.getElementById('auth-google-helper');
const authGoogleHostTarget = authGoogleHelper?.querySelector('[data-google-host]') || null;
if (authGoogleHostTarget) {
  const hostLabel = authEnvironment.host || window.location.host || window.location.hostname || 'seu dom√≠nio';
  authGoogleHostTarget.textContent = hostLabel;
}
const defaultGoogleHelperHtml = authGoogleHelper ? authGoogleHelper.innerHTML : '';
const userSession = document.getElementById('user-session');
const userEmailBadge = document.getElementById('user-email-badge');
const signOutButton = document.getElementById('btn-signout');

let authMode = 'signIn';
let googleLoading = false;

function showGoogleHelper(messageHtml = defaultGoogleHelperHtml) {
  if (!authGoogleHelper) return;
  authGoogleHelper.innerHTML = messageHtml || defaultGoogleHelperHtml;
  authGoogleHelper.classList.remove('hidden');
}

function hideGoogleHelper() {
  if (!authGoogleHelper) return;
  authGoogleHelper.innerHTML = defaultGoogleHelperHtml;
  authGoogleHelper.classList.add('hidden');
}

function updateAuthModeUI() {
  if (authMode === 'signIn') {
    authTitle.textContent = 'Acessar sua conta';
    authDescription.textContent = 'Fa√ßa login para carregar seus dados financeiros salvos.';
    authSubmit.textContent = 'Entrar';
    authToggleMode.textContent = 'Criar uma nova conta';
    authPasswordInput.autocomplete = 'current-password';
  } else {
    authTitle.textContent = 'Criar uma nova conta';
    authDescription.textContent = 'Cadastre-se para ter seu espa√ßo financeiro protegido.';
    authSubmit.textContent = 'Cadastrar e acessar';
    authToggleMode.textContent = 'J√° tenho conta';
    authPasswordInput.autocomplete = 'new-password';
  }
}

function showAuthOverlay() {
  updateAuthModeUI();
  authError.classList.add('hidden');
  authError.textContent = '';
  authOverlay.classList.remove('hidden');
  document.body.classList.add('overflow-hidden');
}

function hideAuthOverlay() {
  authOverlay.classList.add('hidden');
  document.body.classList.remove('overflow-hidden');
  authError.classList.add('hidden');
  authError.textContent = '';
}

function setAuthLoading(isLoading) {
  authSubmit.disabled = isLoading;
  authToggleMode.disabled = isLoading;
  authEmailInput.disabled = isLoading;
  authPasswordInput.disabled = isLoading;
  if (authGoogleButton && !googleLoading) {
    authGoogleButton.disabled = isLoading;
    authGoogleButton.classList.toggle('opacity-60', isLoading);
    authGoogleButton.classList.toggle('cursor-not-allowed', isLoading);
  }
  authSubmit.textContent = isLoading
    ? (authMode === 'signIn' ? 'Entrando...' : 'Criando conta...')
    : (authMode === 'signIn' ? 'Entrar' : 'Cadastrar e acessar');
}

function setGoogleLoading(isLoading) {
  if (!authGoogleButton) return;
  googleLoading = isLoading;
  authGoogleButton.disabled = isLoading;
  authGoogleButton.classList.toggle('opacity-60', isLoading);
  authGoogleButton.classList.toggle('cursor-not-allowed', isLoading);
  if (authGoogleLabel) {
    authGoogleLabel.textContent = isLoading ? 'Conectando...' : 'Entrar com Google';
  }
}

function mapAuthErrorMessage(error) {
  if (!error || !error.code) return 'N√£o foi poss√≠vel concluir a opera√ß√£o. Tente novamente.';
  switch (error.code) {
    case 'auth/email-already-in-use':
      return 'Este e-mail j√° est√° cadastrado.';
    case 'auth/invalid-email':
      return 'Informe um e-mail v√°lido.';
    case 'auth/weak-password':
      return 'A senha precisa ter ao menos 6 caracteres.';
    case 'auth/user-not-found':
    case 'auth/wrong-password':
      return 'E-mail ou senha inv√°lidos.';
    case 'auth/too-many-requests':
      return 'Muitas tentativas. Aguarde alguns instantes e tente novamente.';
    case 'auth/popup-closed-by-user':
    case 'auth/cancelled-popup-request':
      return 'Login com Google cancelado. Tente novamente.';
    case 'auth/popup-blocked':
      return 'Seu navegador bloqueou a janela do Google. Permita pop-ups e tente novamente.';
    case 'auth/operation-not-supported-in-this-environment':
      return 'Este navegador n√£o suporta o login com Google nesta janela. Tente novamente em outra guia ou dispositivo.';
    case 'auth/unauthorized-domain': {
      const host = authEnvironment.host || window.location.hostname || 'este dom√≠nio';
      return `Autorize "${host || 'este dom√≠nio'}" em Authentication ‚Üí Settings ‚Üí Authorized domains no Console do Firebase.`;
    }
    case 'auth/account-exists-with-different-credential':
      return 'J√° existe uma conta com este e-mail usando outro m√©todo de acesso. Entre com ele e vincule o Google nas configura√ß√µes.';
    default:
      return 'Erro inesperado. Verifique seus dados e tente novamente.';
  }
}

function updateUserSessionUI(user) {
  if (!userSession) return;
  if (user) {
    userEmailBadge.textContent = user.email || 'Conta';
    userSession.classList.remove('hidden');
  } else {
    userSession.classList.add('hidden');
    userEmailBadge.textContent = '';
  }
}

async function handleUserSignedIn(user) {
  currentUser = user;
  updateUserSessionUI(user);
  hideAuthOverlay();
  await ensureUserWorkspace(user);
  if (!appBootstrapped) {
    boot();
    appBootstrapped = true;
  } else {
    carregarEnvelopes();
    startObservers();
  }
}

function handleUserSignedOut() {
  currentUser = null;
  workspaceInitialized = false;
  updateUserSessionUI(null);
  showAuthOverlay();
}

function initAuthFlow() {
  updateAuthModeUI();
  showAuthOverlay();

  authToggleMode.addEventListener('click', () => {
    authMode = authMode === 'signIn' ? 'signUp' : 'signIn';
    updateAuthModeUI();
  });

  if (authGoogleButton && authEnvironment.isFileProtocol) {
    authGoogleButton.disabled = true;
    authGoogleButton.classList.add('opacity-60', 'cursor-not-allowed');
    showGoogleHelper('Abra o app usando <strong>http://localhost</strong> ou publique em um dom√≠nio autorizado para usar o Google.');
  } else if (!authEnvironment.isFileProtocol) {
    hideGoogleHelper();
  }

  authForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const email = authEmailInput.value.trim();
    const password = authPasswordInput.value.trim();
    if (!email || !password) {
      authError.textContent = 'Informe e-mail e senha v√°lidos.';
      authError.classList.remove('hidden');
      return;
    }

    setAuthLoading(true);
    authError.classList.add('hidden');
    authError.textContent = '';

    try {
      if (authMode === 'signIn') {
        await auth.signInWithEmailAndPassword(email, password);
      } else {
        await auth.createUserWithEmailAndPassword(email, password);
      }
      authForm.reset();
    } catch (error) {
      console.error('Erro na autentica√ß√£o:', error);
      authError.textContent = mapAuthErrorMessage(error);
      authError.classList.remove('hidden');
    } finally {
      setAuthLoading(false);
    }
  });

  if (authGoogleButton && !authEnvironment.isFileProtocol) {
    authGoogleButton.addEventListener('click', async () => {
      authError.classList.add('hidden');
      authError.textContent = '';
      hideGoogleHelper();
      setAuthLoading(true);
      setGoogleLoading(true);

      let attemptedRedirect = false;

      try {
        await auth.signInWithPopup(googleAuthProvider);
      } catch (error) {
        if (error?.code === 'auth/popup-blocked' || error?.code === 'auth/operation-not-supported-in-this-environment') {
          try {
            attemptedRedirect = true;
            await auth.signInWithRedirect(googleAuthProvider);
            return;
          } catch (redirectError) {
            attemptedRedirect = false;
            error = redirectError;
          }
        }

        if (error?.code === 'auth/popup-closed-by-user' || error?.code === 'auth/cancelled-popup-request') {
          authError.textContent = mapAuthErrorMessage(error);
          authError.classList.remove('hidden');
        } else if (error?.code === 'auth/unauthorized-domain') {
          const host = authEnvironment.host || window.location.hostname || 'este dom√≠nio';
          showGoogleHelper(`Inclua <strong>${host}</strong> em Authentication ‚Üí Settings ‚Üí Authorized domains no Console do Firebase para liberar o login com Google.`);
          authError.textContent = mapAuthErrorMessage(error);
          authError.classList.remove('hidden');
        } else if (error) {
          console.error('Erro ao entrar com Google:', error);
          authError.textContent = mapAuthErrorMessage(error);
          authError.classList.remove('hidden');
        }
      } finally {
        if (!attemptedRedirect) {
          setGoogleLoading(false);
          setAuthLoading(false);
        }
      }
    });
  }

  if (signOutButton) {
    signOutButton.addEventListener('click', async () => {
      try {
        await auth.signOut();
        window.location.reload();
      } catch (error) {
        console.error('Erro ao sair:', error);
        showToast('N√£o foi poss√≠vel encerrar a sess√£o. Tente novamente.', 'error');
      }
    });
  }

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      await handleUserSignedIn(user);
    } else {
      handleUserSignedOut();
    }
  });
}

/* ===========================
   UTIL
   =========================== */
const moeda = v => (Number(v)||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const pct = (a,b)=> b? Math.max(0,Math.min(100,(a/b)*100)) : 0;
const yyyymm = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
const mmYYYY = key => { const [y,m]=key.split('-'); return `${m}/${y}`; };
const addMonths = (d,n) => new Date(d.getFullYear(), d.getMonth()+n, 1);
const monthDiff = (dStart,dEnd) => (dEnd.getFullYear()-dStart.getFullYear())*12 + (dEnd.getMonth()-dStart.getMonth());
const formatDate = value => {
  const date = value instanceof Date ? value : new Date(value);
  if (Number.isNaN(date.getTime())) return '-';
  return date.toLocaleDateString('pt-BR');
};
const formatDateInputValue = (value = new Date()) => {
  const date = value instanceof Date ? value : new Date(value);
  if (Number.isNaN(date.getTime())) return '';
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${date.getFullYear()}-${month}-${day}`;
};

const capitalize = (str = '') => str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
const isPlainObject = value => value && typeof value === 'object' && !Array.isArray(value);
const deepMerge = (target = {}, source = {}) => {
  const output = { ...target };
  if (!isPlainObject(source)) {
    return { ...target, ...(source || {}) };
  }
  Object.keys(source).forEach(key => {
    const sourceValue = source[key];
    if (isPlainObject(sourceValue)) {
      output[key] = deepMerge(isPlainObject(target[key]) ? target[key] : {}, sourceValue);
    } else {
      output[key] = sourceValue;
    }
  });
  return output;
};

// Para personalizar rapidamente sem editar este arquivo, defina window.__APP_CONFIG__
// antes deste script ser carregado (ex.: em um arquivo config.js) e sobrescreva apenas
// os campos desejados. O objeto abaixo cont√©m os valores padr√£o utilizados na aplica√ß√£o.
const baseAppConfig = {
  envelopes: {
    fixo: { chaveResumo: 'fixosMes', meta: 1300, reservado: 0, titulo: 'Custo fixo' },
    parcelado: { chaveResumo: 'parcelasMes', meta: 1400, reservado: 0, titulo: 'Parcelados do m√™s' },
    variavel: { chaveResumo: 'historicoMes', meta: 2000, reservado: 0, titulo: 'Vari√°veis' },
  },
  cartoes: {
    pix: { fechamento: null, label: 'PIX', mesVencimentoOffset: 0 },
  },
  insights: {
    maxVisible: 5,
    toggleLabels: {
      showMore: 'Mostrar mais insights',
      showLess: 'Ocultar insights extras',
    },
  },
  investimentos: {
    simulador: {
      defaultTaxaMensalPercent: 1,
      defaultPeriodoMeses: 12,
    },
  },
  charts: {
    historicoMensal: {
      monthsWindow: 12,
      barColorStops: ['rgba(56, 189, 248, 0.65)', 'rgba(14, 165, 233, 0.25)'],
      barBorderColor: '#0ea5e9',
      acumuladoColor: '#6366f1',
      mediaColor: '#f97316',
    },
    parceladosProjecao: {
      monthsWindow: 6,
      barColor: 'rgba(129, 140, 248, 0.55)',
      borderColor: '#7c3aed',
    },
  },
};

const appConfig = deepMerge(baseAppConfig, window.__APP_CONFIG__ || {});
const MAX_INSIGHTS_VISIBLE = appConfig.insights?.maxVisible ?? 5;
const INSIGHTS_TOGGLE_LABELS = {
  showMore: appConfig.insights?.toggleLabels?.showMore || 'Mostrar mais insights',
  showLess: appConfig.insights?.toggleLabels?.showLess || 'Ocultar insights extras',
};
const SIMULADOR_DEFAULT_TAXA = appConfig.investimentos?.simulador?.defaultTaxaMensalPercent ?? 1;
const SIMULADOR_DEFAULT_PERIODO = appConfig.investimentos?.simulador?.defaultPeriodoMeses ?? 12;
const HISTORICO_MENSAL_CHART_CFG = appConfig.charts?.historicoMensal || {};
const PARCELADOS_PROJECAO_CHART_CFG = appConfig.charts?.parceladosProjecao || {};

function goToPanelAndFocus(panelId, inputSelector) {
  if (!panelId) return;
  const mobileTab = document.querySelector(`[data-panel-target="${panelId}"]`);
  if (mobileTab && window.innerWidth < 1024) {
    mobileTab.click();
  }

  const panel = document.getElementById(panelId);
  if (panel) {
    panel.scrollIntoView({ behavior: 'smooth', block: window.innerWidth < 1024 ? 'start' : 'center' });
  }

  if (inputSelector) {
    const input = document.querySelector(inputSelector);
    if (input) {
      setTimeout(() => {
        if (typeof input.focus === 'function') {
          try {
            input.focus({ preventScroll: true });
          } catch (err) {
            input.focus();
          }
        }
      }, 320);
    }
  }
}

// NOVO: Fun√ß√£o para calcular o m√™s de refer√™ncia da fatura
function calcularMesFatura(dataTransacao, diaFechamento, offset = 0) {  // Adicionado offset com default 0
  const data = new Date(dataTransacao);
  const ano = data.getFullYear();
  const mes = data.getMonth(); // 0-11
  if (diaFechamento === null || diaFechamento === undefined) {
    // Para PIX ou sem fechamento: sempre m√™s atual
    return yyyymm(new Date(ano, mes, 1));
  }
  if (data.getDate() > diaFechamento) {
    // Ap√≥s fechamento: adiciona o offset (0 = mesmo m√™s; 1 = pr√≥ximo)
    return yyyymm(new Date(ano, mes + offset, 1));
  } else {
    // Antes/na data de fechamento: m√™s atual
    return yyyymm(new Date(ano, mes, 1));
  }
}

// Fun√ß√£o para mostrar toast message
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast-message');
  
  // Define √≠cone baseado no tipo
  let icon = '';
  switch(type) {
    case 'success': icon = '‚úÖ '; break;
    case 'error': icon = '‚ùå '; break;
    case 'warning': icon = '‚ö†Ô∏è '; break;
    case 'info': icon = '‚ÑπÔ∏è '; break;
    default: icon = '‚úÖ '; break;
  }
  
  toast.textContent = icon + message;
  toast.className = 'show'; // Remove 'hidden' e adiciona 'show'
  
  // Define cor baseada no tipo
  switch(type) {
    case 'error':
      toast.style.backgroundColor = '#dc2626'; // red-600
      break;
    case 'warning':
      toast.style.backgroundColor = '#d97706'; // amber-600
      break;
    case 'info':
      toast.style.backgroundColor = '#2563eb'; // blue-600
      break;
    default:
      toast.style.backgroundColor = '#059669'; // green-600
      break;
  }
  
  setTimeout(() => {
    toast.classList.remove('show');
    toast.classList.add('hidden'); // Esconde ap√≥s a transi√ß√£o
  }, 3000); // Esconde ap√≥s 3 segundos
}

// Vari√°veis e fun√ß√£o para o modal de confirma√ß√£o customizado
const modalConfirmacao = document.getElementById('modal-confirmacao');
const modalConfirmacaoTitle = document.getElementById('modal-confirmacao-title');
const modalConfirmacaoMessage = document.getElementById('modal-confirmacao-message');
const btnCancelarConfirmacao = document.getElementById('btn-cancelar-confirmacao');
const btnConfirmarAcao = document.getElementById('btn-confirmar-acao');

let confirmCallback = null; // Vari√°vel para armazenar a fun√ß√£o a ser executada na confirma√ß√£o

function abrirModalConfirmacao(title, message, callback, modalOrigemId = null) {
  fecharTodosOsModais(); // <--- NOVO: Fecha todos os outros modais antes de abrir a confirma√ß√£o
  modalConfirmacaoTitle.textContent = title;
  modalConfirmacaoMessage.textContent = message;
  confirmCallback = callback; // Armazena o callback
  modalConfirmacao.classList.remove('hidden');
  updateFloatingMenuVisibility(); // Esconde o menu flutuante se estiver aberto
}

function fecharModalConfirmacao() {
  modalConfirmacao.classList.add('hidden');
  confirmCallback = null; // Limpa o callback
  
  // Se havia um modal anterior, reabre-o
  if (modalAnteriorAberto) {
    document.getElementById(modalAnteriorAberto).classList.remove('hidden');
    modalAnteriorAberto = null; // Limpa a refer√™ncia
  }
  updateFloatingMenuVisibility(); // Mostra o menu flutuante novamente
}

// Event listeners para o modal de confirma√ß√£o
btnCancelarConfirmacao.addEventListener('click', fecharModalConfirmacao);
btnConfirmarAcao.addEventListener('click', () => {
  if (confirmCallback) {
    confirmCallback(); // Executa a fun√ß√£o de confirma√ß√£o
  }
  fecharModalConfirmacao();
});

// Fechar modal ao clicar fora
modalConfirmacao.addEventListener('click', (e) => {
  if (e.target === modalConfirmacao) {
    fecharModalConfirmacao();
  }
});

// Fechar modal com ESC
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && !modalConfirmacao.classList.contains('hidden')) {
    fecharModalConfirmacao();
  }
});


/* ===========================
   ESTADO/CONFIGURA√á√ïES
   =========================== */
const envelopeConfig = {
  fixo: { ...baseAppConfig.envelopes.fixo, ...(appConfig.envelopes?.fixo || {}) },
  parcelado: { ...baseAppConfig.envelopes.parcelado, ...(appConfig.envelopes?.parcelado || {}) },
  variavel: { ...baseAppConfig.envelopes.variavel, ...(appConfig.envelopes?.variavel || {}) },
};
let envelopes = {
  fixo: { ...envelopeConfig.fixo },
  parcelado: { ...envelopeConfig.parcelado },
  variavel: { ...envelopeConfig.variavel },
}; // persisted in Firestore
const cartoesCfgDefault = { ...baseAppConfig.cartoes, ...(appConfig.cartoes || {}) };
let cartoesCfg = {...cartoesCfgDefault};

/* caches */
let mesesDisponiveis = new Set(); // Meses com gastos (para filtro geral)
let mesesParceladosColetados = new Set(); // Meses que cont√™m parcelados (do in√≠cio ao fim, para filtro geral)
let allFixosDocs = []; // NOVO: Cache global dos documentos de fixos
let mesesEntradasDisponiveis = new Set();
let mesesInvestimentosDisponiveis = new Set();
let allEntradasDocs = [];
let allInvestimentosDocs = [];

const painelFinanceiroState = {
  entradasMes: 0,
  entradasTotais: 0,
  investimentosMes: 0,
  investimentosTotais: 0,
  investimentosProjetados: 0,
  totalGastosMes: 0,
};
let resumoFinanceiroAtual = {
  entradasMes: 0,
  totalGastosMes: 0,
  saldoProjetado: 0,
  ganhoInvest: 0,
};

/* resumo */
const resumo = {historicoMes:0, cartoesMes:0, pixMes:0, parcelasMes:0, fixosMes:0}; // MODIFICADO: Renomeado caixaAcumulado para saldoTotalAcumulado

/* NOVO: Sistema de Tags Inteligente */
let allTags = new Set(); // Cache de todas as tags existentes
let selectedTagsArray = []; // Tags selecionadas no modal
let currentSearchTerm = ''; // Termo de busca atual
let currentGroupBy = ''; // Agrupamento atual

/* NOVO: Vari√°vel para controle de scroll */
let lastScrollTop = 0;

/* ===========================
   NOVO: SISTEMA DE TAGS INTELIGENTE
   =========================== */
function initTagsSystem() {
  const tagsInput = document.getElementById('modal-tags');
  const tagsSuggestions = document.getElementById('tags-suggestions');
  const selectedTagsContainer = document.getElementById('selected-tags');

  // Carrega tags existentes do Firestore
  loadExistingTags();

  // Event listeners para o sistema de tags
  tagsInput.addEventListener('input', (e) => {
    const value = e.target.value.toLowerCase().trim();
    if (value.length > 0) {
      showTagSuggestions(value);
    } else {
      hideTagSuggestions();
    }
  });

  tagsInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ',') {
      e.preventDefault();
      const tag = e.target.value.trim();
      if (tag) {
        addTag(tag);
        e.target.value = '';
        hideTagSuggestions();
      }
    }
  });

  // Clica fora para esconder sugest√µes
  document.addEventListener('click', (e) => {
    if (!tagsInput.contains(e.target) && !tagsSuggestions.contains(e.target)) {
      hideTagSuggestions();
    }
  });
}

function loadExistingTags() {
  userCollectionRef('gastos').get().then(snapshot => {
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      if (data.tags && Array.isArray(data.tags)) {
        data.tags.forEach(tag => allTags.add(tag.toLowerCase()));
      }
    });
  });
}

function showTagSuggestions(searchTerm) {
  const suggestions = Array.from(allTags).filter(tag => 
    tag.includes(searchTerm) && !selectedTagsArray.includes(tag)
  );
  
  const container = document.getElementById('tags-suggestions');
  container.innerHTML = '';
  
  if (suggestions.length > 0) {
    suggestions.slice(0, 5).forEach(tag => {
      const div = document.createElement('div');
      div.className = 'tag-suggestion';
      div.textContent = tag;
      div.addEventListener('click', () => {
        addTag(tag);
        document.getElementById('modal-tags').value = '';
        hideTagSuggestions();
      });
      container.appendChild(div);
    });
    container.classList.remove('hidden');
  } else {
    hideTagSuggestions();
  }
}

function hideTagSuggestions() {
  document.getElementById('tags-suggestions').classList.add('hidden');
}

function addTag(tagText) {
  const tag = tagText.toLowerCase().trim();
  if (tag && !selectedTagsArray.includes(tag)) {
    selectedTagsArray.push(tag);
    allTags.add(tag); // Adiciona √† lista global
    renderSelectedTags();
  }
}

function removeTag(tag) {
  selectedTagsArray = selectedTagsArray.filter(t => t !== tag);
  renderSelectedTags();
}

function renderSelectedTags() {
  const container = document.getElementById('selected-tags');
  container.innerHTML = '';
  
  selectedTagsArray.forEach(tag => {
    const pill = document.createElement('span');
    pill.className = 'tag-pill removable';
    pill.innerHTML = `${tag} <span class="remove-tag" onclick="removeTag('${tag}')">&times;</span>`;
    container.appendChild(pill);
  });
}

/* ===========================
   NOVO: BUSCA E AGRUPAMENTO NO HIST√ìRICO
   =========================== */
function initHistoricoSearch() {
  const searchInput = document.getElementById('search-historico');
  const groupBySelect = document.getElementById('group-by-historico');
  const clearButton = document.getElementById('clear-search');

  searchInput.addEventListener('input', (e) => {
    currentSearchTerm = e.target.value.toLowerCase().trim();
    renderHistoricoWithFilters();
  });

  groupBySelect.addEventListener('change', (e) => {
    currentGroupBy = e.target.value;
    renderHistoricoWithFilters();
  });

  clearButton.addEventListener('click', () => {
    searchInput.value = '';
    groupBySelect.value = '';
    currentSearchTerm = '';
    currentGroupBy = '';
    renderHistoricoWithFilters();
  });
}

 // Remove tela de carregamento ap√≥s load
  window.addEventListener("load", () => {
    const loading = document.getElementById("loading-screen");
    if (loading) {
      loading.style.opacity = "0";
      setTimeout(() => loading.remove(), 500); // fade-out
    }
  });
  
function renderHistoricoWithFilters() {
  const tbody = document.getElementById('transactions-list');
  tbody.innerHTML = '';
  
  const mesSel = document.getElementById('filtro-mes').value || yyyymm(new Date());
  
  let filteredDocs = allGastosDocs.filter(doc => {
    const d = doc.data();
    if (!d.data) return false;
    const keyTransacao = yyyymm(d.data.toDate ? d.data.toDate() : new Date(d.data));
    const keyFatura = d.mesFatura || keyTransacao; // Usa mesFatura para filtragem

    // Filtro por m√™s
    if (mesSel !== 'all' && keyFatura !== mesSel) return false; // Filtra por mesFatura
    
    // Filtro por busca
    if (currentSearchTerm) {
      const desc = (d.descricao || '').toLowerCase();
      const tags = (d.tags || []).join(' ').toLowerCase();
      if (!desc.includes(currentSearchTerm) && !tags.includes(currentSearchTerm)) {
        return false;
      }
    }
    
    return true;
  });

    if (filteredDocs.length === 0) {
      tbody.innerHTML = '<tr><td class="td" colspan="8">Nenhum gasto encontrado</td></tr>';
      return;
    }
    
  // Agrupamento
    if (currentGroupBy === 'cartao') {
      renderHistoricoGroupedByCartao(filteredDocs);
    } else if (currentGroupBy) {
      renderHistoricoGrouped(filteredDocs, currentGroupBy);
    } else {
      renderHistoricoNormal(filteredDocs);
    }
    
}

function renderHistoricoNormal(docs) {
  const tbody = document.getElementById('transactions-list');
  
  docs.forEach(doc => {
    const d = doc.data();
    const id = doc.id;
    const dt = d.data.toDate ? d.data.toDate() : new Date(d.data);
    const mesFaturaDisplay = d.mesFatura ? mmYYYY(d.mesFatura) : '-';
    
    // Renderiza tags
    const tagsHtml = (d.tags || []).map(tag => 
      `<span class="tag-pill" style="font-size: 0.6rem; padding: 0.125rem 0.25rem;">${tag}</span>`
    ).join('');
    
    // Destaca termo de busca
    let descricao = d.descricao || '';
    if (currentSearchTerm) {
      const regex = new RegExp(`(${currentSearchTerm})`, 'gi');
      descricao = descricao.replace(regex, '<span class="search-highlight">$1</span>');
    }
    
      const tr = document.createElement('tr');
          tr.innerHTML = `
      <td class="td">${(cartoesCfg[d.cartao] && cartoesCfg[d.cartao].label) || d.cartao || ''}</td>
      <td class="td">${descricao}</td>
      <td class="td">R$ ${moeda(d.valor)}</td>
      <td class="td">${dt.toLocaleDateString('pt-BR')}</td>
      <td class="td">${mesFaturaDisplay}</td>
      <td class="td">${d.tipo}</td>
      <td class="td">
        <div class="flex flex-wrap gap-1">${tagsHtml}</div>
      </td>
      <td class="td">
        <button class="text-blue-600 dark:text-blue-400 edit-gasto mr-2 hover:text-blue-800 dark:hover:text-blue-200" data-id="${id}" aria-label="Editar gasto">
          <i class="fa fa-edit"></i>
        </button>
        <button class="text-red-600 dark:text-red-400 delete-gasto hover:text-red-800 dark:hover:text-red-200" data-id="${id}" aria-label="Remover gasto">
          <i class="fa fa-trash"></i>
        </button>
      </td>
    `;
    
    
    tbody.appendChild(tr);
    
  });
}

function renderHistoricoGrouped(docs, groupBy) {
  const tbody = document.getElementById('transactions-list');
  const groups = {};

  // Agrupa os documentos
  docs.forEach(doc => {
    const d = doc.data();
    let groupKey = 'Outros'; // Default group key

    switch (groupBy) {
      case 'categoria':
        groupKey = d.categoria || 'Sem categoria';
        break;
      case 'cartao': // Este caso j√° √© tratado por renderHistoricoGroupedByCartao, mas mantido para completude
        groupKey = d.cartao || 'Sem cart√£o';
        break;
      case 'tag':
        groupKey = (d.tags && d.tags.length > 0) ? d.tags[0] : 'Sem tags';
        break;
    }

    if (!groups[groupKey]) {
      groups[groupKey] = [];
    }
    groups[groupKey].push(doc);
  });

  // Renderiza grupos
  Object.keys(groups).sort().forEach(groupKey => {
    const totalGroup = groups[groupKey].reduce((sum, doc) => sum + (doc.data().valor || 0), 0);
    const isCollapsed = collapsedGroups[groupKey] || false;
    const iconClass = isCollapsed ? 'fa-chevron-right' : 'fa-chevron-down';

    // Cabe√ßalho do grupo
    const groupHeader = document.createElement('tr');
    groupHeader.className = 'group-header cursor-pointer bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors';
    groupHeader.dataset.groupKey = groupKey;
    groupHeader.setAttribute('role', 'button');
    groupHeader.setAttribute('tabindex', '0');
    groupHeader.setAttribute('aria-expanded', !isCollapsed);
    groupHeader.innerHTML = `
      <td colspan="8" class="td font-semibold text-gray-800 dark:text-gray-100">
        <i class="fa ${iconClass} mr-2 group-toggle-icon"></i>
        ${groupKey.charAt(0).toUpperCase() + groupKey.slice(1)} ‚Äî Total: R$ ${moeda(totalGroup)}
      </td>
    `;
    tbody.appendChild(groupHeader);

    // Itens do grupo
    groups[groupKey].forEach(doc => {
      const d = doc.data();
      const id = doc.id;
      const dt = d.data.toDate ? d.data.toDate() : new Date(d.data);
      const mesFaturaDisplay = d.mesFatura ? mmYYYY(d.mesFatura) : '-';

      const tagsHtml = (d.tags || []).map(tag =>
        `<span class="tag-pill" style="font-size: 0.6rem; padding: 0.125rem 0.25rem;">${tag}</span>`
      ).join('');

      let descricao = d.descricao || '';
      if (currentSearchTerm) {
        const regex = new RegExp(`(${currentSearchTerm})`, 'gi');
        descricao = descricao.replace(regex, '<span class="search-highlight">$1</span>');
      }

      const tr = document.createElement('tr');
      tr.className = `group-item ${isCollapsed ? 'hidden' : ''}`; // Adiciona classe 'hidden' se o grupo estiver colapsado
      tr.dataset.groupKey = groupKey; // Adiciona data-group-key para os itens
      tr.innerHTML = `
        <td class="td">${(cartoesCfg[d.cartao] && cartoesCfg[d.cartao].label) || d.cartao || ''}</td>
        <td class="td">${descricao}</td>
        <td class="td">R$ ${moeda(d.valor)}</td>
        <td class="td">${dt.toLocaleDateString('pt-BR')}</td>
        <td class="td">${mesFaturaDisplay}</td>
        <td class="td">${d.tipo}</td>
        <td class="td">
          <div class="flex flex-wrap gap-1">${tagsHtml}</div>
        </td>
        <td class="td">
          <button class="text-blue-600 dark:text-blue-400 edit-gasto mr-2 hover:text-blue-800 dark:hover:text-blue-200" data-id="${id}" aria-label="Editar gasto">
            <i class="fa fa-edit"></i>
          </button>
          <button class="text-red-600 dark:text-red-400 delete-gasto hover:text-red-800 dark:hover:text-red-200" data-id="${id}" aria-label="Remover gasto">
            <i class="fa fa-trash"></i>
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  });
}

// Vari√°veis para o modal de gerenciamento de cart√µes
const modalGerenciarCartoes = document.getElementById('modal-gerenciar-cartoes');
const modalGerenciarCartoesClose = document.getElementById('modal-gerenciar-cartoes-close');
const btnGerenciarCartoes = document.getElementById('btn-gerenciar-cartoes');
const formAddCartao = document.getElementById('form-add-cartao');
const listaCartoesExistentes = document.getElementById('lista-cartoes-existentes');

/* ===========================
   PERSIST√äNCIA: ENVELOPES
   =========================== */
function cloneEnvelopeDefaults() {
  return {
    fixo: { ...envelopeConfig.fixo },
    parcelado: { ...envelopeConfig.parcelado },
    variavel: { ...envelopeConfig.variavel },
  };
}

function normalizarEnvelopesDoc(data = {}) {
  const base = cloneEnvelopeDefaults();
  ['fixo', 'parcelado', 'variavel'].forEach(tipo => {
    const entrada = data[tipo];
    if (typeof entrada === 'number') {
      base[tipo].meta = Math.max(0, Number(entrada) || 0);
    } else if (entrada && typeof entrada === 'object') {
      if ('meta' in entrada || 'teto' in entrada) {
        const metaVal = entrada.meta ?? entrada.teto;
        base[tipo].meta = Math.max(0, Number(metaVal) || 0);
      }
      if ('reservado' in entrada || 'reserva' in entrada) {
        const reservaVal = entrada.reservado ?? entrada.reserva;
        base[tipo].reservado = Math.max(0, Number(reservaVal) || 0);
      }
    }
  });
  return base;
}

function getEnvelopeGastoAtual(tipo) {
  const chaveResumo = envelopeConfig[tipo]?.chaveResumo;
  return chaveResumo ? Number(resumo[chaveResumo] || 0) : 0;
}

function getEnvelopeMeta(tipo) {
  return Number(envelopes[tipo]?.meta || 0);
}

function calcularResumoEnvelopes() {
  const tipos = ['fixo', 'parcelado', 'variavel'];
  return tipos.reduce((acc, tipo) => {
    const meta = getEnvelopeMeta(tipo);
    const gastoAtual = getEnvelopeGastoAtual(tipo);
    const reservado = Number(envelopes[tipo]?.reservado || 0);
    const margem = Math.max(0, meta - gastoAtual - reservado);

    acc.totalMeta += meta;
    acc.totalGasto += gastoAtual;
    acc.totalReservado += reservado;
    acc.totalMargem += margem;

    return acc;
  }, { totalMeta: 0, totalGasto: 0, totalReservado: 0, totalMargem: 0 });
}

function atualizarInputsEnvelopes() {
  ['fixo', 'parcelado', 'variavel'].forEach(tipo => {
    const metaInput = document.getElementById(`envelope-${tipo}-meta`);
    const reservaInput = document.getElementById(`envelope-${tipo}-reserva`);
    if (metaInput && metaInput.dataset.userEdited !== 'true') {
      metaInput.value = envelopes[tipo]?.meta ?? 0;
    }
    if (reservaInput && reservaInput.dataset.userEdited !== 'true') {
      reservaInput.value = envelopes[tipo]?.reservado ?? 0;
    }
  });
}

function atualizarBarrasVisuais(){
  ['fixo', 'parcelado', 'variavel'].forEach(tipo => {
    atualizarBarra(tipo, getEnvelopeGastoAtual(tipo));
  });

  const resumoEnvelopes = calcularResumoEnvelopes();
  const formatar = valor => (Number(valor) || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  const metaTotalEl = document.getElementById('overview-meta-total');
  if (metaTotalEl) metaTotalEl.textContent = formatar(resumoEnvelopes.totalMeta);

  const reservadoTotalEl = document.getElementById('overview-reservado-total');
  if (reservadoTotalEl) reservadoTotalEl.textContent = formatar(resumoEnvelopes.totalReservado);

  const margemTotalEl = document.getElementById('overview-margem-total');
  if (margemTotalEl) margemTotalEl.textContent = formatar(resumoEnvelopes.totalMargem);

  const modalMetaEl = document.getElementById('overview-modal-meta');
  if (modalMetaEl) modalMetaEl.textContent = formatar(resumoEnvelopes.totalMeta);

  const modalGastoEl = document.getElementById('overview-modal-gasto');
  if (modalGastoEl) modalGastoEl.textContent = formatar(resumoEnvelopes.totalGasto);

  const modalReservadoEl = document.getElementById('overview-modal-reservado');
  if (modalReservadoEl) modalReservadoEl.textContent = formatar(resumoEnvelopes.totalReservado);

  const modalMargemEl = document.getElementById('overview-modal-margem');
  if (modalMargemEl) modalMargemEl.textContent = formatar(resumoEnvelopes.totalMargem);

  window.__ultimoResumoEnvelopes = resumoEnvelopes;
}

function carregarEnvelopes(){
  if (!currentUser) return;
  userDocRef('limites', 'conta_unica').get().then(doc=>{
    envelopes = normalizarEnvelopesDoc(doc.exists ? doc.data() : {});
    atualizarInputsEnvelopes();
    atualizarBarrasVisuais();
    gerarInsights();
  });
}

function salvarEnvelope(tipo, novosValores, mensagem = 'Envelope atualizado com sucesso!') {
  if (!envelopes[tipo]) envelopes[tipo] = { ...envelopeConfig[tipo] };
  const meta = Math.max(0, Number(novosValores.meta ?? envelopes[tipo].meta) || 0);
  const reservado = Math.max(0, Number(novosValores.reservado ?? envelopes[tipo].reservado) || 0);
  envelopes[tipo] = { ...envelopes[tipo], meta, reservado };
  atualizarInputsEnvelopes();
  atualizarBarrasVisuais();
  gerarInsights();

  const payload = {
    [tipo]: {
      meta,
      reservado,
    }
  };

  return userDocRef('limites', 'conta_unica').set(payload, { merge: true })
    .then(() => showToast(mensagem))
    .catch(err => {
      console.error('Erro ao salvar envelope', err);
      showToast('Erro ao salvar envelope.', 'error');
    });
}

function reservarSaldoDisponivel(tipo) {
  const meta = Number(envelopes[tipo]?.meta) || 0;
  const gasto = getEnvelopeGastoAtual(tipo);
  const reservadoAtual = Number(envelopes[tipo]?.reservado) || 0;
  const disponivel = Math.max(0, meta - gasto - reservadoAtual);
  if (disponivel <= 0) {
    showToast('N√£o h√° saldo dispon√≠vel para reservar neste envelope.', 'warning');
    return Promise.resolve();
  }
  return salvarEnvelope(tipo, { reservado: reservadoAtual + disponivel }, 'Reserva atualizada!');
}

function limparReservaEnvelope(tipo) {
  if ((Number(envelopes[tipo]?.reservado) || 0) === 0) {
    showToast('Nenhuma reserva para liberar.', 'info');
    return Promise.resolve();
  }
  return salvarEnvelope(tipo, { reservado: 0 }, 'Reserva liberada!');
}

function reservarSobrasAutomatico() {
  const acoes = ['fixo', 'parcelado', 'variavel'].map(reservarSaldoDisponivel);
  return Promise.all(acoes).then(() => atualizarBarrasVisuais());
}

function limparReservasAutomatico() {
  const acoes = ['fixo', 'parcelado', 'variavel'].map(limparReservaEnvelope);
  return Promise.all(acoes).then(() => atualizarBarrasVisuais());
}

function abrirModalGerenciarCartoes() {
  modalGerenciarCartoes.classList.remove('hidden');
  renderListaCartoesExistentes(); // Renderiza a lista de cart√µes ao abrir
  updateFloatingMenuVisibility(); // Esconde o menu flutuante
}
function fecharModalGerenciarCartoes() {
  modalGerenciarCartoes.classList.add('hidden');
  formAddCartao.reset(); // Limpa o formul√°rio
  updateFloatingMenuVisibility(); // Mostra o menu flutuante
}

function renderListaCartoesExistentes() {
  listaCartoesExistentes.innerHTML = '';
  const cartoesAtuais = Object.keys(cartoesCfg).filter(key => key !== 'pix'); 
  if (cartoesAtuais.length === 0) {
    listaCartoesExistentes.innerHTML = '<div class="text-gray-500 dark:text-gray-400">Nenhum cart√£o adicionado ainda.</div>';
    return;
  }
  cartoesAtuais.forEach(key => {
    const cfg = cartoesCfg[key];
    const cardItem = document.createElement('div');
    cardItem.className = 'flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg';
    cardItem.innerHTML = `
      <div>
        <div class="font-semibold text-gray-800 dark:text-gray-100">${cfg.label}</div> <!-- MODIFICADO AQUI: Removido o (key) -->
        <div class="text-sm text-gray-600 dark:text-gray-300">
          Fechamento: ${cfg.fechamento !== null ? cfg.fechamento : 'N/A'}
          <button class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 ml-2" onclick="editarFechamentoCartao('${key}')" title="Editar Dia de Fechamento">
            <i class="fa fa-pencil-alt"></i>
          </button>
        </div>
      </div>
      <button class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-200" onclick="removerCartao('${key}')" title="Remover Cart√£o">
        <i class="fa fa-trash"></i>
      </button>
      <button class="text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-200 ml-2" onclick="editarOffsetCartao('${key}')" title="Editar Offset de Vencimento">
      <i class="fa fa-calendar-alt"></i>
    </button>
    
    `;
    listaCartoesExistentes.appendChild(cardItem);
  });
}

   // Fun√ß√£o nova para editar offset
    function editarOffsetCartao(key) {
      const cfg = cartoesCfg[key] || { mesVencimentoOffset: 1 };
      const novoOffset = prompt(`Offset de vencimento para ${cfg.label} (0 = mesmo m√™s, 1 = pr√≥ximo m√™s):`, cfg.mesVencimentoOffset);
      if (novoOffset === null) return;
      const val = parseInt(novoOffset);
      if (isNaN(val) || val < 0 || val > 1) {
        showToast('Offset inv√°lido. Use 0 ou 1.', 'error');
        return;
      }
      cartoesCfg[key] = { ...cfg, mesVencimentoOffset: val };
      userDocRef('config', 'cartoes').set(cartoesCfg, { merge: true })
        .then(() => {
          showToast('Offset atualizado!');
          renderListaCartoesExistentes();
          startObservers();  // Recarrega para aplicar
        })
        .catch(err => showToast('Erro ao atualizar offset.', 'error'));
    }

function editarFechamentoCartao(key) {
  const cfg = cartoesCfg[key] || {label: key, fechamento: null}; // Garante que cfg exista
  const novoFechamento = prompt(`Digite o novo dia de fechamento para ${cfg.label} (1-31). Deixe vazio para remover:`, cfg.fechamento !== null ? String(cfg.fechamento) : '');
  if (novoFechamento === null) return; // Usu√°rio cancelou
  const val = novoFechamento.trim() === '' ? null : parseInt(novoFechamento);
  if (val !== null && (isNaN(val) || val < 1 || val > 31)) {
    showToast('Dia de fechamento inv√°lido. Use um n√∫mero entre 1 e 31 ou deixe vazio.', 'error');
    return;
  }
  // Atualiza a configura√ß√£o local
  cartoesCfg[key] = { ...cfg, fechamento: val };
  // Atualiza no Firestore
  userDocRef('config', 'cartoes').set(cartoesCfg, { merge: true })
    .then(() => {
      showToast('Dia de fechamento atualizado com sucesso!');
      renderListaCartoesExistentes(); // Atualiza a lista no modal de gerenciamento
      startObservers(); // Recarrega tudo para refletir a mudan√ßa
    })
    .catch(err => showToast('Erro ao atualizar dia de fechamento: ' + err.message, 'error'));
}

function removerCartao(idCartao) {
  abrirModalConfirmacao(
    'Remover Cart√£o',
    `Tem certeza que deseja remover o cart√£o "${cartoesCfg[idCartao].label}"? Todos os gastos associados a ele permanecer√£o, mas o cart√£o n√£o aparecer√° mais nas op√ß√µes.`,
    () => { // Callback de confirma√ß√£o
      // Remove o cart√£o da configura√ß√£o local
      // √â crucial criar uma C√ìPIA do objeto cartoesCfg para evitar problemas de refer√™ncia
      const novosCartoesCfg = { ...cartoesCfg }; 
      delete novosCartoesCfg[idCartao];
      // Atualiza no Firestore com o objeto MODIFICADO
      userDocRef('config', 'cartoes').set(novosCartoesCfg) // Use .set() para sobrescrever, n√£o .update()
        .then(() => {
          showToast('Cart√£o removido com sucesso!');
          // Atualiza a vari√°vel global cartoesCfg com a nova configura√ß√£o
          cartoesCfg = novosCartoesCfg; 
          
          // Fechar o modal de gerenciamento de cart√µes ap√≥s a remo√ß√£o bem-sucedida
          fecharModalGerenciarCartoes(); 
          
          // For√ßa uma atualiza√ß√£o completa para que os filtros e resumos reflitam a mudan√ßa
          // Isso √© importante para que os selects de cart√£o e os resumos sejam atualizados
          startObservers(); 
        })
        .catch(err => showToast('Erro ao remover cart√£o: ' + err.message, 'error'));
    },
    'modal-gerenciar-cartoes' // <--- NOVO: Passa o ID do modal de origem
  );
}

/* ===========================
   FIXOS (recorrentes) - MELHORADO
   =========================== */
function renderFixos(docs) {
  allFixosDocs = docs; // Atualiza o cache global

  // Renderiza√ß√£o melhorada com cards
  const container = document.getElementById('fixos-cards-container');
  container.innerHTML = '';
  
  let totalAtivos = 0;
  let totalInativos = 0;
  
  if (!docs.length) { 
    container.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-4">Sem fixos cadastrados</div>';
  } else {
    docs.forEach(doc => {
      const f = doc.data();
      const id = doc.id;
      const ativo = f.ativo !== false;
      
      if (ativo) {
        totalAtivos += (f.valor || 0);
      } else {
        totalInativos += (f.valor || 0);
      }
      
      const card = document.createElement('div');
      card.className = `fixo-card section-card p-3 ${ativo ? 'ativo' : 'inativo'}`;
      card.innerHTML = `
        <div class="flex justify-between items-start mb-2">
          <div class="flex-1">
            <div class="font-semibold text-sm">${f.nome || ''}</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">${f.categoria || 'outros'}</div>
            ${f.subcategoria ? `<div class="text-xs text-gray-400 dark:text-gray-500">${f.subcategoria}</div>` : ''}
          </div>
          <div class="text-right">
            <div class="font-bold text-sm">R$ ${moeda(f.valor)}</div>
            <div class="text-xs ${ativo ? 'text-green-600 dark:text-green-400' : 'text-gray-500 dark:text-gray-400'}">${ativo ? 'Ativo' : 'Inativo'}</div>
          </div>
        </div>
        <div class="flex justify-end gap-1">
          <button class="text-blue-600 dark:text-blue-400 text-xs hover:text-blue-800 dark:hover:text-blue-200" onclick="editarFixoPrompt('${id}')" title="Editar">
            <i class="fa fa-edit"></i>
          </button>
          <button class="text-red-600 dark:text-red-400 text-xs hover:text-red-800 dark:hover:text-red-200" onclick="removerFixo('${id}')" title="Remover">
            <i class="fa fa-trash"></i>
          </button>
          <button class="${ativo ? 'text-yellow-600 dark:text-yellow-400 hover:text-yellow-800 dark:hover:text-yellow-200' : 'text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-200'} text-xs" onclick="toggleAtivoFixo('${id}', ${ativo})" title="${ativo ? 'Desativar' : 'Ativar'}">
            <i class="fa ${ativo ? 'fa-pause' : 'fa-play'}"></i>
          </button>
        </div>
      `;
      container.appendChild(card);
    });
  }
  
  // Atualiza resumos
  document.getElementById('resumo-fixos-ativos').textContent = `R$ ${moeda(totalAtivos)}`;
  document.getElementById('resumo-fixos-inativos').textContent = `R$ ${moeda(totalInativos)}`;
}

function toggleAtivoFixo(id, atual) {
  userCollectionRef('fixos').doc(id).update({ ativo: !atual })
    .then(() => {
      showToast(`Gasto fixo ${!atual ? 'ativado' : 'desativado'} com sucesso!`);
      carregarFixos(); // Recarrega a lista para atualizar os bot√µes
    })
    .catch(() => {
      showToast('Erro ao atualizar o gasto fixo.', 'error');
    });
}

function carregarFixos() {
  userCollectionRef('fixos').orderBy('nome').get().then(snapshot => {
    renderFixos(snapshot.docs);
  });
}

        function removerFixo(id) {
          abrirModalConfirmacao(
            'Remover Gasto Fixo',
            'Tem certeza que deseja remover este gasto fixo? Esta a√ß√£o √© irrevers√≠vel.',
            () => { // Callback de confirma√ß√£o
              userCollectionRef('fixos').doc(id).delete()
                .then(() => showToast('Fixo removido com sucesso!'))
                .catch(err => showToast('Erro ao remover fixo.', 'error'));
            }
          );
        }
        

function editarFixoPrompt(id){
  userCollectionRef('fixos').doc(id).get().then(doc=>{
    if(!doc.exists) {
      showToast('Documento n√£o encontrado', 'error');
      return;
    }
    const d = doc.data();
    
    // Abre o modal com os dados para edi√ß√£o
    abrirModalFixo({
      id: id,
      nome: d.nome,
      categoria: d.categoria,
      subcategoria: d.subcategoria,
      valor: d.valor,
      ativo: d.ativo
    });
  });
}

document.getElementById('add-fixo-open').addEventListener('click', () => {
  abrirModalFixo();
});

// NOVO: Fun√ß√£o para popular os selects de cart√£o
function popularSelectCartoes() {
  const selectsCartao = document.querySelectorAll('#modal-cartao, #p-cartao'); 
  
  selectsCartao.forEach(select => {
    const valorAtual = select.value; 
    select.innerHTML = ''; 
    // Adiciona a op√ß√£o "PIX" primeiro
    const pixOption = document.createElement('option');
    pixOption.value = 'pix';
    pixOption.textContent = 'PIX';
    select.appendChild(pixOption);
    // Adiciona os outros cart√µes configurados
    const cartoesOrdenados = Object.keys(cartoesCfg).filter(key => key !== 'pix').sort((a, b) => {
      const labelA = (cartoesCfg[a]?.label || a).toLowerCase();
      const labelB = (cartoesCfg[b]?.label || b).toLowerCase();
      return labelA.localeCompare(labelB);
    });
    cartoesOrdenados.forEach(key => {
      const option = document.createElement('option');
      option.value = key; // O 'key' √© o ID gerado
      option.textContent = cartoesCfg[key].label; // O 'label' √© o nome amig√°vel
      select.appendChild(option);
    });
    // Adiciona a op√ß√£o "Nenhum" por √∫ltimo
    const nenhumOption = document.createElement('option');
    nenhumOption.value = '';
    nenhumOption.textContent = 'Nenhum';
    select.appendChild(nenhumOption);
    // Tenta restaurar o valor selecionado
    if (select.querySelector(`option[value="${valorAtual}"]`)) {
      select.value = valorAtual;
    } else {
      select.value = 'pix'; 
    }
  });
  atualizarMesFaturaEstimado(); 
}



// Event listeners para o modal de gerenciamento de cart√µes
btnGerenciarCartoes.addEventListener('click', abrirModalGerenciarCartoes);
modalGerenciarCartoesClose.addEventListener('click', fecharModalGerenciarCartoes);
modalGerenciarCartoes.addEventListener('click', (e) => {
  if (e.target === modalGerenciarCartoes) {
    fecharModalGerenciarCartoes();
  }
});

// Event listener para o formul√°rio de adicionar novo cart√£o
formAddCartao.addEventListener('submit', (e) => {
  e.preventDefault();
  // const id = document.getElementById('novo-cartao-id').value.toLowerCase().trim(); // REMOVER ESTA LINHA
  const label = document.getElementById('novo-cartao-label').value.trim();
  const fechamentoInput = document.getElementById('novo-cartao-fechamento').value;
  const fechamento = fechamentoInput ? parseInt(fechamentoInput) : null;
  // NOVO: Gerar o ID interno a partir do label
  // Remove espa√ßos, converte para min√∫sculas e remove caracteres especiais
  const id = label.toLowerCase().replace(/[^a-z0-9]/g, ''); 
  if (!label) { // Agora s√≥ precisamos validar o label
    showToast('O Nome do Cart√£o √© obrigat√≥rio.', 'error');
    return;
  }
  if (id === 'pix') {
    showToast('O nome "PIX" (ou similar) √© reservado e n√£o pode ser usado para um novo cart√£o.', 'error');
    return;
  }
  if (cartoesCfg[id]) {
    showToast(`J√° existe um cart√£o com o nome "${label}" (ID interno: ${id}). Por favor, use um nome √∫nico.`, 'error');
    return;
  }
  if (fechamento !== null && (isNaN(fechamento) || fechamento < 1 || fechamento > 31)) {
    showToast('Dia de fechamento inv√°lido. Use um n√∫mero entre 1 e 31 ou deixe vazio.', 'error');
    return;
  }
  const offset = parseInt(document.getElementById('novo-cartao-offset').value) || 1;  // <-- NOVO
  cartoesCfg[id] = { label, fechamento, mesVencimentoOffset: offset };  // <-- NOVO: Salva offset
  userDocRef('config', 'cartoes').set(cartoesCfg, { merge: true })
    .then(() => {
      showToast('Cart√£o adicionado com sucesso!');
      formAddCartao.reset();
      renderListaCartoesExistentes(); // Atualiza a lista no modal
      startObservers(); 
    })
    .catch(err => showToast('Erro ao adicionar cart√£o: ' + err.message, 'error'));
});



/* ===========================
   NOVO: GR√ÅFICOS DOS FIXOS
   =========================== */
let chartFixosCategoria = null;
let chartFixosImpacto = null;

function renderGraficosFixos() {
  if (!allFixosDocs || allFixosDocs.length === 0) {
    showToast('Nenhum gasto fixo encontrado para an√°lise.', 'error');
    return;
  }

  const fixosAtivos = allFixosDocs.filter(doc => doc.data().ativo !== false);
  const fixosInativos = allFixosDocs.filter(doc => doc.data().ativo === false);

  // Calcula totais
  const totalAtivos = fixosAtivos.reduce((sum, doc) => sum + (doc.data().valor || 0), 0);
  const totalInativos = fixosInativos.reduce((sum, doc) => sum + (doc.data().valor || 0), 0);

  // Atualiza totais no modal
  document.getElementById('total-fixos-ativos').textContent = `R$ ${moeda(totalAtivos)}`;
  document.getElementById('total-fixos-inativos').textContent = `R$ ${moeda(totalInativos)}`;

  // Gr√°fico por categoria (apenas fixos ativos)
  const categorias = {};
  fixosAtivos.forEach(doc => {
    const categoria = doc.data().categoria || 'Outros';
    categorias[categoria] = (categorias[categoria] || 0) + (doc.data().valor || 0);
  });

  renderGraficoFixosCategoria(categorias);
  renderGraficoFixosImpacto(fixosAtivos);
  renderDetalhesFixos(fixosAtivos);
}

function renderGraficoFixosCategoria(categorias) {
  const labels = Object.keys(categorias);
  const data = Object.values(categorias);

  const ctx = document.getElementById('grafico-fixos-categoria').getContext('2d');
  if (chartFixosCategoria) chartFixosCategoria.destroy();
  
  chartFixosCategoria = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        label: 'Fixos por Categoria',
        data,
        backgroundColor: [
          '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'
        ],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { 
          position: 'bottom',
          labels: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151' // Cor da legenda
          }
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const label = ctx.label || '';
              const value = ctx.parsed || 0;
              const total = ctx.dataset.data.reduce((a,b) => a+b, 0);
              const pct = total ? ((value / total) * 100).toFixed(1) : 0;
              return `${label}: R$ ${moeda(value)} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

function renderGraficoFixosImpacto(fixosAtivos) {
  const labels = fixosAtivos.map(doc => doc.data().nome || 'Sem nome');
  const data = fixosAtivos.map(doc => doc.data().valor || 0);
  const metaOrcamentoFixo = getEnvelopeMeta('fixo') || 0;
  const percentuais = data.map(valor => metaOrcamentoFixo ? (valor / metaOrcamentoFixo * 100).toFixed(1) : '0.0');

  const ctx = document.getElementById('grafico-fixos-impacto').getContext('2d');
  if (chartFixosImpacto) chartFixosImpacto.destroy();

  chartFixosImpacto = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Impacto no Or√ßamento (%)',
        data: percentuais,
        backgroundColor: data.map(valor => valor > (metaOrcamentoFixo * 0.2) ? '#ef4444' : '#10b981'),
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            callback: val => `${val}%`,
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151' // Cor dos ticks
          },
          grid: {
            color: html.classList.contains('dark') ? '#4b5563' : '#e5e7eb' // Cor da grid
          }
        },
        x: {
          ticks: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151' // Cor dos ticks
          },
          grid: {
            color: html.classList.contains('dark') ? '#4b5563' : '#e5e7eb' // Cor da grid
          }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.parsed.y}% do or√ßamento (R$ ${moeda(data[ctx.dataIndex])})`
          }
        }
      }
    }
  });
}

function renderDetalhesFixos(fixosAtivos) {
  const container = document.getElementById('detalhes-fixos');
  container.innerHTML = '';

  // Ordena por valor (maior primeiro)
  const ordenados = fixosAtivos.sort((a, b) => (b.data().valor || 0) - (a.data().valor || 0));

  ordenados.forEach(doc => {
    const f = doc.data();
    const percentual = metaOrcamentoFixo ? ((f.valor || 0) / metaOrcamentoFixo * 100).toFixed(1) : 0;
    const isAlto = metaOrcamentoFixo ? ((f.valor || 0) > (metaOrcamentoFixo * 0.2)) : false;

    const item = document.createElement('div');
    item.className = `flex justify-between items-center p-2 rounded ${isAlto ? 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700' : 'bg-gray-50 dark:bg-gray-700'}`;
    item.innerHTML = `
      <div class="flex-1">
        <div class="font-semibold text-sm">${f.nome || 'Sem nome'}</div>
        <div class="text-xs text-gray-500 dark:text-gray-400">${f.categoria || 'Outros'}${f.subcategoria ? ` ‚Ä∫ ${f.subcategoria}` : ''}</div>
      </div>
      <div class="text-right">
        <div class="font-bold ${isAlto ? 'text-red-600 dark:text-red-400' : 'text-gray-700 dark:text-gray-100'}">R$ ${moeda(f.valor)}</div>
        <div class="text-xs ${isAlto ? 'text-red-500 dark:text-red-300' : 'text-gray-500 dark:text-gray-400'}">${percentual}% do or√ßamento</div>
      </div>
    `;
    container.appendChild(item);
  });
}

// Event listeners para gr√°ficos dos fixos
document.getElementById('btn-graficos-fixos').addEventListener('click', () => {
  document.getElementById('modal-graficos-fixos').classList.remove('hidden');
  renderGraficosFixos();
});

document.getElementById('modal-graficos-fixos-close').addEventListener('click', () => {
  document.getElementById('modal-graficos-fixos').classList.add('hidden');
  if (chartFixosCategoria) {
    chartFixosCategoria.destroy();
    chartFixosCategoria = null;
  }
  if (chartFixosImpacto) {
    chartFixosImpacto.destroy();
    chartFixosImpacto = null;
  }
});

/* ===========================
   PARCELADOS - CORRIGIDO E MELHORADO
   =========================== */
function renderParcelados(docs){
  const tbody = document.getElementById('parcelados-list');
  tbody.innerHTML='';
  const scrollWrapper = document.getElementById('parcelados-table-wrapper');

  const mesKey = document.getElementById('filtro-mes').value;
  const hoje = new Date();
  const alvoKey = (mesKey === 'all' || !mesKey) ? yyyymm(hoje) : mesKey;
  const [ay,am] = alvoKey.split('-');
  let refDate = new Date(parseInt(ay), parseInt(am)-1, 1); // Data de refer√™ncia para o m√™s selecionado
  if (Number.isNaN(refDate.getTime())) {
    refDate = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
  }

  renderGraficoParceladosProjecao(docs, refDate);

  let totalMes=0, totalRestante=0, countAtivos=0;

  const filteredDocs = docs.filter(doc => {
    const p = doc.data();
    const inicio = p.dataInicio && p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio);
    const diff = monthDiff(inicio, refDate);
    const ativaNoMes = diff >= 0 && diff < p.numParcelas;
    
    return ativaNoMes;
  });

  if(!filteredDocs.length){
    tbody.innerHTML='<tr><td class="td" colspan="8">Nenhum parcelado para o m√™s selecionado</td></tr>';
    document.getElementById('p-total-mes').textContent = moeda(0);
    document.getElementById('p-total-restante').textContent = moeda(0);
    document.getElementById('p-ativos').textContent = String(0);
    atualizarBarra('parcelado', 0);
    resumo.parcelasMes = 0;
    if (scrollWrapper) {
      scrollWrapper.classList.remove('parcelados-scroll');
    }
    return;
  }

  filteredDocs.forEach(doc=>{
    const p = doc.data();
    const id = doc.id;
    const inicio = p.dataInicio && p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio);
    const fim = addMonths(inicio, p.numParcelas-1);

    // CORRE√á√ÉO: Calcula a parcela atual baseada no m√™s de refer√™ncia (filtro), n√£o na data atual
    const parcelaAtualIndex = Math.max(0, Math.min(p.numParcelas-1, monthDiff(inicio, refDate)));
    const parcelaAtual = parcelaAtualIndex + 1;
    const restantes = Math.max(0, p.numParcelas - parcelaAtual);
    const restanteValor = restantes * (p.valorParcela||0);
    const progressPercent = pct(parcelaAtual, p.numParcelas);

    // Determina o status do parcelado
    let status = 'ativo';
    let statusClass = 'parcelado-ativo';
    if (parcelaAtual >= p.numParcelas) {
      status = 'finalizado';
      statusClass = 'parcelado-finalizado';
    } else if (monthDiff(inicio, refDate) < 0) {
      status = 'futuro';
      statusClass = 'parcelado-futuro';
    }

    totalMes += (p.valorParcela||0);
    countAtivos++; 
    totalRestante += restanteValor; 

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="td">${p.descricao||''}</td>
      <td class="td">R$ ${moeda(p.valorParcela)}</td>
      <td class="td">
        <div class="flex items-center gap-2">
          <span class="text-sm font-semibold">${parcelaAtual}/${p.numParcelas}</span>
          <div class="flex-1">
            <div class="progress-parcelado">
              <div class="progress-parcelado-fill ${status === 'finalizado' ? 'progress-finalizado' : 'progress-ativo'}" style="width:${progressPercent}%"></div>
            </div>
          </div>
        </div>
      </td>
      <td class="td">
        <span class="parcelado-status ${statusClass}">
          ${status === 'ativo' ? 'Em andamento' : status === 'finalizado' ? 'Finalizado' : 'Futuro'}
        </span>
      </td>
      <td class="td">${p.cartao||''}</td>
      <td class="td">${mmYYYY(yyyymm(inicio))}</td>
      <td class="td">${mmYYYY(yyyymm(fim))}</td>
      <td class="td">
        <button class="text-blue-600 dark:text-blue-400 mr-2 hover:text-blue-800 dark:hover:text-blue-200" onclick="editarParceladoPrompt('${id}')" title="Editar">
          <i class="fa fa-edit"></i>
        </button>
        <button class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-200" onclick="removerParcelado('${id}')" title="Remover">
          <i class="fa fa-trash"></i>
        </button>
      </td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('p-total-mes').textContent = moeda(totalMes);
  document.getElementById('p-total-restante').textContent = moeda(totalRestante);
  document.getElementById('p-ativos').textContent = String(countAtivos);

  atualizarBarra('parcelado', totalMes);
  resumo.parcelasMes = totalMes;

  if (scrollWrapper) {
    scrollWrapper.classList.toggle('parcelados-scroll', filteredDocs.length > 7);
  }
}

function fecharTodosOsModais() {
  document.getElementById('modal-add-gasto').classList.add('hidden');
  document.getElementById('modal-fixo').classList.add('hidden');
  document.getElementById('modal-parcelado').classList.add('hidden');
  document.getElementById('modal-graficos').classList.add('hidden');
  document.getElementById('modal-graficos-fixos').classList.add('hidden');
  document.getElementById('modal-gerenciar-cartoes').classList.add('hidden');
}

function editarParceladoPrompt(id){
  userCollectionRef('parcelados').doc(id).get().then(doc=>{
    if(!doc.exists) {
      showToast('Parcelado n√£o encontrado', 'error');
      return;
    }
    const p = doc.data();
    
    // Abre o modal com os dados para edi√ß√£o
    abrirModalParcelado({
      id: id,
      descricao: p.descricao,
      valorParcela: p.valorParcela,
      numParcelas: p.numParcelas,
      cartao: p.cartao,
      dataInicio: p.dataInicio && p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio)
    });
  });
}



        function removerParcelado(id){ 
          abrirModalConfirmacao(
            'Remover Parcelado',
            'Tem certeza que deseja remover este parcelado? Esta a√ß√£o √© irrevers√≠vel.',
            () => { // Callback de confirma√ß√£o
              userCollectionRef('parcelados').doc(id).delete()
                .then(() => showToast('Parcelado removido com sucesso!'))
                .catch(err => showToast('Erro ao remover parcelado.', 'error'));
            }
          );
        }
        

/* ===========================
   CART√ïES (compact sidebar + edit fechamento)
   =========================== */
function renderCartoes(totaisPorCartao){
  const container=document.getElementById('cartoes-container'); container.innerHTML='';
  const hoje=new Date();
  
  const cartoesOrdenados = Object.keys(cartoesCfg).filter(k => k !== 'pix').sort((a, b) => {
    const labelA = (cartoesCfg[a]?.label || a).toLowerCase();
    const labelB = (cartoesCfg[b]?.label || b).toLowerCase();
    return labelA.localeCompare(labelB);
  });
  if (cartoesOrdenados.length === 0) {
    container.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 col-span-full py-4">Nenhum cart√£o configurado.</div>';
    return;
  }
  cartoesOrdenados.forEach(k=>{
    const cfg = cartoesCfg[k]||cartoesCfgDefault[k]||{label:k, fechamento:null};
    const tot = moeda(totaisPorCartao[k]||0);
    const fechamento = cfg.fechamento;
    
    let diasParaFechamento = null;
    let textoFechamento = 'Sem fechamento';
    let alertaClass = '';
    if (fechamento !== null && fechamento !== undefined) {
      const diaAtual = hoje.getDate();
      let dataFechamento = new Date(hoje.getFullYear(), hoje.getMonth(), fechamento);
      
      if (diaAtual > fechamento) {
        dataFechamento.setMonth(dataFechamento.getMonth() + 1);
      }
      
      const diffTime = Math.abs(dataFechamento.getTime() - hoje.getTime());
      diasParaFechamento = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      textoFechamento = `Fecha dia ${fechamento}`;
      if (diasParaFechamento <= 3 && diasParaFechamento >= 0) {
        textoFechamento += ` (em ${diasParaFechamento}d)`;
        alertaClass = 'text-red-600 dark:text-red-400 font-bold';
      } else if (diasParaFechamento < 0) {
        textoFechamento = `Fechou dia ${fechamento} (atrasado)`;
        alertaClass = 'text-red-600 dark:text-red-400 font-bold';
      }
    }
    
    const card = document.createElement('div');
    card.className = 'section-card p-3 border-l-4 border-blue-500 dark:border-blue-400';
    card.innerHTML = `
      <div class="flex justify-between items-center mb-1">
        <div class="text-gray-800 dark:text-gray-100 font-semibold">${cfg.label}</div>
        <div class="text-sm text-gray-500 dark:text-gray-400">${textoFechamento}</div>
      </div>
      <div class="text-lg font-bold ${alertaClass}">R$ ${tot}</div>
      <div class="mt-2 flex justify-end">
        <!-- MODIFICADO AQUI: O bot√£o "Editar" agora abre o modal de gerenciamento de cart√µes -->
        <button class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" onclick="abrirModalGerenciarCartoes()" title="Gerenciar este cart√£o">Editar</button>
      </div>`;
    container.appendChild(card);
  });
}

function editarFechamentoPrompt(key){
   if (key === 'pix') { // <- ADICIONE ESTA LINHA: Impede edi√ß√£o de fechamento para PIX
        showToast('PIX n√£o possui dia de fechamento.', 'info');
        return;
      }
  const cfg = cartoesCfg[key] || cartoesCfgDefault[key] || {fechamento:null};
  const novo = prompt('Dia de fechamento (n√∫mero, ex: 15) ‚Äî deixe vazio para remover:', cfg.fechamento!==null? String(cfg.fechamento):'');
  if(novo === null) return;
  const val = novo.trim()==='' ? null : parseInt(novo);
  if (val !== null && (isNaN(val) || val < 1 || val > 31)) {
    showToast('Dia de fechamento inv√°lido. Use um n√∫mero entre 1 e 31 ou deixe vazio.', 'error');
    return;
  }
  cartoesCfg[key] = {...(cartoesCfg[key]||{}), fechamento: val, label: (cartoesCfg[key] && cartoesCfg[key].label) || cartoesCfgDefault[key].label};
  userDocRef('config', 'cartoes').set(cartoesCfg, {merge:true})
    .then(() => showToast('Configura√ß√µes de cart√µes atualizadas!'))
    .catch(err => showToast('Erro ao atualizar configura√ß√µes de cart√µes.', 'error'));
}

/* ===========================
   HIST√ìRICO (gastos normais) + edi√ß√£o inline
   =========================== */
// REMOVIDO: renderHistorico (substitu√≠do por renderHistoricoWithFilters)

function editarGasto(id, campo, valor){
  const update = {}; update[campo] = campo==='valor' ? (parseFloat(valor)||0) : valor;
  userCollectionRef('gastos').doc(id).update(update)
    .then(() => showToast('Gasto atualizado!'))
    .catch(err => showToast('Erro ao atualizar gasto.', 'error'));
}

/* ===========================
   EXPORT CSV
   =========================== */
function exportarCSVmes(){
  const mesSel = document.getElementById('filtro-mes').value;
  userCollectionRef('gastos').orderBy('data','desc').get().then(snap=>{
    const linhas=[['Data Transa√ß√£o','M√™s Fatura','Tipo','Cart√£o/PIX','Descri√ß√£o','Valor','Categoria']];
    snap.forEach(doc=>{
      const d=doc.data();
      if(!d.data) return;
      const dt = d.data.toDate ? d.data.toDate() : new Date(d.data);
      const keyTransacao = yyyymm(dt);
      const keyFatura = d.mesFatura || keyTransacao; // Usa mesFatura para filtragem

      if(mesSel!=='all' && keyFatura!==mesSel) return; // Filtra por mesFatura
      linhas.push([dt.toLocaleDateString('pt-BR'), mmYYYY(keyFatura), d.tipo||'', d.cartao||'', (d.descricao||'').replace(/"/g,'""'), String(d.valor||0), d.categoria||'']);
    });
    const csv = linhas.map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download = (mesSel==='all' ? 'gastos_todos.csv' : `gastos_${mesSel}.csv`); a.click(); URL.revokeObjectURL(url);
    showToast('CSV do m√™s exportado!');
  }).catch(err => showToast('Erro ao exportar CSV do m√™s.', 'error'));
}
function exportarCSVtudo(){
  if (!currentUser) return;
  Promise.all([
    userCollectionRef('gastos').orderBy('data','desc').get(),
    userCollectionRef('parcelados').orderBy('dataInicio','desc').get(),
  ]).then(([gastoSnap, parcSnap])=>{ 
    let csv = 'Tipo,Data Transa√ß√£o,M√™s Fatura,Cart√£o/PIX,Descri√ß√£o,Valor,Parcelas,Observa√ß√£o,Categoria\n'; // MODIFICADO HEADER
    gastoSnap.forEach(doc=>{
      const d=doc.data(); 
      const dt = d.data.toDate? d.data.toDate() : new Date(d.data);
      const keyTransacao = yyyymm(dt);
      const keyFatura = d.mesFatura || keyTransacao;
      csv += `gasto,"${dt.toLocaleDateString('pt-BR')}","${mmYYYY(keyFatura)}","${d.cartao||''}","${(d.descricao||'').replace(/"/g,'""')}",${d.valor||0},1,,"${d.categoria||''}"\n`;
    });
    parcSnap.forEach(doc=>{
      const p=doc.data();
      csv += `parcelado,"${mmYYYY(yyyymm(p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio)))}","${mmYYYY(yyyymm(p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio)))}","${p.cartao||''}","${(p.descricao||'').replace(/"/g,'""')}",${p.valorParcela||0},${p.numParcelas},parcelado,\n`;
    });

    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='dados_financeiros_completos.csv'; a.click(); URL.revokeObjectURL(url); // MODIFICADO NOME DO ARQUIVO
    showToast('Todos os dados exportados para CSV!');
  }).catch(err => showToast('Erro ao exportar todos os dados para CSV.', 'error'));
}


/* ===========================
   ATUALIZA√á√ïES & SNAPSHOTS
   =========================== */

let unsubLimits, unsubFixos, unsubGastos, unsubParcelados, unsubConfig, unsubEntradas, unsubInvestimentos;
let allParceladosDocs = [];
let allGastosDocs = [];

// Fun√ß√µes para mostrar/ocultar spinners
function showSpinner(id) {
  const el = document.getElementById(id);
  if (el) el.classList.remove('spinner-hidden');
}
function hideSpinner(id) {
  const el = document.getElementById(id);
  if (el) el.classList.add('spinner-hidden');
}

function startObservers(){
  // Desinscrever observers antigos para evitar m√∫ltiplos listeners
  if (unsubLimits) unsubLimits();
  if (unsubConfig) unsubConfig();
  if (unsubFixos) unsubFixos();
  if (unsubGastos) unsubGastos();
  if (unsubParcelados) unsubParcelados();
  if (unsubEntradas) unsubEntradas();
  if (unsubInvestimentos) unsubInvestimentos();

  // Mostrar spinners antes de carregar os dados
  showSpinner('historico-loading-spinner');
  showSpinner('fixos-loading-spinner');
  showSpinner('parcelados-loading-spinner');
  showSpinner('cartoes-loading-spinner'); // Adicionado spinner para cart√µes

  if (!currentUser) return;

  unsubLimits = userDocRef('limites', 'conta_unica').onSnapshot(doc=>{
    envelopes = normalizarEnvelopesDoc(doc.exists ? doc.data() : {});
    atualizarInputsEnvelopes();
    atualizarBarrasVisuais();
    gerarInsights();
  }, err => {
    console.error("Erro ao carregar envelopes:", err);
    showToast('Erro ao carregar envelopes.', 'error');
  });

  unsubConfig = userDocRef('config', 'cartoes').onSnapshot(snap=>{
    if(snap.exists) cartoesCfg = {...cartoesCfgDefault, ...snap.data()};
    renderCartoes(window._totaisPorCartaoHistorico || {});
    popularSelectCartoes(); // <--- NOVO: Chama para atualizar os selects
    hideSpinner('cartoes-loading-spinner'); // Oculta spinner de cart√µes
  }, err => {
    console.error("Erro ao carregar configura√ß√µes de cart√µes:", err);
    showToast('Erro ao carregar configura√ß√µes de cart√µes.', 'error');
    hideSpinner('cartoes-loading-spinner');
  });

  unsubEntradas = userCollectionRef('entradas').orderBy('data','desc').onSnapshot(snap => {
    renderEntradasSidebar(snap.docs);
  }, err => {
    console.error('Erro ao carregar entradas:', err);
    showToast('Erro ao carregar entradas.', 'error');
  });

  unsubInvestimentos = userCollectionRef('investimentos').orderBy('data','desc').onSnapshot(snap => {
    renderInvestimentosSidebar(snap.docs);
  }, err => {
    console.error('Erro ao carregar investimentos:', err);
    showToast('Erro ao carregar investimentos.', 'error');
  });


  unsubFixos = userCollectionRef('fixos').orderBy('nome','asc').onSnapshot(snap=>{
    hideSpinner('fixos-loading-spinner'); // Oculta spinner de fixos
    allFixosDocs = snap.docs; // Garante que allFixosDocs seja atualizado
    renderFixos(snap.docs);
    atualizarTudoComParcelados(); // Recalcula totais ap√≥s fixos serem carregados
  }, err => {
    console.error("Erro ao carregar fixos:", err);
    hideSpinner('fixos-loading-spinner'); // Oculta spinner de fixos em caso de erro
    showToast('Erro ao carregar fixos.', 'error');
  });
  


  // === SE√á√ÉO CORRIGIDA: OBSERVER DE GASTOS ===
  unsubGastos = userCollectionRef('gastos').orderBy('data','desc').onSnapshot(snap=>{
    hideSpinner('historico-loading-spinner'); // Oculta spinner de hist√≥rico
    allGastosDocs = snap.docs; // ATUALIZA allGastosDocs AQUI

    const mesSel = document.getElementById('filtro-mes').value || yyyymm(new Date());
    
    let somaVariavel = 0;
    let somaFixoAvulso = 0;
    let totaisPorCartaoHist = {};
    let totaisPorCategoria = {}; // Objeto para armazenar totais por categoria

    mesesDisponiveis = new Set();
    const docsToProcessForMonth = [];
    allGastosDocs.forEach(doc=>{
      const d = doc.data();
      if(!d.data) return;
      const dt = d.data.toDate? d.data.toDate() : new Date(d.data);
      const keyTransacao = yyyymm(dt); // M√™s da transa√ß√£o
      const keyFatura = d.mesFatura || keyTransacao; // Usa mesFatura se existir, sen√£o usa m√™s da transa√ß√£o

      mesesDisponiveis.add(keyFatura); // Adiciona o m√™s da fatura aos meses dispon√≠veis

      if(mesSel === 'all' || keyFatura === mesSel) { // FILTRA POR mesFatura
        docsToProcessForMonth.push(doc);
        const tipo = (d.tipo || '').toLowerCase();
        if(tipo === 'variavel') somaVariavel += (d.valor || 0);
        if(tipo === 'fixo') somaFixoAvulso += (d.valor || 0);
        if(d.cartao) totaisPorCartaoHist[d.cartao] = (totaisPorCartaoHist[d.cartao]||0) + (d.valor||0);
        
        // Soma por categoria para o m√™s selecionado
        if(d.categoria) totaisPorCategoria[d.categoria] = (totaisPorCategoria[d.categoria]||0) + (d.valor||0);
      }
    });

    renderHistoricoWithFilters(); // Chama a fun√ß√£o de renderiza√ß√£o com filtros
    renderCategorias(totaisPorCategoria);

    resumo.historicoMes = somaVariavel + somaFixoAvulso;
    resumo.pixMes = (docsToProcessForMonth.filter(d=>d.data().cartao==='pix').reduce((a,b)=>a + (b.data().valor||0),0) || 0);
    window._totaisPorCartaoHistorico = totaisPorCartaoHist || {};
    
    // ATRIBUI√á√ÉO DA VARI√ÅVEL GLOBAL PARA O GR√ÅFICO (mantido para compatibilidade, mas o novo modal usa allGastosDocs diretamente)
    window._totaisPorCategoriaAtual = totaisPorCategoria; 
    
    atualizarBarra('variavel', somaVariavel + somaFixoAvulso); 

    // Salva soma de vari√°veis para uso no banner de alertas
    window._somaVariavelAtual = somaVariavel + somaFixoAvulso;

    atualizarTudoComParcelados();
    atualizarFiltroMeses();
    
    // NOVO: Gera insights inteligentes
    setTimeout(() => gerarInsights(), 500);

    // NOVO: Chama aplicarFiltros() aqui para garantir que os gr√°ficos sejam renderizados
    // com os dados mais recentes assim que o modal for aberto.
    // Isso √© importante porque allGastosDocs √© populado aqui.
    if (!modalGraficos.classList.contains('hidden')) { // Apenas se o modal j√° estiver aberto
        aplicarFiltros();
    }

  }, err => {
    console.error("Erro ao carregar gastos:", err);
    hideSpinner('historico-loading-spinner'); // Oculta spinner de hist√≥rico em caso de erro
    showToast('Erro ao carregar hist√≥rico de gastos.', 'error');
  });

  unsubParcelados = userCollectionRef('parcelados').orderBy('dataInicio','desc').onSnapshot(snap=>{
    hideSpinner('parcelados-loading-spinner'); // Oculta spinner de parcelados
    allParceladosDocs = snap.docs;
    
    mesesParceladosColetados = new Set();
    snap.docs.forEach(doc=>{
      const p = doc.data();
      const inicio = p.dataInicio && p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio);
      for(let i=0;i<p.numParcelas;i++){
        mesesParceladosColetados.add( yyyymm(addMonths(inicio,i)) );
      }
    });

    renderParcelados(allParceladosDocs);
    atualizarTudoComParcelados();
    atualizarFiltroMeses();
  }, err => {
    console.error("Erro ao carregar parcelados:", err);
    hideSpinner('parcelados-loading-spinner'); // Oculta spinner de parcelados em caso de erro
    showToast('Erro ao carregar parcelados.', 'error');
  });
}

function atualizarTudoComParcelados(){
  // refer√™ncia ao m√™s selecionado (mant√©m compatibilidade com 'all')
  const mesSel = document.getElementById('filtro-mes').value || yyyymm(new Date());
  const targetKey = mesSel==='all' ? yyyymm(new Date()) : mesSel;
  const [ty,tm] = targetKey.split('-'); 
  const refDate = new Date(parseInt(ty), parseInt(tm)-1,1);

  const parcSnapDocs = allParceladosDocs || []; 
  let parcelasMesTotal = 0;
  let totaisPorCartao = {...(window._totaisPorCartaoHistorico || {})};
  let totalRestanteParcelados = 0;

  parcSnapDocs.forEach(doc=>{
    const p = (typeof doc.data === 'function') ? doc.data() : doc;
    const inicio = p.dataInicio && p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio);
    
    // conta parcelas que caem no m√™s de refer√™ncia (para 'parcelas no m√™s')
    const diff = monthDiff(inicio, refDate);
    if(diff>=0 && diff < (p.numParcelas||0)){
      parcelasMesTotal += (p.valorParcela||0);
      if(p.cartao) totaisPorCartao[p.cartao] = (totaisPorCartao[p.cartao]||0) + (p.valorParcela||0);
    }
    
    // --- CORRE√á√ÉO IMPORTANTE ---
    // usa refDate (m√™s selecionado) para calcular quantas parcelas RESTAM a partir desse m√™s
   const parcelaAtualIndex = Math.max(0, Math.min((p.numParcelas||1)-1, monthDiff(inicio, refDate)));
const parcelaAtual = parcelaAtualIndex + 1;
// calcula o total comprometido a partir do m√™s selecionado (inclui o m√™s atual)
const restantesIncluindoAtual = Math.max(0, (p.numParcelas || 0) - diff);
totalRestanteParcelados += restantesIncluindoAtual * (p.valorParcela || 0);

  });

  resumo.parcelasMes = parcelasMesTotal;
  renderCartoes(totaisPorCartao);

  resumo.cartoesMes = Object.entries(totaisPorCartao).filter(([k])=>k!=='pix').reduce((acc,[,v])=> acc + (v||0), 0);
  resumo.pixMes = (window._totaisPorCartaoHistorico && window._totaisPorCartaoHistorico['pix']) || resumo.pixMes || 0;

  document.getElementById('p-total-restante').textContent = moeda(totalRestanteParcelados);

  // === FIXOS ===
    userCollectionRef('fixos').get().then(fixSnap=>{
      const somaFixosAtivos = fixSnap.docs.reduce((a,d)=> 
        a + ((d.data().ativo && d.data().valor) ? d.data().valor : 0), 0);

      // salva no resumo para entrar no total geral
      resumo.fixosMes = somaFixosAtivos;

let totalGastosAcumulado = 0;
// Gastos vari√°veis (todos realizados)
allGastosDocs.forEach(doc => totalGastosAcumulado += (doc.data().valor || 0));
// Parcelados: Somar apenas parcelas pagas at√© agora (n√£o o total futuro)
const hoje = new Date();
allParceladosDocs.forEach(doc => {
  const p = doc.data();
  const inicio = p.dataInicio && p.dataInicio.toDate ? p.dataInicio.toDate() : new Date(p.dataInicio);
  const parcelasPagas = Math.max(0, monthDiff(inicio, hoje) + 1); // Parcelas pagas at√© agora
  const valorPagas = Math.min(parcelasPagas, p.numParcelas || 1) * (p.valorParcela || 0);
  totalGastosAcumulado += valorPagas;
});
// Fixos: Somar valor mensal * n√∫mero de meses com dados (aproxima√ß√£o)
const mesesComDados = new Set([...mesesDisponiveis, ...mesesParceladosColetados]);
allFixosDocs.forEach(doc => {
  if (doc.data().ativo !== false) {
    totalGastosAcumulado += (doc.data().valor || 0) * mesesComDados.size; // Multiplica pelo n√∫mero de meses √∫nicos
  }
});


      // Verifica todos os tipos de gastos que ultrapassam o limite
      const metaParcelado = getEnvelopeMeta('parcelado');
      const metaFixoAtual = getEnvelopeMeta('fixo');
      const metaVariavel = getEnvelopeMeta('variavel');
      const triggerParcelado = metaParcelado > 0 && parcelasMesTotal > metaParcelado;
      const triggerFixo = metaFixoAtual > 0 && somaFixosAtivos > metaFixoAtual;
      const somaVariavel = window._somaVariavelAtual || 0;
      const triggerVariavel = metaVariavel > 0 && somaVariavel > metaVariavel;
      
      const banner = document.getElementById('danger-banner');
      const alertas = [];

      if(triggerFixo) {
        alertas.push(`<strong>Fixos:</strong> R$ ${moeda(somaFixosAtivos)} / R$ ${moeda(metaFixoAtual)} (${((somaFixosAtivos/metaFixoAtual)*100).toFixed(1)}%)`);
      }

      if(triggerParcelado) {
        alertas.push(`<strong>Parcelados:</strong> R$ ${moeda(parcelasMesTotal)} / R$ ${moeda(metaParcelado)} (${((parcelasMesTotal/metaParcelado)*100).toFixed(1)}%)`);
      }

      if(triggerVariavel) {
        alertas.push(`<strong>Vari√°veis:</strong> R$ ${moeda(somaVariavel)} / R$ ${moeda(metaVariavel)} (${((somaVariavel/metaVariavel)*100).toFixed(1)}%)`);
      }

      if(alertas.length > 0) {
        banner.style.display = 'block';
        banner.innerHTML = `
          <div class="flex items-start gap-2">
            <span class="text-xl">üö®</span>
            <div class="flex-1">
              <div class="font-bold mb-2">Aten√ß√£o: Limite(s) ultrapassado(s)!</div>
              <div class="space-y-1">
                ${alertas.map(alerta => `<div class="text-sm">‚Ä¢ ${alerta}</div>`).join('')}
              </div>
              <div class="text-xs mt-2 text-red-800 dark:text-red-300">
                üí° <strong>Dica:</strong> Considere revisar gastos desnecess√°rios ou ajustar seus limites.
              </div>
            </div>
          </div>
        `;
      } else {
        banner.style.display = 'none';
      }

      document.getElementById('gasto-fixo').textContent = moeda(somaFixosAtivos);
      atualizarBarra('fixo', somaFixosAtivos);

      // agora que j√° temos fixos, atualiza resumo
      atualizarResumoUI();
    });
}


function atualizarResumoUI(){

  const totalGastosPrevistosMes = (resumo.historicoMes || 0) + (resumo.parcelasMes || 0) + (resumo.fixosMes || 0);
  document.getElementById('resumo-total-mes').textContent = moeda(totalGastosPrevistosMes); // Agora mostra a soma dos gastos

  document.getElementById('resumo-cartoes').textContent = moeda(resumo.cartoesMes||0);
  document.getElementById('resumo-pix').textContent = moeda(resumo.pixMes||0);
  document.getElementById('resumo-parcelas-mes').textContent = moeda(resumo.parcelasMes||0);

  painelFinanceiroState.totalGastosMes = totalGastosPrevistosMes;
  atualizarResumoRapido();
  atualizarResumoSaidasCard(totalGastosPrevistosMes);
  atualizarSaudeFinanceira();
}




function atualizarBarra(tipo, gasto){
  const envelope = envelopes[tipo] || envelopeConfig[tipo] || { meta: 0, reservado: 0 };
  const meta = Number(envelope.meta) || 0;
  const reservado = Number(envelope.reservado) || 0;
  const gastoAtual = Number(gasto) || 0;
  const comprometido = gastoAtual + reservado;
  const limiteLivre = Math.max(0, meta - comprometido);
  const excedente = comprometido > meta ? comprometido - meta : 0;
  const percentual = meta ? (comprometido / meta) * 100 : 0;
  const percentBar = Math.max(0, Math.min(100, percentual));

  const progressEl = document.getElementById(`progress-${tipo}`);
  const gastoEl = document.getElementById(`gasto-${tipo}`);
  const limiteLivreEl = document.getElementById(`limite-livre-${tipo}`);
  const reservaEl = document.getElementById(`reserva-${tipo}`);
  const disponivelEl = document.getElementById(`disponivel-${tipo}`);
  const percentualEl = document.getElementById(`percentual-${tipo}`);
  const metaEl = document.getElementById(`meta-${tipo}`);
  const excedenteWrapper = document.getElementById(`excedente-${tipo}-wrapper`);
  const excedenteEl = document.getElementById(`excedente-${tipo}`);
  const card = document.querySelector(`[data-envelope-card="${tipo}"]`);

  if (progressEl) progressEl.style.width = `${percentBar}%`;
  if (gastoEl) gastoEl.textContent = moeda(gastoAtual);
  if (metaEl) metaEl.textContent = moeda(meta);
  if (limiteLivreEl) limiteLivreEl.textContent = moeda(limiteLivre);
  if (reservaEl) reservaEl.textContent = moeda(reservado);
  if (disponivelEl) disponivelEl.textContent = moeda(limiteLivre);
  if (percentualEl) percentualEl.textContent = `${percentual.toFixed(1)}%`;
  if (excedenteWrapper && excedenteEl) {
    if (excedente > 0) {
      excedenteWrapper.classList.remove('hidden');
      excedenteEl.textContent = moeda(excedente);
    } else {
      excedenteWrapper.classList.add('hidden');
    }
  }

  if (card) {
    const estourado = excedente > 0 && meta > 0;
    card.classList.toggle('ring-2', estourado);
    card.classList.toggle('ring-red-400', estourado);
    card.classList.toggle('ring-offset-2', estourado);
  }
}

/* ===========================
   RENDER CATEGORIAS
   =========================== */
function renderCategorias(totaisPorCategoria){
  const container = document.getElementById('categorias-list');
  container.innerHTML = '';

  const categoriasOrdenadas = Object.keys(totaisPorCategoria).sort((a, b) => totaisPorCategoria[b] - totaisPorCategoria[a]);

  if (categoriasOrdenadas.length === 0) {
    container.innerHTML = '<div class="text-gray-500 dark:text-gray-400">Nenhum gasto categorizado no m√™s.</div>';
    return;
  }

  const totalGastosVariaveisMes = Object.values(totaisPorCategoria).reduce((sum, val) => sum + val, 0);

  categoriasOrdenadas.forEach(categoriaKey => {
    const totalGasto = totaisPorCategoria[categoriaKey];
    const percent = totalGastosVariaveisMes ? (totalGasto / totalGastosVariaveisMes) * 100 : 0;
    
    const categoriaNome = categoriaKey.charAt(0).toUpperCase() + categoriaKey.slice(1);

    const categoriaDiv = document.createElement('div');
    categoriaDiv.className = 'mb-2';
    categoriaDiv.innerHTML = `
      <div class="flex justify-between items-center mb-1">
        <div class="font-semibold">${categoriaNome}</div>
        <div class="text-sm text-gray-500 dark:text-gray-400">R$ ${moeda(totalGasto)}</div>
      </div>
      <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
        <div class="progress-bar bg-blue-400 h-2 rounded-full" style="width:${percent}%"></div>
      </div>
    `;
    container.appendChild(categoriaDiv);
  });
}


const entradaTipoLabels = {
  salario: 'Sal√°rio',
  venda: 'Venda',
  renda_extra: 'Renda extra',
  outros: 'Outros',
};

const investimentoTipoLabels = {
  reserva: 'Reserva de emerg√™ncia',
  renda_fixa: 'Renda fixa',
  acoes: 'A√ß√µes/Fundos',
  cripto: 'Cripto',
  outros: 'Outros',
};

function renderEntradasSidebar(docs = []) {
  const lista = document.getElementById('entradas-lista');
  const totalMesEl = document.getElementById('entradas-total-mes');
  const totalGeralEl = document.getElementById('entradas-total-geral');
  const tiposContainer = document.getElementById('entradas-tipos-resumo');
  if (!lista || !totalMesEl || !totalGeralEl || !tiposContainer) return;

  mesesEntradasDisponiveis = new Set();
  allEntradasDocs = docs;

  lista.innerHTML = '';
  tiposContainer.innerHTML = '';

  const mesSel = document.getElementById('filtro-mes').value || yyyymm(new Date());
  const mostrarTodos = mesSel === 'all';

  let totalMes = 0;
  let totalRegistrado = 0;
  const totaisPorTipoPeriodo = {};
  let itensPeriodo = 0;

  docs.forEach(doc => {
    const data = doc.data();
    if (!data || !data.data) return;
    const dt = data.data.toDate ? data.data.toDate() : new Date(data.data);
    if (Number.isNaN(dt.getTime())) return;
    const key = yyyymm(dt);
    mesesEntradasDisponiveis.add(key);

    const valor = Number(data.valor) || 0;
    const tipo = data.tipo || 'outros';
    const descricao = (data.descricao || '').trim();

    totalRegistrado += valor;

    if (mostrarTodos || key === mesSel) {
      totalMes += valor;
      itensPeriodo += 1;
      totaisPorTipoPeriodo[tipo] = (totaisPorTipoPeriodo[tipo] || 0) + valor;
      const item = document.createElement('div');
      item.className = 'flex items-center gap-3 p-2 bg-gray-50 dark:bg-gray-700 rounded';
      item.innerHTML = `
        <div class="flex-1">
          <div class="font-semibold text-gray-700 dark:text-gray-100">${entradaTipoLabels[tipo] || tipo}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${formatDate(dt)}${descricao ? ` ‚Ä¢ ${descricao}` : ''}</div>
        </div>
        <div class="text-right">
          <div class="font-semibold text-green-600 dark:text-green-300">R$ ${moeda(valor)}</div>
        </div>
        <button class="text-gray-400 hover:text-red-500 transition" data-remove-entrada="${doc.id}" aria-label="Remover entrada">
          <i class="fa fa-times"></i>
        </button>
      `;
      lista.appendChild(item);
    }
  });

  if (itensPeriodo === 0) {
    const empty = document.createElement('div');
    empty.className = 'text-gray-500 dark:text-gray-400';
    empty.textContent = 'Nenhuma entrada registrada para o per√≠odo selecionado.';
    lista.appendChild(empty);
  }

  if (Object.keys(totaisPorTipoPeriodo).length === 0) {
    const emptyTipos = document.createElement('div');
    emptyTipos.className = 'col-span-2 text-gray-500 dark:text-gray-400';
    emptyTipos.textContent = 'Cadastre entradas para ver a distribui√ß√£o.';
    tiposContainer.appendChild(emptyTipos);
  } else {
    Object.entries(totaisPorTipoPeriodo).sort((a, b) => b[1] - a[1]).forEach(([tipo, valor]) => {
      const card = document.createElement('div');
      card.className = 'p-2 bg-green-50 dark:bg-green-900/10 rounded';
      card.innerHTML = `
        <div class="text-xs uppercase text-green-700 dark:text-green-200">${entradaTipoLabels[tipo] || tipo}</div>
        <div class="text-sm font-semibold text-green-800 dark:text-green-300">R$ ${moeda(valor)}</div>
      `;
      tiposContainer.appendChild(card);
    });
  }

  totalMesEl.textContent = moeda(totalMes);
  totalGeralEl.textContent = moeda(totalRegistrado);

  const saldoMesEl = document.getElementById('entradas-saldo-mes');
  const saldoHintEl = document.getElementById('entradas-saldo-hint');
  if (saldoMesEl) {
    if (mostrarTodos) {
      saldoMesEl.textContent = '--';
      if (saldoHintEl) saldoHintEl.textContent = 'Selecione um m√™s espec√≠fico para calcular o saldo l√≠quido.';
    } else {
      const gastosPeriodo = painelFinanceiroState.totalGastosMes || 0;
      saldoMesEl.textContent = moeda(totalMes - gastosPeriodo);
      if (saldoHintEl) saldoHintEl.textContent = 'Entradas menos sa√≠das previstas do per√≠odo selecionado.';
    }
  }

  painelFinanceiroState.entradasMes = totalMes;
  painelFinanceiroState.entradasTotais = totalRegistrado;
  atualizarResumoRapido();
  atualizarSaudeFinanceira();
  atualizarFiltroMeses();
}

function renderInvestimentosSidebar(docs = []) {
  const lista = document.getElementById('investimentos-lista');
  const totalMesEl = document.getElementById('investimento-total-mes');
  const totalGeralEl = document.getElementById('investimento-total-geral');
  const projEl = document.getElementById('investimento-projecao');
  if (!lista || !totalMesEl || !totalGeralEl || !projEl) return;

  mesesInvestimentosDisponiveis = new Set();
  allInvestimentosDocs = docs;

  lista.innerHTML = '';

  const mesSel = document.getElementById('filtro-mes').value || yyyymm(new Date());
  const mostrarTodos = mesSel === 'all';
  const hoje = new Date();

  let totalMes = 0;
  let totalGeral = 0;
  let totalProjetado = 0;
  const totaisPorMes = {};

  docs.forEach(doc => {
    const data = doc.data();
    if (!data || !data.data) return;
    const dt = data.data.toDate ? data.data.toDate() : new Date(data.data);
    if (Number.isNaN(dt.getTime())) return;
    const key = yyyymm(dt);
    mesesInvestimentosDisponiveis.add(key);

    const valor = Number(data.valor) || 0;
    const tipo = data.tipo || 'outros';
    const descricao = (data.descricao || '').trim();

    totalGeral += valor;
    totaisPorMes[key] = (totaisPorMes[key] || 0) + valor;
    const mesesPassados = Math.max(0, monthDiff(dt, hoje));
    const valorProjetado = valor * Math.pow(1.01, mesesPassados);
    totalProjetado += valorProjetado;

    if (mostrarTodos || key === mesSel) {
      totalMes += valor;
      const item = document.createElement('div');
      item.className = 'flex items-center gap-3 p-2 bg-indigo-50 dark:bg-indigo-900/20 rounded';
      item.innerHTML = `
        <div class="flex-1">
          <div class="flex items-center gap-2">
            <span class="text-xs uppercase tracking-wide bg-indigo-100 dark:bg-indigo-900/60 text-indigo-700 dark:text-indigo-200 px-2 py-0.5 rounded">${investimentoTipoLabels[tipo] || tipo}</span>
            ${descricao ? `<span class="text-sm font-medium text-gray-700 dark:text-gray-200">${descricao}</span>` : ''}
          </div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${formatDate(dt)}</div>
        </div>
        <div class="text-right">
          <div class="font-semibold text-indigo-700 dark:text-indigo-200">R$ ${moeda(valor)}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">Proj.: R$ ${moeda(valorProjetado)}</div>
        </div>
        <button class="text-gray-400 hover:text-red-500 transition" data-remove-investimento="${doc.id}" aria-label="Remover investimento">
          <i class="fa fa-times"></i>
        </button>
      `;
      lista.appendChild(item);
    }
  });

  if (!lista.children.length) {
    const empty = document.createElement('div');
    empty.className = 'text-gray-500 dark:text-gray-400';
    empty.textContent = 'Nenhum investimento registrado para o per√≠odo selecionado.';
    lista.appendChild(empty);
  }

  totalMesEl.textContent = moeda(totalMes);
  totalGeralEl.textContent = moeda(totalGeral);
  projEl.textContent = moeda(totalProjetado);

  painelFinanceiroState.investimentosMes = totalMes;
  painelFinanceiroState.investimentosTotais = totalGeral;
  painelFinanceiroState.investimentosProjetados = totalProjetado;
  renderGraficoInvestimentos(totaisPorMes);
  atualizarResumoRapido();
  atualizarSaudeFinanceira();
  atualizarSimuladorValoresPadrao();
  atualizarSimuladorResultados();
  atualizarFiltroMeses();
}

function renderGraficoInvestimentos(totaisPorMes = {}) {
  const canvas = document.getElementById('grafico-investimentos');
  const emptyState = document.getElementById('investimentos-grafico-empty');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  if (chartInvestimentos) {
    chartInvestimentos.destroy();
    chartInvestimentos = null;
  }

  const mesesOrdenados = Object.keys(totaisPorMes || {}).sort();
  if (mesesOrdenados.length === 0) {
    if (emptyState) emptyState.classList.remove('hidden');
    if (ctx) ctx.clearRect(0, 0, canvas.width || 0, canvas.height || 0);
    return;
  }

  if (emptyState) emptyState.classList.add('hidden');

  const mesesRecentes = mesesOrdenados.slice(-12);
  const labels = mesesRecentes.map(mmYYYY);
  const aportesMensais = mesesRecentes.map(mes => totaisPorMes[mes]);
  let acumulado = 0;
  const acumuladoSeries = mesesRecentes.map(mes => {
    acumulado += totaisPorMes[mes];
    return acumulado;
  });

  chartInvestimentos = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          type: 'bar',
          label: 'Aportes mensais',
          data: aportesMensais,
          backgroundColor: 'rgba(99, 102, 241, 0.35)',
          borderColor: '#6366f1',
          borderWidth: 1,
          borderRadius: 6,
          yAxisID: 'y'
        },
        {
          type: 'line',
          label: 'Total acumulado',
          data: acumuladoSeries,
          borderColor: '#8b5cf6',
          backgroundColor: 'rgba(139, 92, 246, 0.2)',
          fill: false,
          tension: 0.35,
          pointRadius: 4,
          pointBackgroundColor: '#8b5cf6',
          yAxisID: 'y'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => `R$ ${moeda(val)}`,
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937'
          },
          grid: {
            color: html.classList.contains('dark') ? '#4b5563' : '#e5e7eb'
          }
        },
        x: {
          ticks: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937'
          },
          grid: {
            color: html.classList.contains('dark') ? '#374151' : '#f3f4f6'
          }
        }
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937'
          }
        },
        tooltip: {
          callbacks: {
            label: context => {
              const label = context.dataset.label || '';
              return `${label}: R$ ${moeda(context.parsed.y || context.parsed)}`;
            }
          }
        }
      }
    }
  });
}

function calcularProjecaoJurosCompostos(valorInicial, aporteMensal, taxaPercentual, meses) {
  const principal = Math.max(0, Number(valorInicial) || 0);
  const aporte = Math.max(0, Number(aporteMensal) || 0);
  const taxa = Number(taxaPercentual) / 100 || 0;
  const periodo = Math.max(0, parseInt(meses, 10) || 0);
  const aportado = principal + (aporte * periodo);

  if (periodo === 0) {
    return { total: principal, aportado, ganho: principal - aportado };
  }

  let total;
  if (taxa === 0) {
    total = principal + (aporte * periodo);
  } else {
    const fator = Math.pow(1 + taxa, periodo);
    total = (principal * fator) + (aporte * ((fator - 1) / taxa));
  }

  const ganho = total - aportado;
  return { total, aportado, ganho };
}

function atualizarSimuladorValoresPadrao(force = false) {
  const inicialInput = document.getElementById('simulador-valor-inicial');
  if (!inicialInput) return;
  const totalInvestido = painelFinanceiroState.investimentosTotais || 0;
  if (force || !inicialInput.dataset.userEdited) {
    inicialInput.value = (totalInvestido || 0).toFixed(2);
  }

  const aporteMensalInput = document.getElementById('simulador-aporte-mensal');
  const aporteMes = painelFinanceiroState.investimentosMes || 0;
  if (aporteMensalInput && (force || !aporteMensalInput.dataset.userEdited)) {
    aporteMensalInput.value = (aporteMes || 0).toFixed(2);
  }

  const taxaInput = document.getElementById('simulador-taxa');
  if (taxaInput && (force || !taxaInput.dataset.userEdited) && !taxaInput.value) {
    taxaInput.value = String(SIMULADOR_DEFAULT_TAXA);
  }

  const periodoInput = document.getElementById('simulador-periodo');
  if (periodoInput && (force || !periodoInput.dataset.userEdited) && !periodoInput.value) {
    periodoInput.value = String(SIMULADOR_DEFAULT_PERIODO);
  }

  const aporteAltInput = document.getElementById('simulador-aporte-alternativo');
  if (aporteAltInput && (force || !aporteAltInput.dataset.userEdited)) {
    if (aporteAltInput.value === '' || force) {
      aporteAltInput.value = (aporteMes || 0).toFixed(2);
    }
  }

  const taxaAltInput = document.getElementById('simulador-taxa-alternativa');
  if (taxaAltInput && (force || !taxaAltInput.dataset.userEdited)) {
    if (taxaAltInput.value === '' || force) {
      taxaAltInput.value = taxaInput && taxaInput.value ? taxaInput.value : String(SIMULADOR_DEFAULT_TAXA);
    }
  }

  const aporteExtraInput = document.getElementById('simulador-aporte-extra');
  if (aporteExtraInput && (force || !aporteExtraInput.dataset.userEdited) && aporteExtraInput.value === '') {
    aporteExtraInput.value = '0';
  }

  const periodoAltInput = document.getElementById('simulador-periodo-alternativo');
  if (periodoAltInput && (force || !periodoAltInput.dataset.userEdited) && periodoAltInput.value === '') {
    periodoAltInput.value = '0';
  }
}

function atualizarSimuladorResultados() {
  const baseTotalEl = document.getElementById('simulador-base-total');
  if (!baseTotalEl) return;

  const valorInicial = parseFloat(document.getElementById('simulador-valor-inicial')?.value) || 0;
  const aporteMensal = parseFloat(document.getElementById('simulador-aporte-mensal')?.value) || 0;
  const taxaMensal = parseFloat(document.getElementById('simulador-taxa')?.value) || 0;
  const periodoMeses = Math.max(1, parseInt(document.getElementById('simulador-periodo')?.value, 10) || SIMULADOR_DEFAULT_PERIODO);

  const base = calcularProjecaoJurosCompostos(valorInicial, aporteMensal, taxaMensal, periodoMeses);

  const aporteAltBruto = parseFloat(document.getElementById('simulador-aporte-alternativo')?.value);
  const taxaAltBruta = parseFloat(document.getElementById('simulador-taxa-alternativa')?.value);
  const aporteExtra = Math.max(0, parseFloat(document.getElementById('simulador-aporte-extra')?.value) || 0);
  const periodoExtra = parseInt(document.getElementById('simulador-periodo-alternativo')?.value, 10);

  const aporteMensalAlternativo = !Number.isNaN(aporteAltBruto) && aporteAltBruto >= 0 ? aporteAltBruto : aporteMensal;
  const taxaMensalAlternativa = !Number.isNaN(taxaAltBruta) ? taxaAltBruta : taxaMensal;
  const mesesAlternativo = Math.max(1, periodoMeses + (Number.isNaN(periodoExtra) ? 0 : periodoExtra));
  const valorInicialAlternativo = valorInicial + aporteExtra;

  const alternativo = calcularProjecaoJurosCompostos(valorInicialAlternativo, aporteMensalAlternativo, taxaMensalAlternativa, mesesAlternativo);

  const diffValor = alternativo.total - base.total;
  const diffGanho = alternativo.ganho - base.ganho;

  baseTotalEl.textContent = `R$ ${moeda(base.total)}`;
  const baseGanhoEl = document.getElementById('simulador-base-ganho');
  if (baseGanhoEl) baseGanhoEl.textContent = `R$ ${moeda(base.ganho)}`;

  const altTotalEl = document.getElementById('simulador-alt-total');
  if (altTotalEl) altTotalEl.textContent = `R$ ${moeda(alternativo.total)}`;
  const altGanhoEl = document.getElementById('simulador-alt-ganho');
  if (altGanhoEl) altGanhoEl.textContent = `R$ ${moeda(alternativo.ganho)}`;

  const diffValorEl = document.getElementById('simulador-diferenca-valor');
  if (diffValorEl) diffValorEl.textContent = `R$ ${moeda(diffValor)}`;
  const diffGanhoEl = document.getElementById('simulador-diferenca-ganho');
  if (diffGanhoEl) diffGanhoEl.textContent = `R$ ${moeda(diffGanho)}`;
}

function initSimuladorAccordion() {
  const simulador = document.getElementById('simulador-juros-compostos');
  if (!simulador) return;
  const toggleBtn = simulador.querySelector('[data-simulador-toggle]');
  const content = simulador.querySelector('[data-simulador-content]');
  const icon = simulador.querySelector('[data-simulador-icon]');
  if (!toggleBtn || !content) return;
  if (toggleBtn.dataset.bound === 'true') return;
  toggleBtn.dataset.bound = 'true';

  toggleBtn.addEventListener('click', () => {
    const isHidden = content.classList.contains('hidden');
    if (isHidden) {
      content.classList.remove('hidden');
      toggleBtn.setAttribute('aria-expanded', 'true');
      if (icon) {
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
      }
    } else {
      content.classList.add('hidden');
      toggleBtn.setAttribute('aria-expanded', 'false');
      if (icon) {
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
      }
    }
  });
}

function initSimuladorInvestimentos() {
  const simulador = document.getElementById('simulador-juros-compostos');
  if (!simulador) return;
  initSimuladorAccordion();
  const inputs = simulador.querySelectorAll('[data-simulador]');
  inputs.forEach(input => {
    input.addEventListener('input', () => {
      input.dataset.userEdited = 'true';
      atualizarSimuladorResultados();
    });
    input.addEventListener('change', () => atualizarSimuladorResultados());
  });
  atualizarSimuladorValoresPadrao(true);
  atualizarSimuladorResultados();
}

function atualizarResumoSaidasCard(totalGastosPrevistosMes) {
  const totalEl = document.getElementById('saidas-total-card');
  const fixosEl = document.getElementById('saidas-fixos');
  const variavelEl = document.getElementById('saidas-variavel');
  const parceladoEl = document.getElementById('saidas-parcelado');
  const fixosBar = document.getElementById('saidas-fixos-bar');
  const variavelBar = document.getElementById('saidas-variavel-bar');
  const parceladoBar = document.getElementById('saidas-parcelado-bar');

  if (!totalEl || !fixosEl || !variavelEl || !parceladoEl || !fixosBar || !variavelBar || !parceladoBar) return;

  const fixoVal = resumo.fixosMes || 0;
  const variavelVal = resumo.historicoMes || 0;
  const parceladoVal = resumo.parcelasMes || 0;
  const total = fixoVal + variavelVal + parceladoVal;

  totalEl.textContent = moeda(totalGastosPrevistosMes);
  fixosEl.textContent = moeda(fixoVal);
  variavelEl.textContent = moeda(variavelVal);
  parceladoEl.textContent = moeda(parceladoVal);

  const calcPercent = valor => total ? Math.max(0, Math.min(100, (valor / total) * 100)) : 0;
  fixosBar.style.width = `${calcPercent(fixoVal)}%`;
  variavelBar.style.width = `${calcPercent(variavelVal)}%`;
  parceladoBar.style.width = `${calcPercent(parceladoVal)}%`;
}

function atualizarResumoRapido() {
  const entradasMes = painelFinanceiroState.entradasMes || 0;
  const totalGastosMes = painelFinanceiroState.totalGastosMes || 0;
  const projInvest = painelFinanceiroState.investimentosProjetados || 0;
  const totalInvest = painelFinanceiroState.investimentosTotais || 0;
  const ganhoInvest = Math.max(0, projInvest - totalInvest);
  const saldo = entradasMes - totalGastosMes;
  const saldoProjetado = saldo + ganhoInvest;

  atualizarResumoIndicadoresFinanceiros({ entradasMes, totalGastosMes, saldoProjetado, ganhoInvest });

  resumoFinanceiroAtual = { entradasMes, totalGastosMes, saldoProjetado, ganhoInvest };
  atualizarSimuladorResultados();
  return resumoFinanceiroAtual;
}

function atualizarResumoIndicadoresFinanceiros({ entradasMes, totalGastosMes, saldoProjetado, ganhoInvest }) {
  const entradasMesEl = document.getElementById('resumo-entradas-mes');
  const saidasMesEl = document.getElementById('resumo-saidas-mes');
  const saldoProjetadoEl = document.getElementById('resumo-saldo-projetado');
  const ganhoInvestEl = document.getElementById('resumo-ganho-invest');

  if (!entradasMesEl || !saidasMesEl || !saldoProjetadoEl || !ganhoInvestEl) return;

  entradasMesEl.textContent = moeda(entradasMes);
  saidasMesEl.textContent = moeda(totalGastosMes);
  saldoProjetadoEl.textContent = moeda(saldoProjetado);
  ganhoInvestEl.textContent = moeda(Math.max(0, ganhoInvest));

  const saldoItem = saldoProjetadoEl.closest('.resumo-item');
  if (saldoItem) {
    saldoItem.classList.remove('positivo', 'alerta', 'neutro');
    if (saldoProjetado > 50) {
      saldoItem.classList.add('positivo');
    } else if (saldoProjetado < -50) {
      saldoItem.classList.add('alerta');
    } else {
      saldoItem.classList.add('neutro');
    }
  }

  const ganhoItem = ganhoInvestEl.closest('.resumo-item');
  if (ganhoItem) {
    ganhoItem.classList.remove('positivo', 'alerta', 'neutro');
    if (ganhoInvest > 0) {
      ganhoItem.classList.add('positivo');
    } else {
      ganhoItem.classList.add('neutro');
    }
  }

  const saidasItem = saidasMesEl.closest('.resumo-item');
  if (saidasItem) {
    const excedeu = totalGastosMes > entradasMes;
    saidasItem.classList.remove('positivo', 'alerta', 'neutro');
    saidasItem.classList.add(excedeu ? 'alerta' : 'neutro');
  }
}

function atualizarSaudeFinanceira() {
  const scoreEl = document.getElementById('saude-score');
  const statusEl = document.getElementById('saude-status');
  const progressEl = document.getElementById('saude-progress');
  const saldoEl = document.getElementById('saude-detalhes-saldo');
  const rendaEl = document.getElementById('saude-detalhes-renda');
  const investimentoEl = document.getElementById('saude-investimento-extra');
  if (!scoreEl || !statusEl || !progressEl || !saldoEl || !rendaEl || !investimentoEl) return;

  const entradasMes = painelFinanceiroState.entradasMes || 0;
  const totalGastosMes = painelFinanceiroState.totalGastosMes || 0;
  const projInvest = painelFinanceiroState.investimentosProjetados || 0;
  const totalInvest = painelFinanceiroState.investimentosTotais || 0;
  const ganhoInvest = Math.max(0, projInvest - totalInvest);
  const saldo = entradasMes - totalGastosMes;
  const saldoProjetado = saldo + ganhoInvest;

  rendaEl.textContent = `R$ ${moeda(entradasMes)}`;
  investimentoEl.textContent = `R$ ${moeda(Math.max(projInvest, 0))}`;
  saldoEl.textContent = `R$ ${moeda(saldoProjetado)}`;

  if (entradasMes === 0 && totalGastosMes === 0 && projInvest === 0) {
    scoreEl.textContent = '--';
    progressEl.style.width = '0%';
    progressEl.style.backgroundColor = '#f43f5e';
    statusEl.textContent = 'Cadastre entradas e gastos para calcular sua sa√∫de financeira.';
    return;
  }

  let score;
  if (entradasMes <= 0) {
    score = totalGastosMes > 0 ? 5 : 50;
  } else {
    const uso = totalGastosMes / entradasMes;
    score = Math.round(Math.max(0, Math.min(100, (1 - Math.min(uso, 1.5) / 1.5) * 100)));
  }

  const mensagem = score >= 80
    ? 'Excelente! Voc√™ est√° gastando menos do que ganha e aproveitando os investimentos.'
    : score >= 55
      ? 'Aten√ß√£o: ajuste alguns gastos ou aumente suas entradas para melhorar o saldo.'
      : 'Cr√≠tico: reveja gastos urgentes ou busque novas entradas para equilibrar as finan√ßas.';

  const cor = score >= 80 ? '#16a34a' : score >= 55 ? '#f97316' : '#dc2626';

  scoreEl.textContent = `${score} pts`;
  progressEl.style.width = `${score}%`;
  progressEl.style.backgroundColor = cor;
  statusEl.textContent = mensagem;
}

function initMobilePanels() {
  const nav = document.getElementById('mobile-panels-nav');
  const panels = Array.from(document.querySelectorAll('.mobile-panel'));
  if (!nav || panels.length === 0) return;

  const buttons = Array.from(nav.querySelectorAll('[data-panel-target]')).filter(btn => btn.dataset.panelTarget);
  if (!buttons.length) return;

  const firstAvailable = buttons.find(btn => panels.some(panel => panel.id === btn.dataset.panelTarget));
  let activeId = firstAvailable ? firstAvailable.dataset.panelTarget : panels[0]?.id;
  if (!activeId) return;

  const applyState = (id) => {
    if (!id) return;
    activeId = id;
    const isDesktop = window.innerWidth >= 1024;
    panels.forEach(panel => {
      if (isDesktop) {
        panel.classList.remove('hidden');
      } else {
        panel.classList.toggle('hidden', panel.id !== id);
      }
    });
    buttons.forEach(btn => btn.classList.toggle('active', btn.dataset.panelTarget === id));
  };

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.panelTarget;
      if (!target || target === activeId) return;
      applyState(target);
    });
  });

  const handleResize = () => {
    if (window.innerWidth >= 1024) {
      panels.forEach(panel => panel.classList.remove('hidden'));
    } else {
      applyState(activeId);
    }
  };

  applyState(activeId);
  window.addEventListener('resize', handleResize);
  handleResize();
}

function initResumoSlider() {
  const slider = document.getElementById('resumo-slider');
  const track = document.getElementById('resumo-slider-track');
  if (!slider || !track) return;

  const slides = Array.from(track.children);
  if (slides.length <= 1) return;

  const mainButtons = Array.from(document.querySelectorAll('.resumo-slider-dot[data-slide]'));
  const dotButtons = Array.from(document.querySelectorAll('.resumo-slider-dots button[data-slide]'));
  let activeIndex = 0;
  let pointerActive = false;
  let startX = 0;
  let pointerId = null;

  const getClientX = (event) => (typeof event.clientX === 'number' ? event.clientX : startX);

  const clampIndex = (index) => Math.max(0, Math.min(slides.length - 1, index));

  const applyTransform = () => {
    track.style.transform = `translateX(-${activeIndex * 100}%)`;
  };

  const updateButtons = () => {
    const check = btn => Number(btn.dataset.slide) === activeIndex;
    mainButtons.forEach(btn => btn.classList.toggle('is-active', check(btn)));
    dotButtons.forEach(btn => btn.classList.toggle('is-active', check(btn)));
  };

  const goTo = (index) => {
    const nextIndex = clampIndex(index);
    if (nextIndex === activeIndex) {
      applyTransform();
      return;
    }
    activeIndex = nextIndex;
    applyTransform();
    updateButtons();
  };

  const finishPointer = (event) => {
    if (!pointerActive) return;
    const deltaX = getClientX(event) - startX;
    if (Math.abs(deltaX) > 50) {
      goTo(activeIndex + (deltaX < 0 ? 1 : -1));
    } else {
      goTo(activeIndex);
    }
    if (pointerId !== null) {
      try { slider.releasePointerCapture(pointerId); } catch (err) { /* ignore */ }
    }
    pointerActive = false;
    pointerId = null;
  };

  mainButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const index = Number(btn.dataset.slide) || 0;
      goTo(index);
    });
  });

  dotButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const index = Number(btn.dataset.slide) || 0;
      goTo(index);
    });
  });

  slider.addEventListener('pointerdown', (event) => {
    if (event.pointerType === 'mouse' && event.button !== 0) return;
    pointerActive = true;
    startX = event.clientX;
    pointerId = event.pointerId;
    try { slider.setPointerCapture(pointerId); } catch (err) { /* ignore */ }
  });

  slider.addEventListener('pointerup', finishPointer);
  slider.addEventListener('pointercancel', finishPointer);
  slider.addEventListener('pointerleave', (event) => {
    if (!pointerActive) return;
    finishPointer(event);
  });

  window.addEventListener('resize', () => {
    applyTransform();
    updateButtons();
  });

  goTo(0);
}

/* ===========================
   UI EVENTS: forms, export, edits
   =========================== */
document.getElementById('parcelado-form').addEventListener('submit', e=>{
  e.preventDefault();
  const desc = document.getElementById('p-desc').value.trim();
  const valorParcela = parseFloat(document.getElementById('p-valor').value)||0;
  const numParcelas = parseInt(document.getElementById('p-num').value)||1;
  const cartao = document.getElementById('p-cartao').value||'';
  const inicio = document.getElementById('p-inicio').value;
  if(!desc || valorParcela<=0 || numParcelas<1 || !inicio) {
    showToast('Preencha todos os campos do parcelado corretamente.', 'error');
    return;
  }
  const [y,m] = inicio.split('-');
  const dataInicio = new Date(parseInt(y), parseInt(m)-1, 1);
  userCollectionRef('parcelados').add({descricao:desc, valorParcela, numParcelas, cartao, dataInicio, ownerUid: currentUser?.uid || null})
    .then(()=> {
      e.target.reset();
      showToast('Parcelado adicionado com sucesso!');
      gerarInsights(); // NOVO: Atualiza insights ap√≥s adicionar parcelado
    })
    .catch(err => showToast('Erro ao adicionar parcelado: ' + err.message, 'error'));
});

const toggleParceladosBtn = document.getElementById('toggle-parcelados-projecao');
if (toggleParceladosBtn) {
  const parceladosContainer = document.getElementById('parcelados-projecao-container');
  const parceladosIcon = document.getElementById('parcelados-projecao-toggle-icon');
  toggleParceladosBtn.addEventListener('click', () => {
    if (!parceladosContainer) return;
    const hidden = parceladosContainer.classList.toggle('hidden');
    toggleParceladosBtn.setAttribute('aria-expanded', (!hidden).toString());
    parceladosContainer.setAttribute('aria-hidden', hidden ? 'true' : 'false');
    if (parceladosIcon) {
      parceladosIcon.classList.toggle('rotate-180', !hidden);
    }
    if (!hidden && chartParceladosProjecao) {
      setTimeout(() => {
        if (chartParceladosProjecao) {
          chartParceladosProjecao.resize();
        }
      }, 120);
    }
  });
}

/* ===========================
   ENTRADAS & INVESTIMENTOS SIDEBAR
   =========================== */
const formEntrada = document.getElementById('form-entrada');
const entradaDataInput = document.getElementById('entrada-data');
const entradaValorInput = document.getElementById('entrada-valor');
const formInvestimento = document.getElementById('form-investimento');
const investimentoDataInput = document.getElementById('investimento-data');
const investimentoValorInput = document.getElementById('investimento-valor');

const hojeIso = formatDateInputValue(new Date());
if (entradaDataInput && !entradaDataInput.value) entradaDataInput.value = hojeIso;
if (investimentoDataInput && !investimentoDataInput.value) investimentoDataInput.value = hojeIso;

if (formEntrada) {
  formEntrada.addEventListener('submit', e => {
    e.preventDefault();
    const tipo = document.getElementById('entrada-tipo')?.value || 'outros';
    const valor = parseFloat((entradaValorInput && entradaValorInput.value) || '0');
    const dataValor = entradaDataInput ? entradaDataInput.value : '';
    const descricao = (document.getElementById('entrada-desc')?.value || '').trim();

    if (!dataValor || valor <= 0) {
      showToast('Informe um valor e uma data v√°lidos para a entrada.', 'error');
      return;
    }

    const data = new Date(`${dataValor}T12:00:00`);
    userCollectionRef('entradas').add({
      tipo,
      valor,
      descricao,
      data: firebase.firestore.Timestamp.fromDate(data),
      createdAt: firebase.firestore.Timestamp.now(),
      ownerUid: currentUser?.uid || null,
    }).then(() => {
      showToast('Entrada registrada com sucesso!', 'success');
      formEntrada.reset();
      if (entradaDataInput) entradaDataInput.value = formatDateInputValue(new Date());
    }).catch(err => {
      console.error('Erro ao adicionar entrada:', err);
      showToast('Erro ao adicionar entrada.', 'error');
    });
  });

  const entradasLista = document.getElementById('entradas-lista');
  if (entradasLista) {
    entradasLista.addEventListener('click', e => {
      const btn = e.target.closest('[data-remove-entrada]');
      if (!btn) return;
      const id = btn.getAttribute('data-remove-entrada');
      if (!id) return;
      abrirModalConfirmacao('Remover entrada', 'Deseja remover esta entrada de dinheiro?', () => {
        userCollectionRef('entradas').doc(id).delete()
          .then(() => showToast('Entrada removida!', 'success'))
          .catch(err => {
            console.error('Erro ao remover entrada:', err);
            showToast('Erro ao remover entrada.', 'error');
          });
      });
    });
  }
}

if (formInvestimento) {
  formInvestimento.addEventListener('submit', e => {
    e.preventDefault();
    const tipo = document.getElementById('investimento-tipo')?.value || 'outros';
    const valor = parseFloat((investimentoValorInput && investimentoValorInput.value) || '0');
    const dataValor = investimentoDataInput ? investimentoDataInput.value : '';
    const descricao = (document.getElementById('investimento-desc')?.value || '').trim();

    if (!dataValor || valor <= 0) {
      showToast('Informe um valor e uma data v√°lidos para o investimento.', 'error');
      return;
    }

    const data = new Date(`${dataValor}T12:00:00`);
    userCollectionRef('investimentos').add({
      tipo,
      valor,
      descricao,
      data: firebase.firestore.Timestamp.fromDate(data),
      createdAt: firebase.firestore.Timestamp.now(),
      ownerUid: currentUser?.uid || null,
    }).then(() => {
      showToast('Investimento registrado!', 'success');
      formInvestimento.reset();
      if (investimentoDataInput) investimentoDataInput.value = formatDateInputValue(new Date());
    }).catch(err => {
      console.error('Erro ao adicionar investimento:', err);
      showToast('Erro ao adicionar investimento.', 'error');
    });
  });

  const investimentosLista = document.getElementById('investimentos-lista');
  if (investimentosLista) {
    investimentosLista.addEventListener('click', e => {
      const btn = e.target.closest('[data-remove-investimento]');
      if (!btn) return;
      const id = btn.getAttribute('data-remove-investimento');
      if (!id) return;
      abrirModalConfirmacao('Remover investimento', 'Deseja remover este lan√ßamento de investimento?', () => {
        userCollectionRef('investimentos').doc(id).delete()
          .then(() => showToast('Investimento removido!', 'success'))
          .catch(err => {
            console.error('Erro ao remover investimento:', err);
            showToast('Erro ao remover investimento.', 'error');
          });
      });
    });
  }
}

document.getElementById('exportar-csv').addEventListener('click', exportarCSVmes);
document.getElementById('exportar-tudo').addEventListener('click', exportarCSVtudo);

['fixo', 'parcelado', 'variavel'].forEach(tipo => {
  const metaInput = document.getElementById(`envelope-${tipo}-meta`);
  const reservaInput = document.getElementById(`envelope-${tipo}-reserva`);
  if (metaInput) {
    metaInput.addEventListener('input', () => metaInput.dataset.userEdited = 'true');
    metaInput.addEventListener('change', e => {
      metaInput.dataset.userEdited = '';
      salvarEnvelope(tipo, { meta: e.target.value });
    });
  }
  if (reservaInput) {
    reservaInput.addEventListener('input', () => reservaInput.dataset.userEdited = 'true');
    reservaInput.addEventListener('change', e => {
      reservaInput.dataset.userEdited = '';
      salvarEnvelope(tipo, { reservado: e.target.value }, 'Reserva ajustada!');
    });
  }
});

const envelopesGrid = document.getElementById('envelopes-grid');
if (envelopesGrid) {
  envelopesGrid.addEventListener('click', e => {
    const btn = e.target.closest('[data-envelope-action]');
    if (!btn) return;
    const tipo = btn.getAttribute('data-envelope');
    const acao = btn.getAttribute('data-envelope-action');
    if (!tipo || !acao) return;
    if (acao === 'reservar') {
      reservarSaldoDisponivel(tipo);
    } else if (acao === 'liberar') {
      limparReservaEnvelope(tipo);
    }
  });
}

const reservarTodosBtn = document.getElementById('btn-envelopes-reservar-todos');
if (reservarTodosBtn) {
  reservarTodosBtn.addEventListener('click', e => {
    e.preventDefault();
    reservarSobrasAutomatico();
  });
}

const limparReservasBtn = document.getElementById('btn-envelopes-limpar-reservas');
if (limparReservasBtn) {
  limparReservasBtn.addEventListener('click', e => {
    e.preventDefault();
    limparReservasAutomatico();
  });
}

const btnEnvelopesOverview = document.getElementById('btn-envelopes-overview');
const modalPlanejamentoEnvelopes = document.getElementById('modal-planejamento-envelopes');
const modalPlanejamentoEnvelopesClose = document.getElementById('modal-planejamento-envelopes-close');
const btnPlanejamentoReservar = document.getElementById('btn-planejamento-reservar');
const btnPlanejamentoInvestir = document.getElementById('btn-planejamento-investir');
const btnPlanejamentoEntrada = document.getElementById('btn-planejamento-entrada');

function abrirModalPlanejamentoEnvelopes() {
  if (!modalPlanejamentoEnvelopes) return;
  atualizarBarrasVisuais();
  modalPlanejamentoEnvelopes.classList.remove('hidden');
  updateFloatingMenuVisibility();
}

function fecharModalPlanejamentoEnvelopes() {
  if (!modalPlanejamentoEnvelopes) return;
  modalPlanejamentoEnvelopes.classList.add('hidden');
  updateFloatingMenuVisibility();
}

btnEnvelopesOverview?.addEventListener('click', abrirModalPlanejamentoEnvelopes);
modalPlanejamentoEnvelopesClose?.addEventListener('click', fecharModalPlanejamentoEnvelopes);

modalPlanejamentoEnvelopes?.addEventListener('click', (event) => {
  if (event.target === modalPlanejamentoEnvelopes) {
    fecharModalPlanejamentoEnvelopes();
  }
});

btnPlanejamentoReservar?.addEventListener('click', () => {
  const margem = window.__ultimoResumoEnvelopes?.totalMargem || 0;
  if (margem <= 0) {
    showToast('N√£o h√° folga dispon√≠vel para reservar agora.', 'info');
    return;
  }
  reservarSobrasAutomatico()
    .then(() => {
      fecharModalPlanejamentoEnvelopes();
      showToast('Folga distribu√≠da automaticamente entre os envelopes.');
    })
    .catch(() => showToast('N√£o foi poss√≠vel reservar automaticamente.', 'error'));
});

btnPlanejamentoInvestir?.addEventListener('click', () => {
  const margem = window.__ultimoResumoEnvelopes?.totalMargem || 0;
  if (margem <= 0) {
    showToast('Nenhuma folga para enviar aos investimentos no momento.', 'info');
    return;
  }
  fecharModalPlanejamentoEnvelopes();
  goToPanelAndFocus('painel-investimentos', '#investimento-valor');
  const inputInvestimento = document.querySelector('#investimento-valor');
  if (inputInvestimento) {
    inputInvestimento.value = margem.toFixed(2);
    inputInvestimento.dispatchEvent(new Event('input', { bubbles: true }));
  }
  showToast(`Preenchemos R$ ${moeda(margem)} no formul√°rio de investimentos para voc√™ confirmar.`, 'info');
});

btnPlanejamentoEntrada?.addEventListener('click', () => {
  const margem = window.__ultimoResumoEnvelopes?.totalMargem || 0;
  if (margem <= 0) {
    showToast('N√£o h√° folga para registrar como entrada extra.', 'info');
    return;
  }
  fecharModalPlanejamentoEnvelopes();
  goToPanelAndFocus('painel-entradas', '#entrada-valor');
  const inputEntrada = document.querySelector('#entrada-valor');
  if (inputEntrada) {
    inputEntrada.value = margem.toFixed(2);
    inputEntrada.dispatchEvent(new Event('input', { bubbles: true }));
  }
  showToast(`Sugest√£o pronta: R$ ${moeda(margem)} j√° est√° preenchido nas entradas para voc√™ salvar.`, 'info');
});

/* ===========================
   FILTRO MESES POPULATION helper (GERAL)
   =========================== */
function atualizarFiltroMeses(){
  const select = document.getElementById('filtro-mes');
  const atual = select.value; 

  select.innerHTML = '<option value="all">Todos</option>';

 const setAllDataMonths = new Set([
   ...(mesesDisponiveis||[]),
   ...(mesesParceladosColetados||[]),
   ...(mesesEntradasDisponiveis||[]),
   ...(mesesInvestimentosDisponiveis||[])
 ]);
  
  Array.from(setAllDataMonths).sort().reverse().forEach(k=>{
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = mmYYYY(k);
    select.appendChild(opt);
  });

  if(atual && Array.from(select.options).some(o=>o.value===atual)) {
      select.value = atual;
  } else {
      select.value = yyyymm(new Date());
  }
}


document.getElementById('filtro-mes').addEventListener('change', ()=>{
  // Ao mudar o filtro de m√™s, reinicia os observers para carregar os dados do novo m√™s
  startObservers(); 
});

/* ===========================
   BARRA DE A√á√ïES INFERIOR
   =========================== */
function initFloatingMenu() {
  const floatingMenu = document.getElementById('floating-menu');
  const btnAddVariavel = document.getElementById('btn-add-gasto-variavel');
  const btnAddFixo = document.getElementById('btn-add-gasto-fixo');
  const btnAddParcelado = document.getElementById('btn-add-gasto-parcelado');
  const btnQuickEntradas = document.getElementById('btn-quick-entradas');
  const quickIncomeMenu = document.getElementById('quick-income-menu');

  if (!floatingMenu) return;

  const closeQuickIncomeMenu = () => {
    if (quickIncomeMenu) quickIncomeMenu.classList.add('hidden');
    if (btnQuickEntradas) btnQuickEntradas.setAttribute('aria-expanded', 'false');
  };

  const openQuickIncomeMenu = () => {
    if (!quickIncomeMenu || !btnQuickEntradas) return;
    quickIncomeMenu.classList.remove('hidden');
    btnQuickEntradas.setAttribute('aria-expanded', 'true');
  };

  if (btnAddVariavel) {
    btnAddVariavel.addEventListener('click', () => {
      abrirModal();
      updateFloatingMenuVisibility();
    });
  }

  if (btnAddFixo) {
    btnAddFixo.addEventListener('click', () => {
      abrirModalFixo();
      updateFloatingMenuVisibility();
    });
  }

  if (btnAddParcelado) {
    btnAddParcelado.addEventListener('click', () => {
      abrirModalParcelado();
      updateFloatingMenuVisibility();
    });
  }

  if (btnQuickEntradas && quickIncomeMenu) {
    btnQuickEntradas.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      const isHidden = quickIncomeMenu.classList.contains('hidden');
      closeQuickIncomeMenu();
      if (isHidden) {
        openQuickIncomeMenu();
      }
    });

    quickIncomeMenu.addEventListener('click', (event) => {
      event.stopPropagation();
    });

    quickIncomeMenu.querySelectorAll('[data-income-action]').forEach(button => {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        const action = button.getAttribute('data-income-action');
        closeQuickIncomeMenu();
        if (action === 'entrada') {
          goToPanelAndFocus('painel-entradas', '#entrada-valor');
        } else if (action === 'investimento') {
          goToPanelAndFocus('painel-investimentos', '#investimento-valor');
        }
      });
    });

    document.addEventListener('click', closeQuickIncomeMenu);
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeQuickIncomeMenu();
      }
    });
  }

  updateFloatingMenuVisibility();
}

/* ===========================
   MODAL DE ADICIONAR GASTOS
   =========================== */
const btnOpenAddGasto = document.getElementById('btn-open-add-gasto');
const modalAddGasto = document.getElementById('modal-add-gasto');
const modalClose = document.getElementById('modal-close');
const modalCancel = document.getElementById('modal-cancel');
const formAddGastoModal = document.getElementById('form-add-gasto-modal');
const modalCartaoSelect = document.getElementById('modal-cartao'); // NOVO
const mesFaturaEstimadoSpan = document.getElementById('mes-fatura-estimado').querySelector('span'); // NOVO

function atualizarMesFaturaEstimado() {
  const cartaoSelecionado = modalCartaoSelect.value;
  const hoje = new Date();
  let mesFaturaDisplay = 'M√™s Atual';

  if (cartaoSelecionado && cartaoSelecionado !== 'pix' && cartaoSelecionado !== '') {
    const configCartao = cartoesCfg[cartaoSelecionado];
    if (configCartao && configCartao.fechamento !== null && configCartao.fechamento !== undefined) {
      const mesFatura = calcularMesFatura(hoje, configCartao.fechamento);
      mesFaturaDisplay = mmYYYY(mesFatura);
    }
  } else if (cartaoSelecionado === 'pix' || cartaoSelecionado === '') {
    mesFaturaDisplay = mmYYYY(yyyymm(hoje));
  }
  mesFaturaEstimadoSpan.textContent = mesFaturaDisplay;
}

modalCartaoSelect.addEventListener('change', atualizarMesFaturaEstimado); // NOVO: Atualiza ao mudar o cart√£o

function abrirModal() {
  modalAddGasto.classList.remove('hidden');
  atualizarMesFaturaEstimado(); // NOVO: Atualiza ao abrir o modal
  setTimeout(() => {
    document.getElementById('modal-cartao').focus();
  }, 100);
}

function fecharModal() {
  modalAddGasto.classList.add('hidden');
  formAddGastoModal.reset();
  document.getElementById('modal-valor').classList.remove('border-red-500');
  document.getElementById('error-modal-valor').classList.add('hidden');
  selectedTagsArray = []; // Limpa tags selecionadas
  renderSelectedTags();
}

btnOpenAddGasto.addEventListener('click', abrirModal);

// REMOVIDO: fecharTodosOsModais() duplicado aqui, j√° existe no topo do script

modalClose.addEventListener('click', fecharModal);
modalCancel.addEventListener('click', fecharModal);

modalAddGasto.addEventListener('click', e => {
  if (e.target === modalAddGasto) fecharModal();
});

formAddGastoModal.addEventListener('submit', e => {
  e.preventDefault();
  const cartaoSelecionado = document.getElementById('modal-cartao').value || '';
  const categoria = document.getElementById('modal-categoria').value || ''; 
  const valorInput = document.getElementById('modal-valor');
  const valor = parseFloat(valorInput.value) || 0;
  const desc = document.getElementById('modal-desc').value || '';
  
  const errorValor = document.getElementById('error-modal-valor');
  valorInput.classList.remove('border-red-500');
  errorValor.classList.add('hidden');

  if (valor <= 0) { 
    valorInput.classList.add('border-red-500');
    errorValor.classList.remove('hidden');
    showToast('Valor √© obrigat√≥rio e deve ser maior que zero.', 'error');
    return;
  }
  
  // NOVO: Calcula mesFatura
  const hoje = new Date();
  let mesFaturaCalculado;
  if (cartaoSelecionado === 'pix' || cartaoSelecionado === '') { // PIX ou Nenhum
    mesFaturaCalculado = yyyymm(hoje); // M√™s atual da transa√ß√£o
  } else {
    const configCartao = cartoesCfg[cartaoSelecionado];
    if (configCartao && configCartao.fechamento !== null && configCartao.fechamento !== undefined) {
      mesFaturaCalculado = calcularMesFatura(hoje, configCartao.fechamento);
    } else {
      mesFaturaCalculado = yyyymm(hoje); // Fallback para m√™s atual se n√£o houver fechamento
    }
  }

  userCollectionRef('gastos').add({
    tipo: 'variavel',
    cartao: cartaoSelecionado,
    categoria,
    valor,
    descricao: desc,
    tags: selectedTagsArray, // NOVO: Adiciona as tags selecionadas
    data: firebase.firestore.Timestamp.now(),
    mesFatura: mesFaturaCalculado, // NOVO CAMPO
    ownerUid: currentUser?.uid || null
  }).then(() => {
    // Limpa tags selecionadas
    selectedTagsArray = [];
    renderSelectedTags();
    fecharModal();
    showToast('Gasto vari√°vel adicionado com sucesso!');
    gerarInsights(); // NOVO: Atualiza insights ap√≥s adicionar gasto
  }).catch(err => {
    showToast('Erro ao adicionar gasto: ' + err.message, 'error');
  });
});

    
// Vari√°veis do modal e formul√°rio
const modalFixo = document.getElementById('modal-fixo');
const formFixo = document.getElementById('form-fixo');
const selectCategoria = document.getElementById('fixo-categoria');
const selectSubcategoria = document.getElementById('fixo-subcategoria');
const btnCancelarFixo = document.getElementById('btn-cancelar-fixo');

const subcategoriasPorCategoria = {
  'Assinaturas': ['Netflix', 'Spotify', 'Amazon Prime', 'Disney+'],
  'Contas': ['Luz', '√Ågua', 'Internet', 'Telefone'],
  'Seguros': ['Carro', 'Casa', 'Vida'],
  'Outros': []
};

// Abrir modal para adicionar fixo
function abrirModalFixo(dados = null) {
  modalFixo.classList.remove('hidden');
  formFixo.reset();
  selectSubcategoria.innerHTML = '<option value="">Selecione uma categoria primeiro</option>';
  selectSubcategoria.disabled = true;

  if (dados) {
    document.getElementById('modal-fixo-title').textContent = 'Editar Gasto Fixo';
    formFixo.nome.value = dados.nome || '';
    formFixo.categoria.value = dados.categoria || '';
    atualizarSubcategorias(dados.categoria);
    formFixo.subcategoria.value = dados.subcategoria || '';
    formFixo.valor.value = dados.valor || '';
    formFixo.ativo.checked = dados.ativo ?? true;
    formFixo.dataset.docId = dados.id; // para edi√ß√£o
  } else {
    document.getElementById('modal-fixo-title').textContent = 'Adicionar Gasto Fixo';
    delete formFixo.dataset.docId;
  }
}

// Atualiza op√ß√µes de subcategoria conforme categoria selecionada
function atualizarSubcategorias(categoria) {
  const subcats = subcategoriasPorCategoria[categoria] || [];
  selectSubcategoria.innerHTML = '';
  if (subcats.length === 0) {
    selectSubcategoria.innerHTML = '<option value="">Sem subcategorias</option>';
    selectSubcategoria.disabled = true;
  } else {
    selectSubcategoria.disabled = false;
    selectSubcategoria.innerHTML = '<option value="">Selecione uma subcategoria</option>';
    subcats.forEach(sub => {
      const option = document.createElement('option');
      option.value = sub;
      option.textContent = sub;
      selectSubcategoria.appendChild(option);
    });
  }
}

selectCategoria.addEventListener('change', e => {
  atualizarSubcategorias(e.target.value);
});

btnCancelarFixo.addEventListener('click', () => {
  modalFixo.classList.add('hidden');
});

// Submiss√£o do formul√°rio para adicionar ou editar fixo
formFixo.addEventListener('submit', e => {
  e.preventDefault();

  const novoFixo = {
    nome: formFixo.nome.value.trim(),
    categoria: formFixo.categoria.value,
    subcategoria: formFixo.subcategoria.value || '',
    valor: parseFloat(formFixo.valor.value),
    ativo: formFixo.ativo.checked
  };

  if (!novoFixo.nome || !novoFixo.categoria || isNaN(novoFixo.valor)) {
    showToast('Por favor, preencha todos os campos obrigat√≥rios corretamente.', 'error');
    return;
  }

  const docId = formFixo.dataset.docId;

  if (docId) {
    // Editar gasto fixo existente
    userCollectionRef('fixos').doc(docId).update(novoFixo)
      .then(() => {
        showToast('Gasto fixo atualizado com sucesso!');
        modalFixo.classList.add('hidden');
        gerarInsights(); // NOVO: Atualiza insights ap√≥s editar fixo
      })
      .catch(() => {
        showToast('Erro ao atualizar gasto fixo.', 'error');
      });
  } else {
    // Adicionar novo gasto fixo
    userCollectionRef('fixos').add({ ...novoFixo, ownerUid: currentUser?.uid || null })
      .then(() => {
        showToast('Gasto fixo adicionado com sucesso!');
        modalFixo.classList.add('hidden');
        gerarInsights(); // NOVO: Atualiza insights ap√≥s adicionar fixo
      })
      .catch(() => {
        showToast('Erro ao adicionar gasto fixo.', 'error');
      });
  }
});

/* ===========================
   PWA & NOTIFICA√á√ïES
   =========================== */
async function solicitarPermissaoNotificacoes() {
  try {
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
      console.log('Permiss√£o concedida para notifica√ß√µes');
      // Substitua 'SUA_VAPID_KEY' pela sua chave VAPID do Firebase
      const token = await messaging.getToken({ vapidKey: 'SUA_VAPID_KEY' }); 
      console.log('Token FCM:', token);
      // Envie o token para seu backend para enviar notifica√ß√µes
    } else {
      console.log('Permiss√£o para notifica√ß√µes negada');
    }
  } catch (error) {
    console.error('Erro ao solicitar permiss√£o:', error);
  }
}

// Registrar service worker APENAS para PWA (sem Firebase por agora)
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(registration => {
      console.log('‚úÖ Service Worker registrado para PWA:', registration.scope);
      // Comentei as partes do Firebase para evitar erros - volte depois se quiser notifica√ß√µes
      // messaging.useServiceWorker(registration);
      // solicitarPermissaoNotificacoes();
    })
    .catch(err => {
      console.error('‚ùå Erro ao registrar Service Worker:', err);
    });
}

/* ===========================
   NOVO: MODAL DE GR√ÅFICOS INTERATIVOS COM FILTROS
   =========================== */
// Vari√°veis globais para os gr√°ficos e filtros
let chartCategorias = null;
let chartCartoes = null;
let chartTendenciaCategorias = null; // NOVO: Vari√°vel para o gr√°fico de tend√™ncia
let chartInvestimentos = null; // NOVO: Gr√°fico de evolu√ß√£o dos investimentos
let chartHistoricoMensal = null; // NOVO: Gr√°fico de resumo mensal do hist√≥rico
let chartParceladosProjecao = null; // NOVO: Proje√ß√£o de parcelados
const modalGraficos = document.getElementById('modal-graficos');
const modalGraficosClose = document.getElementById('modal-graficos-close');
const btnHistoricoGraficos = document.getElementById('btn-historico-graficos');
const filtroCartoesContainer = document.getElementById('filtro-cartoes-container');
const filtroCategoriasContainer = document.getElementById('filtro-categorias-container');
const filtroPeriodoGraficos = document.getElementById('filtro-periodo-graficos'); // NOVO
const filtroPeriodoStart = document.getElementById('filtro-periodo-start');     // NOVO
const filtroPeriodoEnd = document.getElementById('filtro-periodo-end');       // NOVO
const btnAplicarFiltros = document.getElementById('btn-aplicar-filtros');
const btnLimparFiltros = document.getElementById('btn-limpar-filtros');

// Fun√ß√£o para criar checkboxes dinamicamente
function criarCheckboxes(container, items, prefix, checkedAll = true) {
  container.innerHTML = '';
  items.forEach(item => {
    const id = `${prefix}-${item}`;
    const label = document.createElement('label');
    label.className = 'inline-flex items-center gap-1 cursor-pointer select-none text-gray-700 dark:text-gray-300';
    label.innerHTML = `
      <input type="checkbox" id="${id}" value="${item}" ${checkedAll ? 'checked' : ''} class="checkbox-filtro form-checkbox h-4 w-4 text-blue-600 dark:text-blue-400 border-gray-300 dark:border-gray-600 rounded" />
      <span class="text-gray-700 dark:text-gray-300">${item.charAt(0).toUpperCase() + item.slice(1)}</span>
    `;
    container.appendChild(label);
  });
}

// Fun√ß√£o para obter valores dos checkboxes selecionados
function obterSelecionados(prefix) {
  const checkboxes = document.querySelectorAll(`input.checkbox-filtro[id^="${prefix}-"]:checked`);
  return Array.from(checkboxes).map(cb => cb.value);
}

// NOVO: Fun√ß√£o auxiliar para obter o intervalo de datas do filtro de per√≠odo
function getPeriodoDatas() {
  const hoje = new Date();
  const filtroMesEl = document.getElementById('filtro-mes');
  const filtroMesVal = filtroMesEl ? filtroMesEl.value : null;
  const possuiMesSelecionado = filtroMesVal && filtroMesVal !== 'all';
  const baseDate = (() => {
    if (!possuiMesSelecionado) return hoje;
    const [anoSel, mesSel] = filtroMesVal.split('-');
    const ano = parseInt(anoSel, 10);
    const mes = parseInt(mesSel, 10) - 1;
    if (Number.isNaN(ano) || Number.isNaN(mes)) return hoje;
    return new Date(ano, mes, 1);
  })();

  let startDate = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1); // Padr√£o: in√≠cio do m√™s de refer√™ncia
  let endDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + 1, 0); // Padr√£o: fim do m√™s de refer√™ncia

  const periodoSelecionado = filtroPeriodoGraficos?.value || 'current_month';

  if (periodoSelecionado === 'last_3_months') {
    startDate = new Date(baseDate.getFullYear(), baseDate.getMonth() - 2, 1);
    endDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + 1, 0);
  } else if (periodoSelecionado === 'last_6_months') {
    startDate = new Date(baseDate.getFullYear(), baseDate.getMonth() - 5, 1);
    endDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + 1, 0);
  } else if (periodoSelecionado === 'current_year') {
    startDate = new Date(baseDate.getFullYear(), 0, 1);
    endDate = new Date(baseDate.getFullYear(), 11, 31);
  } else if (periodoSelecionado === 'custom') {
    if (filtroPeriodoStart.value) {
      const [y, m] = filtroPeriodoStart.value.split('-');
      const ano = parseInt(y, 10);
      const mes = parseInt(m, 10) - 1;
      if (!Number.isNaN(ano) && !Number.isNaN(mes)) {
        startDate = new Date(ano, mes, 1);
      }
    }
    if (filtroPeriodoEnd.value) {
      const [y, m] = filtroPeriodoEnd.value.split('-');
      const ano = parseInt(y, 10);
      const mes = parseInt(m, 10);
      if (!Number.isNaN(ano) && !Number.isNaN(mes)) {
        endDate = new Date(ano, mes, 0); // √öltimo dia do m√™s informado
      }
    }
  }
  // Para 'current_month', os valores padr√£o baseados em baseDate j√° est√£o corretos

  return { startDate, endDate };
}

// Fun√ß√£o para filtrar gastos por cart√µes e categorias (MODIFICADA)
function filtrarGastosPorFiltros(cartoesSelecionados, categoriasSelecionadas) {
  const { startDate, endDate } = getPeriodoDatas(); // NOVO: Obt√©m o per√≠odo selecionado
  const gastosFiltrados = allGastosDocs.filter(doc => {
    const d = doc.data();
    if (!d.data) return false;
    
    const keyTransacao = yyyymm(d.data.toDate ? d.data.toDate() : new Date(d.data));
    const keyFatura = d.mesFatura || keyTransacao; // Usa mesFatura para filtragem

    // Converte keyFatura para Date para compara√ß√£o com startDate/endDate
    const [faturaAno, faturaMes] = keyFatura.split('-');
    const dataFatura = new Date(parseInt(faturaAno), parseInt(faturaMes) - 1, 1);

    // NOVO: Filtra por per√≠odo usando mesFatura
    if (dataFatura < startDate || dataFatura > endDate) return false;
    
    // Filtra por cart√£o
    if (cartoesSelecionados.length > 0 && !cartoesSelecionados.includes((d.cartao || '').toLowerCase())) return false;
    // Filtra por categoria
    if (categoriasSelecionadas.length > 0 && !categoriasSelecionadas.includes((d.categoria || '').toLowerCase())) return false;
    return true;
  });
  return gastosFiltrados;
}

// Fun√ß√£o para calcular totais por categoria e cart√£o a partir dos gastos filtrados (MODIFICADA)
function calcularTotais(gastos) {
  const totaisPorCategoria = {};
  const totaisPorCartao = {};
  const totaisPorCategoriaMes = {}; // NOVO: Para o gr√°fico de tend√™ncia
  const totaisPorMes = {};

  gastos.forEach(doc => {
    const d = doc.data();
    if (!d.valor) return;

    // Categoria
    if (d.categoria) {
      const cat = d.categoria.toLowerCase();
      totaisPorCategoria[cat] = (totaisPorCategoria[cat] || 0) + d.valor;

      // NOVO: Para o gr√°fico de tend√™ncia
      const mesAno = d.mesFatura || yyyymm(d.data.toDate ? d.data.toDate() : new Date(d.data)); // Usa mesFatura
      if (!totaisPorCategoriaMes[mesAno]) {
        totaisPorCategoriaMes[mesAno] = {};
      }
      totaisPorCategoriaMes[mesAno][cat] = (totaisPorCategoriaMes[mesAno][cat] || 0) + d.valor;
    }

    // Cart√£o
    if (d.cartao) {
      const cartao = d.cartao.toLowerCase();
      totaisPorCartao[cartao] = (totaisPorCartao[cartao] || 0) + d.valor;
    }

    const mesReferencia = d.mesFatura || yyyymm(d.data.toDate ? d.data.toDate() : new Date(d.data));
    totaisPorMes[mesReferencia] = (totaisPorMes[mesReferencia] || 0) + d.valor;
  });

  return { totaisPorCategoria, totaisPorCartao, totaisPorCategoriaMes, totaisPorMes }; // NOVO: Retorna totais adicionais
}


// Fun√ß√£o para renderizar gr√°fico de pizza por categoria
function renderGraficoCategorias(totaisPorCategoria) {
  const labels = [];
  const data = [];

  for (const cat in totaisPorCategoria) {
    labels.push(cat.charAt(0).toUpperCase() + cat.slice(1));
    data.push(totaisPorCategoria[cat]);
  }

  const ctx = document.getElementById('grafico-categorias').getContext('2d');
  if (chartCategorias) chartCategorias.destroy();
  chartCategorias = new Chart(ctx, {
    type: 'pie',
    data: {
      labels,
      datasets: [{
        label: 'Gastos por Categoria',
        data,
        backgroundColor: [
          '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'
        ],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { 
          position: 'bottom',
          labels: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151' // Cor da legenda
          }
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const label = ctx.label || '';
              const value = ctx.parsed || 0;
              const total = ctx.dataset.data.reduce((a,b) => a+b, 0);
              const pct = total ? ((value / total) * 100).toFixed(2) : 0;
              return `${label}: R$ ${moeda(value)} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

// Fun√ß√£o para renderizar gr√°fico de barras por cart√£o
function renderGraficoCartoes(totaisPorCartao) {
  const labels = [];
  const data = [];

  for (const cartao in totaisPorCartao) {
    labels.push(cartao.charAt(0).toUpperCase() + cartao.slice(1));
    data.push(totaisPorCartao[cartao]);
  }

  const ctx = document.getElementById('grafico-cartoes').getContext('2d');
  if (chartCartoes) chartCartoes.destroy(); // CORRIGIDO: Agora destr√≥i chartCartoes
  chartCartoes = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Gastos por Cart√£o',
        data,
        backgroundColor: '#3b82f6',
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => `R$ ${moeda(val)}`,
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151' // Cor dos ticks
          },
          grid: {
            color: html.classList.contains('dark') ? '#4b5563' : '#e5e7eb' // Cor da grid
          }
        },
        x: {
          ticks: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151' // Cor dos ticks
          },
          grid: {
            color: html.classList.contains('dark') ? '#4b5563' : '#e5e7eb' // Cor da grid
          }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `R$ ${moeda(ctx.parsed.y)}`
          }
        }
      }
    }
  });
}

function renderGraficoHistoricoMensal(totaisPorMes = {}) {
  const canvas = document.getElementById('grafico-historico-mensal');
  if (!canvas) return;
  const emptyState = document.getElementById('historico-mensal-empty');
  const ctx = canvas.getContext('2d');

  if (chartHistoricoMensal) {
    chartHistoricoMensal.destroy();
    chartHistoricoMensal = null;
  }

  const mesesOrdenados = Object.keys(totaisPorMes || {}).sort();
  if (!mesesOrdenados.length) {
    if (emptyState) emptyState.classList.remove('hidden');
    if (ctx) ctx.clearRect(0, 0, canvas.width || 0, canvas.height || 0);
    return;
  }

  if (emptyState) emptyState.classList.add('hidden');

  const limiteMeses = HISTORICO_MENSAL_CHART_CFG.monthsWindow || 0;
  const mesesRecentes = limiteMeses > 0 ? mesesOrdenados.slice(-limiteMeses) : mesesOrdenados;
  const labels = mesesRecentes.map(mmYYYY);
  const valores = mesesRecentes.map(mes => totaisPorMes[mes]);

  const acumulado = [];
  let soma = 0;
  valores.forEach(valor => {
    soma += valor;
    acumulado.push(soma);
  });

  const mediaMovel = valores.map((valor, indice) => {
    const janela = Math.min(indice + 1, 3);
    const start = Math.max(0, indice - janela + 1);
    const slice = valores.slice(start, indice + 1);
    const totalJanela = slice.reduce((acc, curr) => acc + curr, 0);
    return slice.length ? totalJanela / slice.length : valor;
  });

  const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height || 200);
  const [corTopo, corBase] = HISTORICO_MENSAL_CHART_CFG.barColorStops || ['rgba(56, 189, 248, 0.65)', 'rgba(14, 165, 233, 0.25)'];
  gradient.addColorStop(0, corTopo);
  gradient.addColorStop(1, corBase || corTopo);

  const acumuladoColor = HISTORICO_MENSAL_CHART_CFG.acumuladoColor || '#6366f1';
  const mediaColor = HISTORICO_MENSAL_CHART_CFG.mediaColor || '#f97316';
  const barBorderColor = HISTORICO_MENSAL_CHART_CFG.barBorderColor || '#0ea5e9';

  chartHistoricoMensal = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          type: 'bar',
          label: 'Total do m√™s',
          data: valores,
          backgroundColor: gradient,
          borderColor: barBorderColor,
          borderWidth: 1.5,
          borderRadius: 6,
          order: 2,
          yAxisID: 'y'
        },
        {
          type: 'line',
          label: 'Acumulado',
          data: acumulado,
          borderColor: acumuladoColor,
          backgroundColor: 'transparent',
          borderWidth: 2,
          tension: 0.35,
          pointRadius: 3,
          pointBackgroundColor: acumuladoColor,
          fill: false,
          yAxisID: 'y'
        },
        {
          type: 'line',
          label: 'M√©dia m√≥vel (3 meses)',
          data: mediaMovel,
          borderColor: mediaColor,
          backgroundColor: 'transparent',
          borderDash: [6, 4],
          borderWidth: 2,
          pointRadius: 0,
          pointHitRadius: 8,
          tension: 0.3,
          yAxisID: 'y'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => `R$ ${moeda(val)}`,
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937'
          },
          grid: {
            color: html.classList.contains('dark') ? '#374151' : '#e5e7eb'
          }
        },
        x: {
          ticks: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937'
          },
          grid: {
            display: false
          }
        }
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937'
          }
        },
        tooltip: {
          backgroundColor: html.classList.contains('dark') ? 'rgba(30, 41, 59, 0.9)' : 'rgba(15, 23, 42, 0.9)',
          borderColor: barBorderColor,
          borderWidth: 1,
          callbacks: {
            title: tooltipItems => tooltipItems[0]?.label || '',
            label: context => {
              const label = context.dataset.label || '';
              const value = context.parsed.y;
              return `${label}: R$ ${moeda(value)}`;
            },
            afterBody: tooltipItems => {
              if (!tooltipItems.length) return '';
              const index = tooltipItems[0].dataIndex;
              if (index === 0) return 'M√™s inicial do per√≠odo';
              const diff = valores[index] - valores[index - 1];
              const prev = valores[index - 1];
              const pct = prev ? (diff / prev) * 100 : 0;
              const sinal = diff >= 0 ? '+' : '-';
              const textoValor = `Varia√ß√£o: ${sinal}R$ ${moeda(Math.abs(diff))}`;
              const textoPct = prev ? ` (${pct >= 0 ? '+' : '-'}${Math.abs(pct).toFixed(1)}%)` : '';
              return textoValor + textoPct;
            }
          }
        }
      }
    }
  });
}

function renderGraficoParceladosProjecao(docs = [], refDate = new Date()) {
  const canvas = document.getElementById('grafico-parcelados-projecao');
  const emptyState = document.getElementById('parcelados-projecao-empty');
  const janelaEl = document.getElementById('parcelados-projecao-janela');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');

  if (chartParceladosProjecao) {
    chartParceladosProjecao.destroy();
    chartParceladosProjecao = null;
  }

  const mesesJanela = Math.max(1, PARCELADOS_PROJECAO_CHART_CFG.monthsWindow || 6);
  if (janelaEl) {
    janelaEl.textContent = mesesJanela === 1 ? 'Pr√≥ximo m√™s' : `Pr√≥ximos ${mesesJanela} meses`;
  }

  const totaisPorMes = {};
  const baseRef = new Date(refDate.getFullYear(), refDate.getMonth(), 1);

  docs.forEach(doc => {
    const dados = doc.data ? doc.data() : doc;
    if (!dados) return;
    const valorParcela = Number(dados.valorParcela) || 0;
    const totalParcelas = parseInt(dados.numParcelas, 10) || 0;
    if (!valorParcela || totalParcelas <= 0) return;
    const inicio = dados.dataInicio && dados.dataInicio.toDate ? dados.dataInicio.toDate() : new Date(dados.dataInicio);
    if (!(inicio instanceof Date) || Number.isNaN(inicio.getTime())) return;

    for (let i = 0; i < totalParcelas; i++) {
      const mesParcela = addMonths(inicio, i);
      const key = yyyymm(mesParcela);
      totaisPorMes[key] = (totaisPorMes[key] || 0) + valorParcela;
    }
  });

  const labels = [];
  const valores = [];
  for (let i = 0; i < mesesJanela; i++) {
    const dataMes = addMonths(baseRef, i);
    const chave = yyyymm(dataMes);
    labels.push(mmYYYY(chave));
    valores.push(totaisPorMes[chave] || 0);
  }

  const possuiValores = valores.some(v => v > 0);
  if (!possuiValores) {
    if (emptyState) {
      emptyState.textContent = docs && docs.length
        ? 'Nenhuma parcela prevista para o per√≠odo selecionado.'
        : 'Cadastre parcelados ativos para visualizar a proje√ß√£o.';
      emptyState.classList.remove('hidden');
    }
    if (ctx) {
      ctx.clearRect(0, 0, canvas.width || 0, canvas.height || 0);
    }
    return;
  }

  if (emptyState) emptyState.classList.add('hidden');

  const barColor = PARCELADOS_PROJECAO_CHART_CFG.barColor
    || (html.classList.contains('dark') ? 'rgba(167, 139, 250, 0.6)' : 'rgba(129, 140, 248, 0.55)');
  const borderColor = PARCELADOS_PROJECAO_CHART_CFG.borderColor || '#7c3aed';

  chartParceladosProjecao = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Valor mensal projetado',
        data: valores,
        backgroundColor: barColor,
        borderColor,
        borderWidth: 1.5,
        borderRadius: 6,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => `R$ ${moeda(val)}`,
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937',
          },
          grid: {
            color: html.classList.contains('dark') ? '#374151' : '#e5e7eb',
          },
        },
        x: {
          ticks: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#1f2937',
          },
          grid: {
            display: false,
          },
        },
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctxTooltip => `R$ ${moeda(ctxTooltip.parsed.y)}`,
          },
        },
      },
    },
  });
}

// MELHORADO: Fun√ß√£o para renderizar gr√°fico de tend√™ncia por categoria com controles avan√ßados
function renderGraficoTendenciaCategorias(totaisPorCategoriaMes) {
  const ctx = document.getElementById('grafico-tendencia-categorias').getContext('2d');
  if (chartTendenciaCategorias) chartTendenciaCategorias.destroy();

  // Se n√£o h√° dados, renderiza gr√°fico vazio
  if (!totaisPorCategoriaMes || Object.keys(totaisPorCategoriaMes).length === 0) {
    chartTendenciaCategorias = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Sem dados'],
        datasets: []
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        }
      }
    });
    
    // Limpa estat√≠sticas
    document.getElementById('tendencia-total').textContent = 'R$ 0,00';
    document.getElementById('tendencia-maior-mes').textContent = '-';
    document.getElementById('tendencia-menor-mes').textContent = '-';
    document.getElementById('tendencia-media').textContent = 'R$ 0,00';
    return;
  }

  // Organiza os dados por m√™s
  const mesesOrdenados = Object.keys(totaisPorCategoriaMes).sort();
  const todasCategorias = new Set();
  
  // Coleta todas as categorias √∫nicas
  Object.values(totaisPorCategoriaMes).forEach(mesData => {
    Object.keys(mesData).forEach(cat => todasCategorias.add(cat));
  });

  // Calcula estat√≠sticas para exibir
  const totaisPorMes = mesesOrdenados.map(mes => 
    Object.values(totaisPorCategoriaMes[mes] || {}).reduce((sum, val) => sum + val, 0)
  );
  
  const totalPeriodo = totaisPorMes.reduce((sum, val) => sum + val, 0);
  const maiorMes = Math.max(...totaisPorMes);
  const menorMes = Math.min(...totaisPorMes);
  const mediaMensal = totaisPorMes.length > 0 ? totalPeriodo / totaisPorMes.length : 0;
  
  const indiceMaiorMes = totaisPorMes.indexOf(maiorMes);
  const indiceMenorMes = totaisPorMes.indexOf(menorMes);
  
  // Atualiza estat√≠sticas na interface
  document.getElementById('tendencia-total').textContent = `R$ ${moeda(totalPeriodo)}`;
  document.getElementById('tendencia-maior-mes').textContent = `${mmYYYY(mesesOrdenados[indiceMaiorMes])} (R$ ${moeda(maiorMes)})`;
  document.getElementById('tendencia-menor-mes').textContent = `${mmYYYY(mesesOrdenados[indiceMenorMes])} (R$ ${moeda(menorMes)})`;
  document.getElementById('tendencia-media').textContent = `R$ ${moeda(mediaMensal)}`;

  // Obt√©m tipo de gr√°fico selecionado
  const tipoGrafico = document.getElementById('tendencia-tipo-grafico').value;

  const datasets = Array.from(todasCategorias).map((categoria, index) => {
    const cores = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];
    const cor = cores[index % cores.length];
    
    const dataset = {
      label: categoria.charAt(0).toUpperCase() + categoria.slice(1),
      data: mesesOrdenados.map(mes => totaisPorCategoriaMes[mes][categoria] || 0),
      borderColor: cor,
      backgroundColor: tipoGrafico === 'area' ? cor + '40' : cor + '20',
      borderWidth: 2,
      pointRadius: 4,
      pointHoverRadius: 6,
      tension: tipoGrafico === 'line' ? 0.4 : 0
    };

    if (tipoGrafico === 'area') {
      dataset.fill = true;
    }

    return dataset;
  });

  chartTendenciaCategorias = new Chart(ctx, {
    type: tipoGrafico === 'area' ? 'line' : tipoGrafico,
    data: {
      labels: mesesOrdenados.map(mes => mmYYYY(mes)),
      datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      scales: {
        x: {
          grid: {
            display: true,
            color: html.classList.contains('dark') ? '#4b5563' : '#f3f4f6'
          },
          ticks: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151'
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            display: true,
            color: html.classList.contains('dark') ? '#4b5563' : '#f3f4f6'
          },
          ticks: {
            callback: val => `R$ ${moeda(val)}`,
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151'
          }
        }
      },
      plugins: {
        legend: { 
          position: 'bottom',
          labels: {
            color: html.classList.contains('dark') ? '#d1d5db' : '#374151',
            onClick: (e, legendItem) => {
              const index = legendItem.datasetIndex;
              const chart = chartTendenciaCategorias;
              const meta = chart.getDatasetMeta(index);
              meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
              chart.update();
            }
          }
        },
        tooltip: {
          backgroundColor: html.classList.contains('dark') ? 'rgba(55,65,81,0.9)' : 'rgba(0,0,0,0.8)',
          titleColor: html.classList.contains('dark') ? '#f9fafb' : 'white',
          bodyColor: html.classList.contains('dark') ? '#f9fafb' : 'white',
          borderColor: '#3b82f6',
          borderWidth: 1,
          callbacks: {
            title: (tooltipItems) => {
              return `${tooltipItems[0].label}`;
            },
            label: ctx => `${ctx.dataset.label}: R$ ${moeda(ctx.parsed.y)}`,
            footer: (tooltipItems) => {
              const total = tooltipItems.reduce((sum, item) => sum + item.parsed.y, 0);
              return `Total do m√™s: R$ ${moeda(total)}`;
            }
          }
        }
      }
    }
  });
}

// NOVO: Event listeners para controles do gr√°fico de tend√™ncia
document.getElementById('tendencia-tipo-grafico').addEventListener('change', () => {
  aplicarFiltros(); // Re-renderiza o gr√°fico com o novo tipo
});

document.getElementById('btn-toggle-todas-categorias').addEventListener('click', () => {
  if (!chartTendenciaCategorias) return;
  
  const chart = chartTendenciaCategorias;
  const allHidden = chart.data.datasets.every(dataset => {
    const meta = chart.getDatasetMeta(chart.data.datasets.indexOf(dataset));
    return meta.hidden === true;
  });
  
  // Se todas est√£o ocultas, mostra todas. Caso contr√°rio, oculta todas.
  chart.data.datasets.forEach((dataset, index) => {
    const meta = chart.getDatasetMeta(index);
    meta.hidden = !allHidden;
  });
  
  chart.update();
  
  const btn = document.getElementById('btn-toggle-todas-categorias');
  btn.textContent = allHidden ? 'Ocultar Todas' : 'Mostrar Todas';
});

// Fun√ß√£o para aplicar filtros e atualizar gr√°ficos (MODIFICADA)
function aplicarFiltros() {
  const cartoesSelecionados = obterSelecionados('filtro-cartoes').map(c => c.toLowerCase());
  const categoriasSelecionadas = obterSelecionados('filtro-categorias').map(c => c.toLowerCase());

  const gastosFiltrados = allGastosDocs.filter(doc => {
    const d = doc.data();
    if (!d.data) return false;
    
    const keyTransacao = yyyymm(d.data.toDate ? d.data.toDate() : new Date(d.data));
    const keyFatura = d.mesFatura || keyTransacao; // Usa mesFatura para filtragem

    const { startDate, endDate } = getPeriodoDatas();
    // Converte keyFatura para Date para compara√ß√£o com startDate/endDate
    const [faturaAno, faturaMes] = keyFatura.split('-');
    const dataFatura = new Date(parseInt(faturaAno), parseInt(faturaMes) - 1, 1);

    if (dataFatura < startDate || dataFatura > endDate) return false;
    if (cartoesSelecionados.length > 0 && !cartoesSelecionados.includes((d.cartao || '').toLowerCase())) return false;
    if (categoriasSelecionadas.length > 0 && !categoriasSelecionadas.includes((d.categoria || '').toLowerCase())) return false;
    return true;
  });

  const { totaisPorCategoria, totaisPorCartao, totaisPorCategoriaMes, totaisPorMes } = calcularTotais(gastosFiltrados); // NOVO: Pega totais adicionais

  renderGraficoCategorias(totaisPorCategoria);
  renderGraficoCartoes(totaisPorCartao);
  renderGraficoTendenciaCategorias(totaisPorCategoriaMes); // NOVO: Renderiza o gr√°fico de tend√™ncia
  renderGraficoHistoricoMensal(totaisPorMes);

  // NOVO: Atualiza o resumo de totais no modal
  const totalFiltrado = gastosFiltrados.reduce((sum, doc) => sum + (doc.data().valor || 0), 0);
  document.getElementById('graficos-total-filtrado').textContent = `R$ ${moeda(totalFiltrado)}`;

  const { startDate, endDate } = getPeriodoDatas();
  // Calcula a diferen√ßa em meses de forma mais precisa para a m√©dia
  const diffYears = endDate.getFullYear() - startDate.getFullYear();
  const diffMonths = endDate.getMonth() - startDate.getMonth();
  const numMeses = diffYears * 12 + diffMonths + 1; // +1 para incluir o m√™s final

  const mediaMensal = numMeses > 0 ? totalFiltrado / numMeses : 0;
  document.getElementById('graficos-media-mensal').textContent = `R$ ${moeda(mediaMensal)}`;

  const totalTransacoes = gastosFiltrados.length;
  const totalTransacoesEl = document.getElementById('graficos-total-transacoes');
  if (totalTransacoesEl) totalTransacoesEl.textContent = String(totalTransacoes);

  const ticketMedio = totalTransacoes > 0 ? totalFiltrado / totalTransacoes : 0;
  const ticketMedioEl = document.getElementById('graficos-ticket-medio');
  if (ticketMedioEl) ticketMedioEl.textContent = `R$ ${moeda(ticketMedio)}`;

  const topCategoriaEntry = Object.entries(totaisPorCategoria).sort(([,a],[,b]) => b - a)[0];
  const topCategoriaEl = document.getElementById('graficos-top-categoria');
  if (topCategoriaEl) {
    topCategoriaEl.textContent = topCategoriaEntry
      ? `${capitalize(topCategoriaEntry[0])} ‚Äî R$ ${moeda(topCategoriaEntry[1])}`
      : 'Nenhuma categoria filtrada.';
  }

  const topCartaoEntry = Object.entries(totaisPorCartao).sort(([,a],[,b]) => b - a)[0];
  const topCartaoEl = document.getElementById('graficos-top-cartao');
  if (topCartaoEl) {
    topCartaoEl.textContent = topCartaoEntry
      ? `${cartoesCfg[topCartaoEntry[0]]?.label || capitalize(topCartaoEntry[0])} ‚Äî R$ ${moeda(topCartaoEntry[1])}`
      : 'Nenhum cart√£o filtrado.';
  }
}

// Fun√ß√£o para limpar filtros (marca todos)
function limparFiltros() {
  document.querySelectorAll('#filtro-cartoes-container input[type=checkbox]').forEach(cb => cb.checked = true);
  document.querySelectorAll('#filtro-categorias-container input[type=checkbox]').forEach(cb => cb.checked = true);
  filtroPeriodoGraficos.value = 'current_month'; // NOVO: Reseta o filtro de per√≠odo
  filtroPeriodoStart.classList.add('hidden');    // NOVO
  filtroPeriodoEnd.classList.add('hidden');      // NOVO
  aplicarFiltros();
}

function abrirModalGraficos() {
  if (!modalGraficos) return;
  modalGraficos.classList.remove('hidden');
  updateFloatingMenuVisibility();

  const cartoesUnicos = Array.from(new Set((allGastosDocs || []).map(doc => (doc.data().cartao || '').toLowerCase()).filter(c => c)));
  const categoriasUnicas = Array.from(new Set((allGastosDocs || []).map(doc => (doc.data().categoria || '').toLowerCase()).filter(c => c)));

  if (filtroCartoesContainer) {
    criarCheckboxes(filtroCartoesContainer, cartoesUnicos, 'filtro-cartoes', true);
  }
  if (filtroCategoriasContainer) {
    criarCheckboxes(filtroCategoriasContainer, categoriasUnicas, 'filtro-categorias', true);
  }

  if (filtroPeriodoGraficos) filtroPeriodoGraficos.value = 'current_month';
  if (filtroPeriodoStart) filtroPeriodoStart.classList.add('hidden');
  if (filtroPeriodoEnd) filtroPeriodoEnd.classList.add('hidden');

  aplicarFiltros();
}

// Inicializa filtros e gr√°ficos ao abrir modal (MODIFICADA)
btnHistoricoGraficos?.addEventListener('click', abrirModalGraficos);

modalGraficosClose.addEventListener('click', () => {
  modalGraficos.classList.add('hidden');
  updateFloatingMenuVisibility();
  if (chartCategorias) {
    chartCategorias.destroy();
    chartCategorias = null;
  }
  if (chartCartoes) {
    chartCartoes.destroy();
    chartCartoes = null;
  }
  if (chartTendenciaCategorias) { // NOVO: Destr√≥i o gr√°fico de tend√™ncia
    chartTendenciaCategorias.destroy();
    chartTendenciaCategorias = null;
  }
  if (chartHistoricoMensal) {
    chartHistoricoMensal.destroy();
    chartHistoricoMensal = null;
  }
});

btnAplicarFiltros.addEventListener('click', aplicarFiltros);
btnLimparFiltros.addEventListener('click', limparFiltros);

// NOVO: Event listener para o filtro de per√≠odo
filtroPeriodoGraficos.addEventListener('change', () => {
  if (filtroPeriodoGraficos.value === 'custom') {
    filtroPeriodoStart.classList.remove('hidden');
    filtroPeriodoEnd.classList.remove('hidden');
    // Define valores padr√£o para o m√™s atual se estiver vazio
    const hoje = new Date();
    if (!filtroPeriodoStart.value) filtroPeriodoStart.value = yyyymm(hoje);
    if (!filtroPeriodoEnd.value) filtroPeriodoEnd.value = yyyymm(hoje);
  } else {
    filtroPeriodoStart.classList.add('hidden');
    filtroPeriodoEnd.classList.add('hidden');
  }
  aplicarFiltros(); // Aplica filtros imediatamente ap√≥s mudar o per√≠odo
});

// NOVO: Event listeners para os inputs de data personalizados
filtroPeriodoStart.addEventListener('change', aplicarFiltros);
filtroPeriodoEnd.addEventListener('change', aplicarFiltros);


/* ===========================
   BOOTSTRAP: start observers and initial load
   =========================== */
function boot(){
  carregarEnvelopes();
  // initial empty UI
  atualizarBarrasVisuais();
  // start observing everything
  startObservers();
  // üî• For√ßa o filtro de m√™s para o m√™s atual
  const filtroMes = document.getElementById('filtro-mes');
  const mesAtual = yyyymm(new Date());
  filtroMes.value = mesAtual;
  // NOVO: Popula os selects de cart√£o na inicializa√ß√£o
  popularSelectCartoes(); 
  
  // NOVO: Inicializa sistemas de melhorias
  initTagsSystem();
  initHistoricoSearch();
  initHistoricoCollapsible(); // Inicializa a funcionalidade de colapsar/expandir
  initHistoricoActions();     // Inicializa os bot√µes de a√ß√£o
  initFloatingMenu(); // NOVO: Inicializa o menu flutuante
}


/* ===========================
   INSIGHTS INTELIGENTES
   =========================== */
function gerarInsights() {
  const container = document.getElementById('insights-container');
  container.innerHTML = '';
  
  const insights = [];
  const hoje = new Date();

  // Insight: Categoria que mais consome (do m√™s atual)
  if (window._totaisPorCategoriaAtual && Object.keys(window._totaisPorCategoriaAtual).length > 0) {
    const categoriaMax = Object.entries(window._totaisPorCategoriaAtual)
      .sort(([,a], [,b]) => b - a)[0];
    if (categoriaMax) {
      insights.push({
        icon: 'üìä',
        title: 'Categoria Dominante (M√™s)',
        description: `${categoriaMax[0].charAt(0).toUpperCase() + categoriaMax[0].slice(1)} √© sua maior categoria de gastos com R$ ${moeda(categoriaMax[1])} este m√™s.`,
        type: 'info'
      });
    }
  }
  
  // Insight: Alerta: Or√ßamento Estourado!
  const totalGasto = (resumo.historicoMes || 0) + (resumo.parcelasMes || 0) + (resumo.fixosMes || 0);
  const totalLimite = ['fixo', 'parcelado', 'variavel'].reduce((acc, tipo) => acc + getEnvelopeMeta(tipo), 0);
  const reservasTotais = ['fixo', 'parcelado', 'variavel'].reduce((acc, tipo) => acc + (Number(envelopes[tipo]?.reservado || 0)), 0);
  const economia = totalLimite - (totalGasto + reservasTotais);
  if (economia < 0) {
    insights.push({
      icon: 'üö®',
      title: 'Alerta: Limite mensal estourado!',
      description: `Gastos e reservas ultrapassaram o or√ßamento em R$ ${moeda(Math.abs(economia))} este m√™s.`,
      type: 'error'
    });
  }

  if (economia > 0) {
    insights.push({
      icon: '‚úÖ',
      title: 'Limites ainda com folga',
      description: `H√° R$ ${moeda(economia)} livres dentro dos limites definidos. Considere destinar essa folga para reservas futuras ou investimentos.`,
      type: 'success'
    });
  }

  // Insight: Maior Parcelamento
  if (allParceladosDocs && allParceladosDocs.length > 0) {
    let maiorParcelado = { nome: '', valor: 0 };

    allParceladosDocs.forEach(doc => {
      const p = doc.data();
      if (p.valorParcela > maiorParcelado.valor) {
        maiorParcelado = { nome: p.descricao, valor: p.valorParcela };
      }
    });
    
    if (maiorParcelado.valor > 0) {
      insights.push({
        icon: 'üí∏',
        title: 'Maior Parcelamento',
        description: `Seu maior parcelamento √© "${maiorParcelado.nome}" com R$ ${moeda(maiorParcelado.valor)} por m√™s.`,
        type: 'info'
      });
    }
  }

  // Insight: Aten√ß√£o: Gastos Fixos Elevados
  const metaFixo = getEnvelopeMeta('fixo');
  const fixoPercent = metaFixo ? ((resumo.fixosMes || 0) / metaFixo * 100) : 0;
  if (metaFixo && fixoPercent > 80) {
    insights.push({
      icon: '‚ö†Ô∏è',
      title: 'Aten√ß√£o: Gastos Fixos Elevados',
      description: `Seus gastos fixos est√£o em ${fixoPercent.toFixed(1)}% do limite. Considere revisar assinaturas n√£o utilizadas.`,
      type: 'warning'
    });
  }

  const resumoAtual = resumoFinanceiroAtual || {};
  const saldoProjetado = resumoAtual.saldoProjetado || 0;
  const entradasMes = resumoAtual.entradasMes || painelFinanceiroState.entradasMes || 0;
  const investimentosMes = painelFinanceiroState.investimentosMes || 0;
  const investimentosTotais = painelFinanceiroState.investimentosTotais || 0;

  ['fixo', 'parcelado', 'variavel'].forEach(tipo => {
    const meta = getEnvelopeMeta(tipo);
    if (!meta) return;
    const gastoAtual = getEnvelopeGastoAtual(tipo);
    const reservado = Number(envelopes[tipo]?.reservado || 0);
    const comprometido = gastoAtual + reservado;
    const limiteLivre = Math.max(0, meta - comprometido);
    const excedente = comprometido > meta ? comprometido - meta : 0;
    const tituloEnvelope = envelopeConfig[tipo]?.titulo || tipo;

    if (limiteLivre > 0 && saldoProjetado > 0) {
      insights.push({
        icon: 'üéØ',
        title: `Reserve no envelope de ${tituloEnvelope.toLowerCase()}`,
        description: `H√° R$ ${moeda(limiteLivre)} ainda livres neste limite. Converta em reserva ou redirecione para objetivos futuros diretamente pelos envelopes.`,
        type: 'success'
      });
    }

    if (excedente > 0) {
      insights.push({
        icon: '‚ö†Ô∏è',
        title: `${tituloEnvelope} estourou o limite`,
        description: `Gastos e reservas somam R$ ${moeda(comprometido)}, superando o limite em R$ ${moeda(excedente)}. Reavalie despesas ou ajuste o teto para o pr√≥ximo m√™s.`,
        type: 'warning'
      });
    } else if (limiteLivre > 0 && hoje.getDate() > 20) {
      insights.push({
        icon: '‚è≥',
        title: `Folga restante em ${tituloEnvelope.toLowerCase()}`,
        description: `Restam R$ ${moeda(limiteLivre)} de margem nos √∫ltimos dias do m√™s. Planeje se vale reservar essa folga ou ajustar o limite estabelecido.`,
        type: 'info'
      });
    }

    if (reservado > 0 && reservado >= meta * 0.1) {
      insights.push({
        icon: 'üíº',
        title: `Reserva garantida em ${tituloEnvelope.toLowerCase()}`,
        description: `Voc√™ j√° separou R$ ${moeda(reservado)} para os pr√≥ximos meses. Considere planejar como aplicar√° essa reserva para antecipar objetivos.`,
        type: 'info'
      });
    }
  });

  if (entradasMes > 0) {
    const percentualInvestido = (investimentosMes / entradasMes) * 100;
    if (investimentosMes <= 0 && saldoProjetado > 0) {
      insights.push({
        icon: 'üöÄ',
        title: 'Direcione parte do saldo para investir',
        description: 'Voc√™ possui saldo projetado positivo. Avalie destinar uma parcela para investimentos recorrentes e acelerar suas metas.',
        type: 'info'
      });
    } else if (percentualInvestido < 10 && investimentosMes > 0) {
      insights.push({
        icon: 'üìà',
        title: 'Aumente seus aportes mensais',
        description: `Atualmente apenas ${percentualInvestido.toFixed(1)}% das suas entradas viraram investimentos. Ajuste os aportes para chegar em pelo menos 10%.`,
        type: 'warning'
      });
    } else if (percentualInvestido >= 20) {
      insights.push({
        icon: 'ü•á',
        title: 'Excelente ritmo de investimentos',
        description: `Voc√™ est√° investindo ${percentualInvestido.toFixed(1)}% das entradas deste m√™s. Mantenha a consist√™ncia para acelerar seus objetivos.`,
        type: 'success'
      });
    }
  }

  if (investimentosTotais > 0 && saldoProjetado > investimentosTotais * 0.05) {
    insights.push({
      icon: 'üîÅ',
      title: 'Reforce sua carteira com a reserva dispon√≠vel',
      description: `O saldo projetado pode aumentar sua carteira em at√© R$ ${moeda(Math.min(saldoProjetado, investimentosTotais * 0.2))}. Considere um aporte extra pelo simulador para ver o impacto.`,
      type: 'info'
    });
  }
  
  // Renderiza insights
  if (insights.length === 0) {
    container.innerHTML = '<div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-gray-500 dark:text-gray-400 text-sm">Aguardando dados para gerar insights...</div>';
    return;
  }
  
  const maxVisiveis = MAX_INSIGHTS_VISIBLE;
  const criarCardInsight = (insight) => {
    const div = document.createElement('div');
    div.className = `p-3 rounded-lg border-l-4 ${
      insight.type === 'success' ? 'bg-green-50 dark:bg-green-900/20 border-green-500' :
      insight.type === 'warning' ? 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-500' :
      insight.type === 'error' ? 'bg-red-50 dark:bg-red-900/20 border-red-500' :
      'bg-blue-50 dark:bg-blue-900/20 border-blue-500'
    }`;
    div.innerHTML = `
      <div class="flex items-start gap-2">
        <span class="text-lg">${insight.icon}</span>
        <div class="flex-1">
          <h4 class="font-semibold text-sm ${
            insight.type === 'success' ? 'text-green-800 dark:text-green-200' :
            insight.type === 'warning' ? 'text-yellow-800 dark:text-yellow-200' :
            insight.type === 'error' ? 'text-red-800 dark:text-red-300' :
            'text-blue-800 dark:text-blue-200'
          }">${insight.title}</h4>
          <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${insight.description}</p>
        </div>
      </div>
    `;
    return div;
  };

  insights.slice(0, maxVisiveis).forEach(insight => {
    container.appendChild(criarCardInsight(insight));
  });

  const extras = insights.slice(maxVisiveis);
  if (extras.length > 0) {
    const extrasWrapper = document.createElement('div');
    extrasWrapper.className = 'space-y-3 hidden mt-3';
    extrasWrapper.dataset.insightsExtra = 'true';
    extras.forEach(insight => {
      extrasWrapper.appendChild(criarCardInsight(insight));
    });

    const toggleBtn = document.createElement('button');
    toggleBtn.type = 'button';
    toggleBtn.className = 'text-xs font-semibold text-indigo-600 dark:text-indigo-300 hover:underline flex items-center gap-2 mt-3';
    toggleBtn.setAttribute('aria-expanded', 'false');
    const labelSpan = document.createElement('span');
    labelSpan.textContent = INSIGHTS_TOGGLE_LABELS.showMore;
    const icon = document.createElement('i');
    icon.className = 'fa fa-chevron-down text-[0.7rem]';
    toggleBtn.append(labelSpan, icon);
    toggleBtn.addEventListener('click', () => {
      const estavaOculto = extrasWrapper.classList.contains('hidden');
      extrasWrapper.classList.toggle('hidden');
      const expanded = estavaOculto;
      toggleBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      labelSpan.textContent = expanded ? INSIGHTS_TOGGLE_LABELS.showLess : INSIGHTS_TOGGLE_LABELS.showMore;
      icon.className = expanded ? 'fa fa-chevron-up text-[0.7rem]' : 'fa fa-chevron-down text-[0.7rem]';
    });

    container.appendChild(extrasWrapper);
    container.appendChild(toggleBtn);
  }
}



/* ===========================
   CONTROLE DE VISIBILIDADE DO MENU DE A√á√ïES
   =========================== */
window.addEventListener('scroll', () => {
  const floatingMenu = document.getElementById('floating-menu');
  if (!floatingMenu) return;

  const st = window.pageYOffset || document.documentElement.scrollTop;
  const quickIncomeMenu = document.getElementById('quick-income-menu');
  const quickIncomeButton = document.getElementById('btn-quick-entradas');
  if (quickIncomeMenu) quickIncomeMenu.classList.add('hidden');
  if (quickIncomeButton) quickIncomeButton.setAttribute('aria-expanded', 'false');
  const isModalOpen = !document.getElementById('modal-add-gasto').classList.contains('hidden') ||
                     !document.getElementById('modal-graficos').classList.contains('hidden') ||
                     !document.getElementById('modal-fixo').classList.contains('hidden') ||
                     !document.getElementById('modal-parcelado').classList.contains('hidden') ||
                     !document.getElementById('modal-graficos-fixos').classList.contains('hidden') ||
                     !document.getElementById('modal-planejamento-envelopes').classList.contains('hidden') ||
                     !document.getElementById('modal-confirmacao').classList.contains('hidden') ||
                     !document.getElementById('modal-gerenciar-cartoes').classList.contains('hidden');

  if (isModalOpen) {
    floatingMenu.classList.add('invisible');
    floatingMenu.style.display = 'none';
    return;
  }

  floatingMenu.classList.remove('invisible');
  floatingMenu.style.display = 'flex';

  if (st > lastScrollTop && st > 120) {
    floatingMenu.style.transform = 'translateY(110%)';
    floatingMenu.style.opacity = '0';
  } else {
    floatingMenu.style.transform = 'translateY(0)';
    floatingMenu.style.opacity = '1';
  }

  lastScrollTop = st <= 0 ? 0 : st;
});

// Fun√ß√£o para esconder/mostrar menu quando modals abrem/fecham
function updateFloatingMenuVisibility() {
  const floatingMenu = document.getElementById('floating-menu');
  if (!floatingMenu) return;

  const quickIncomeMenu = document.getElementById('quick-income-menu');
  const quickIncomeButton = document.getElementById('btn-quick-entradas');
  if (quickIncomeMenu) quickIncomeMenu.classList.add('hidden');
  if (quickIncomeButton) quickIncomeButton.setAttribute('aria-expanded', 'false');

    const isModalOpen = !document.getElementById('modal-add-gasto').classList.contains('hidden') ||
                       !document.getElementById('modal-graficos').classList.contains('hidden') ||
                       !document.getElementById('modal-fixo').classList.contains('hidden') ||
                       !document.getElementById('modal-parcelado').classList.contains('hidden') ||
                       !document.getElementById('modal-graficos-fixos').classList.contains('hidden') ||
                       !document.getElementById('modal-planejamento-envelopes').classList.contains('hidden') ||
                       !document.getElementById('modal-confirmacao').classList.contains('hidden') ||
                       !document.getElementById('modal-gerenciar-cartoes').classList.contains('hidden');

  if (isModalOpen) {
    floatingMenu.classList.add('invisible');
    floatingMenu.style.display = 'none';
    floatingMenu.style.opacity = '0';
  } else {
    floatingMenu.classList.remove('invisible');
    floatingMenu.style.display = 'flex';
    floatingMenu.style.transform = 'translateY(0)';
    floatingMenu.style.opacity = '1';
  }
}

    /* ===========================
       NOVO: BUSCA E AGRUPAMENTO NO HIST√ìRICO
       =========================== */
    // Mantido como estava, mas a fun√ß√£o renderHistoricoWithFilters ser√° atualizada
    function initHistoricoSearch() {
      const searchInput = document.getElementById('search-historico');
      const groupBySelect = document.getElementById('group-by-historico');
      const clearButton = document.getElementById('clear-search');

      searchInput.addEventListener('input', (e) => {
        currentSearchTerm = e.target.value.toLowerCase().trim();
        renderHistoricoWithFilters();
      });

      groupBySelect.addEventListener('change', (e) => {
        currentGroupBy = e.target.value;
        renderHistoricoWithFilters();
      });

      clearButton.addEventListener('click', () => {
        searchInput.value = '';
        groupBySelect.value = '';
        currentSearchTerm = '';
        currentGroupBy = '';
        renderHistoricoWithFilters();
      });
    }

    // Vari√°vel para armazenar o estado de colapso dos grupos
    let collapsedGroups = JSON.parse(localStorage.getItem('historicoCollapsedGroups')) || {};

    /* ===========================
       NOVO: FUN√á√ïES PARA COLAPSAR/EXPANDIR GRUPOS NO HIST√ìRICO
       =========================== */
    function initHistoricoCollapsible() {
      document.getElementById('transactions-list').addEventListener('click', (e) => {
        const header = e.target.closest('.group-header');
        if (header) {
          const groupKey = header.dataset.groupKey;
          toggleGroupVisibility(groupKey);
        }
      });
    }

    function toggleGroupVisibility(groupKey) {
      const items = document.querySelectorAll(`.group-item[data-group-key="${groupKey}"]`);
      const headerIcon = document.querySelector(`.group-header[data-group-key="${groupKey}"] .group-toggle-icon`);

      if (!items.length || !headerIcon) return;

      const isCollapsed = items[0].classList.contains('hidden');

      items.forEach(item => {
        if (isCollapsed) {
          item.classList.remove('hidden');
        } else {
          item.classList.add('hidden');
        }
      });

      if (isCollapsed) {
        headerIcon.classList.remove('fa-chevron-right');
        headerIcon.classList.add('fa-chevron-down');
        collapsedGroups[groupKey] = false;
      } else {
        headerIcon.classList.remove('fa-chevron-down');
        headerIcon.classList.add('fa-chevron-right');
        collapsedGroups[groupKey] = true;
      }
      localStorage.setItem('historicoCollapsedGroups', JSON.stringify(collapsedGroups));
    }

    /* ===========================
       NOVO: FUN√á√ïES PARA A√á√ïES DE EDITAR/REMOVER NO HIST√ìRICO
       =========================== */
    function initHistoricoActions() {
      document.getElementById('transactions-list').addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-gasto');
        const deleteBtn = e.target.closest('.delete-gasto');

        if (editBtn) {
          const id = editBtn.dataset.id;
          editarGastoModal(id);
        } else if (deleteBtn) {
          const id = deleteBtn.dataset.id;
          removerGasto(id);
        }
      });
    }

    /* ===========================
       FUN√á√ÉO PARA REMOVER GASTO DO HIST√ìRICO
       =========================== */
    function removerGasto(id) {
      abrirModalConfirmacao(
        'Excluir Gasto',
        'Deseja realmente excluir este gasto? Esta a√ß√£o √© irrevers√≠vel.',
        () => { // Callback de confirma√ß√£o
          userCollectionRef('gastos').doc(id).delete()
            .then(() => {
              showToast('Gasto removido com sucesso!', 'success');
              // Re-renderiza o hist√≥rico para refletir a mudan√ßa
              renderHistoricoWithFilters();
              // Opcional: Atualiza outros resumos se necess√°rio
              gerarInsights();
            })
            .catch(err => {
              showToast('Erro ao remover gasto: ' + err.message, 'error');
            });
        }
      );
    }
    

    function editarGastoModal(id) {
      const gastoDoc = allGastosDocs.find(doc => doc.id === id);
      if (!gastoDoc) {
        showToast('Gasto n√£o encontrado para edi√ß√£o.', 'error');
        return;
      }
      const d = gastoDoc.data();

      // Preencher o modal de adicionar gasto com os dados do gasto a ser editado
      document.getElementById('modal-add-gasto').classList.remove('hidden');
      document.getElementById('modal-add-gasto').dataset.editId = id; // Armazena o ID para saber que √© edi√ß√£o
      document.getElementById('modal-add-gasto').querySelector('h2').textContent = 'Editar Gasto Vari√°vel';

      document.getElementById('modal-cartao').value = d.cartao || '';
      document.getElementById('modal-categoria').value = d.categoria || '';
      document.getElementById('modal-valor').value = d.valor || '';
      document.getElementById('modal-desc').value = d.descricao || '';

      // Preencher tags
      selectedTagsArray = d.tags || [];
      renderSelectedTags();

      // Atualizar m√™s de fatura estimado
      atualizarMesFaturaEstimado();

      // Mudar o texto do bot√£o de submiss√£o
      document.querySelector('#form-add-gasto-modal button[type="submit"]').textContent = 'Salvar Altera√ß√µes';

      // Remover o listener antigo do form e adicionar um novo para edi√ß√£o
      formAddGastoModal.removeEventListener('submit', handleAddGastoSubmit);
      formAddGastoModal.addEventListener('submit', handleEditGastoSubmit);
    }

    // Fun√ß√£o auxiliar para lidar com a submiss√£o de adi√ß√£o (original)
    function handleAddGastoSubmit(e) {
      e.preventDefault();
      const cartaoSelecionado = document.getElementById('modal-cartao').value || '';
      const categoria = document.getElementById('modal-categoria').value || '';
      const valorInput = document.getElementById('modal-valor');
      const valor = parseFloat(valorInput.value) || 0;
      const desc = document.getElementById('modal-desc').value || '';

      const errorValor = document.getElementById('error-modal-valor');
      valorInput.classList.remove('border-red-500');
      errorValor.classList.add('hidden');

      if (valor <= 0) {
        valorInput.classList.add('border-red-500');
        errorValor.classList.remove('hidden');
        showToast('Valor √© obrigat√≥rio e deve ser maior que zero.', 'error');
        return;
      }

      const hoje = new Date();
      let mesFaturaCalculado;
      if (cartaoSelecionado === 'pix' || cartaoSelecionado === '') {
        mesFaturaCalculado = yyyymm(hoje);
      } else {
        const configCartao = cartoesCfg[cartaoSelecionado];
        if (configCartao && configCartao.fechamento !== null && configCartao.fechamento !== undefined) {
          mesFaturaCalculado = calcularMesFatura(hoje, configCartao.fechamento);
        } else {
          mesFaturaCalculado = yyyymm(hoje);
        }
      }

      userCollectionRef('gastos').add({
        tipo: 'variavel',
        cartao: cartaoSelecionado,
        categoria,
        valor,
        descricao: desc,
        tags: selectedTagsArray,
        data: firebase.firestore.Timestamp.now(),
        mesFatura: mesFaturaCalculado,
        ownerUid: currentUser?.uid || null
      }).then(() => {
        selectedTagsArray = [];
        renderSelectedTags();
        fecharModal();
        showToast('Gasto vari√°vel adicionado com sucesso!');
        gerarInsights();
      }).catch(err => {
        showToast('Erro ao adicionar gasto: ' + err.message, 'error');
      });
    }

    // Fun√ß√£o auxiliar para lidar com a submiss√£o de edi√ß√£o
    function handleEditGastoSubmit(e) {
      e.preventDefault();
      const id = document.getElementById('modal-add-gasto').dataset.editId;
      if (!id) {
        showToast('Erro: ID do gasto n√£o encontrado para edi√ß√£o.', 'error');
        return;
      }

      const cartaoSelecionado = document.getElementById('modal-cartao').value || '';
      const categoria = document.getElementById('modal-categoria').value || '';
      const valorInput = document.getElementById('modal-valor');
      const valor = parseFloat(valorInput.value) || 0;
      const desc = document.getElementById('modal-desc').value || '';

      const errorValor = document.getElementById('error-modal-valor');
      valorInput.classList.remove('border-red-500');
      errorValor.classList.add('hidden');

      if (valor <= 0) {
        valorInput.classList.add('border-red-500');
        errorValor.classList.remove('hidden');
        showToast('Valor √© obrigat√≥rio e deve ser maior que zero.', 'error');
        return;
      }

      // Recalcular mesFatura para o caso de o cart√£o ter sido alterado
     const hoje = new Date();
let mesFaturaCalculado;
if (cartaoSelecionado === 'pix' || cartaoSelecionado === '') {
  mesFaturaCalculado = yyyymm(hoje);  // PIX: sempre atual
} else {
  const configCartao = cartoesCfg[cartaoSelecionado];
  const fechamento = configCartao ? configCartao.fechamento : null;
  const offset = configCartao ? (configCartao.mesVencimentoOffset || 0) : 0;  // <-- NOVO: Pega o offset
  if (fechamento !== null && fechamento !== undefined) {
    mesFaturaCalculado = calcularMesFatura(hoje, fechamento, offset);  // <-- NOVO: Passa offset
  } else {
    mesFaturaCalculado = yyyymm(hoje);  // Fallback
  }
}

      userCollectionRef('gastos').doc(id).update({
        cartao: cartaoSelecionado,
        categoria,
        valor,
        descricao: desc,
        tags: selectedTagsArray,
        mesFatura: mesFaturaCalculado
      }).then(() => {
        selectedTagsArray = [];
        renderSelectedTags();
        fecharModal();
        showToast('Gasto atualizado com sucesso!');
        gerarInsights();
      }).catch(err => {
        showToast('Erro ao atualizar gasto: ' + err.message, 'error');
      }).finally(() => {
        // Resetar o formul√°rio e o bot√£o para o estado de "adicionar"
        document.getElementById('modal-add-gasto').querySelector('h2').textContent = 'Adicionar Gasto Vari√°vel';
        document.querySelector('#form-add-gasto-modal button[type="submit"]').textContent = 'Adicionar';
        delete document.getElementById('modal-add-gasto').dataset.editId;
        formAddGastoModal.removeEventListener('submit', handleEditGastoSubmit);
        formAddGastoModal.addEventListener('submit', handleAddGastoSubmit);
      });
    }

    

    /* ===========================
       ATUALIZA√á√ÉO DA FUN√á√ÉO renderHistoricoWithFilters
       =========================== */
    // Esta fun√ß√£o j√° foi atualizada acima, mas a deixamos aqui para refer√™ncia
    // function renderHistoricoWithFilters() { ... }

    function renderHistoricoGroupedByCartao(docs) {
      const tbody = document.getElementById('transactions-list');
      const groups = {};

      docs.forEach(doc => {
        const d = doc.data();
        const cartaoKey = d.cartao || 'sem_cartao';
        if (!groups[cartaoKey]) {
          groups[cartaoKey] = [];
        }
        groups[cartaoKey].push(doc);
      });

      Object.keys(groups).sort().forEach(cartaoKey => {
        const cartaoLabel = (cartoesCfg[cartaoKey] && cartoesCfg[cartaoKey].label) || cartaoKey.replace('_', ' ').toUpperCase();
        const totalGroup = groups[cartaoKey].reduce((sum, doc) => sum + (doc.data().valor || 0), 0);
        const isCollapsed = collapsedGroups[cartaoKey] || false;
        const iconClass = isCollapsed ? 'fa-chevron-right' : 'fa-chevron-down';

        const groupHeader = document.createElement('tr');
        groupHeader.className = 'group-header cursor-pointer bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors';
        groupHeader.dataset.groupKey = cartaoKey;
        groupHeader.setAttribute('role', 'button');
        groupHeader.setAttribute('tabindex', '0');
        groupHeader.setAttribute('aria-expanded', !isCollapsed);
        groupHeader.innerHTML = `
          <td colspan="8" class="td font-semibold text-gray-800 dark:text-gray-100">
            <i class="fa ${iconClass} mr-2 group-toggle-icon"></i>
            ${cartaoLabel} ‚Äî Total: R$ ${moeda(totalGroup)}
          </td>
        `;
        tbody.appendChild(groupHeader);

        groups[cartaoKey].forEach(doc => {
          const d = doc.data();
          const id = doc.id;
          const dt = d.data.toDate ? d.data.toDate() : new Date(d.data);
          const mesFaturaDisplay = d.mesFatura ? mmYYYY(d.mesFatura) : '-';

          const tagsHtml = (d.tags || []).map(tag =>
            `<span class="tag-pill" style="font-size: 0.6rem; padding: 0.125rem 0.25rem;">${tag}</span>`
          ).join('');

          let descricao = d.descricao || '';
          if (currentSearchTerm) {
            const regex = new RegExp(`(${currentSearchTerm})`, 'gi');
            descricao = descricao.replace(regex, '<span class="search-highlight">$1</span>');
          }

          const tr = document.createElement('tr');
          tr.className = `group-item ${isCollapsed ? 'hidden' : ''}`;
          tr.dataset.groupKey = cartaoKey;
           tr.innerHTML = `
            <td class="td">${(cartoesCfg[d.cartao] && cartoesCfg[d.cartao].label) || d.cartao || ''}</td>
            <td class="td">${descricao}</td>
            <td class="td">R$ ${moeda(d.valor)}</td>
            <td class="td">${dt.toLocaleDateString('pt-BR')}</td>
            <td class="td">${mesFaturaDisplay}</td>
            <td class="td">${d.tipo}</td>
            <td class="td">
        <div class="flex flex-wrap gap-1">${tagsHtml}</div>
      </td>
      <td class="td">
        <button class="text-blue-600 dark:text-blue-400 edit-gasto mr-2 hover:text-blue-800 dark:hover:text-blue-200" data-id="${id}" aria-label="Editar gasto">
          <i class="fa fa-edit"></i>
        </button>
        <button class="text-red-600 dark:text-red-400 delete-gasto hover:text-red-800 dark:hover:text-red-200" data-id="${id}" aria-label="Remover gasto">
          <i class="fa fa-trash"></i>
        </button>
      </td>
    `;
    
          tbody.appendChild(tr);
        });
      });
    }

/* ===========================
   MODAL DE PARCELADOS
   =========================== */
// Vari√°veis do modal de parcelado
const modalParcelado = document.getElementById('modal-parcelado');
const formParcelado = document.getElementById('form-parcelado');
const btnCancelarParcelado = document.getElementById('btn-cancelar-parcelado');
// Abrir modal para adicionar/editar parcelado
function abrirModalParcelado(dados = null) { // Adicionado = null para default
  modalParcelado.classList.remove('hidden');
  formParcelado.reset(); // Sempre reseta o formul√°rio ao abrir
  if (dados) {
    document.getElementById('modal-parcelado-title').textContent = 'Editar Parcelado';
    formParcelado.descricao.value = dados.descricao || '';
    formParcelado.valorParcela.value = dados.valorParcela || '';
    formParcelado.numParcelas.value = dados.numParcelas || '';
    formParcelado.cartao.value = dados.cartao || '';
    // Formatar data para input month (YYYY-MM)
    if (dados.dataInicio) {
      const data = dados.dataInicio;
      const year = data.getFullYear();
      const month = String(data.getMonth() + 1).padStart(2, '0');
      formParcelado.dataInicio.value = `${year}-${month}`;
    }
    formParcelado.dataset.docId = dados.id; // para edi√ß√£o
    // Mudar o texto do bot√£o de submiss√£o para "Salvar"
    formParcelado.querySelector('button[type="submit"]').textContent = 'Salvar';
  } else {
    document.getElementById('modal-parcelado-title').textContent = 'Adicionar Parcelado'; // T√≠tulo para adicionar
    delete formParcelado.dataset.docId; // Garante que n√£o h√° ID de edi√ß√£o
    // Mudar o texto do bot√£o de submiss√£o para "Adicionar"
    formParcelado.querySelector('button[type="submit"]').textContent = 'Adicionar';
  }
}
btnCancelarParcelado.addEventListener('click', () => {
  modalParcelado.classList.add('hidden');
});
// Submiss√£o do formul√°rio para adicionar ou editar parcelado
formParcelado.addEventListener('submit', e => {
  e.preventDefault();
  const parceladoData = { // Renomeado para evitar conflito com parceladoAtualizado
    descricao: formParcelado.descricao.value.trim(),
    valorParcela: parseFloat(formParcelado.valorParcela.value),
    numParcelas: parseInt(formParcelado.numParcelas.value),
    cartao: formParcelado.cartao.value || '',
  };
  // Converte a data de volta para Date object
  if (formParcelado.dataInicio.value) {
    const [year, month] = formParcelado.dataInicio.value.split('-');
    parceladoData.dataInicio = new Date(parseInt(year), parseInt(month) - 1, 1);
  }
  if (!parceladoData.descricao || isNaN(parceladoData.valorParcela) || isNaN(parceladoData.numParcelas) || parceladoData.valorParcela <= 0 || parceladoData.numParcelas < 1) {
    showToast('Por favor, preencha todos os campos obrigat√≥rios corretamente.', 'error');
    return;
  }
  const docId = formParcelado.dataset.docId;
  if (docId) {
    // Editar parcelado existente
    userCollectionRef('parcelados').doc(docId).update(parceladoData)
      .then(() => {
        showToast('Parcelado atualizado com sucesso!');
        modalParcelado.classList.add('hidden');
        gerarInsights(); // NOVO: Atualiza insights ap√≥s editar parcelado
      })
      .catch(() => {
        showToast('Erro ao atualizar parcelado.', 'error');
      });
  } else {
    // Adicionar novo parcelado
    userCollectionRef('parcelados').add({ ...parceladoData, ownerUid: currentUser?.uid || null }) // Usa parceladoData para adicionar
      .then(() => {
        showToast('Parcelado adicionado com sucesso!');
        modalParcelado.classList.add('hidden');
        gerarInsights(); // NOVO: Atualiza insights ap√≥s adicionar parcelado
      })
      .catch(() => {
        showToast('Erro ao adicionar parcelado.', 'error');
      });
  }
});


// NOVO: Atalhos de teclado
document.addEventListener('keydown', (e) => {
  // Ctrl/Cmd + N = Novo gasto
  if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
    e.preventDefault();
    abrirModal();
    showToast('Atalho: Ctrl+N para novo gasto', 'info');
  }
  
  // Ctrl/Cmd + F = Novo fixo
  if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
    e.preventDefault();
    abrirModalFixo();
    showToast('Atalho: Ctrl+F para novo fixo', 'info');
  }
  
  // Ctrl/Cmd + G = Abrir gr√°ficos
  if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
    e.preventDefault();
    if (window.innerWidth > 768) {
      document.getElementById('modal-graficos').classList.remove('hidden');
      showToast('Atalho: Ctrl+G para gr√°ficos', 'info');
    }
  }
  
// ESC = Fechar modals
if (e.key === 'Escape') {
  document.getElementById('modal-add-gasto').classList.add('hidden');
  document.getElementById('modal-fixo').classList.add('hidden');
  document.getElementById('modal-parcelado').classList.add('hidden');
  document.getElementById('modal-graficos').classList.add('hidden');
  document.getElementById('modal-graficos-fixos').classList.add('hidden');
  document.getElementById('modal-planejamento-envelopes').classList.add('hidden');
  document.getElementById('modal-confirmacao').classList.add('hidden');
  document.getElementById('modal-gerenciar-cartoes').classList.add('hidden');
  updateFloatingMenuVisibility();
}

});

/* start */
initResumoSlider();
initMobilePanels();
initSimuladorInvestimentos();
atualizarResumoRapido();
initAuthFlow();

</script>
